---
title: "Ericaceae floral evolution"
graphics: yes
date: '`r Sys.Date()`'
output:
  pdf_document:
    toc: yes
    toc_depth: 4
    fig_crop: false
keep_tex: yes
---

 
```{r setup, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)
library(readxl)
library(ggplot2)
library(ape)
library(phytools)
library(scales)
library(calibrate)
library(plyr)
library(ade4)
library(l1ou)
library(gridExtra)
library(BioGeoBEARS)
library(geiger)
library(dplyr)
library(PhylogeneticEM)               
library(Momocs)
library(corHMM)  
library(stringr)
library(nlme)
library(broom)
library(ggpubr)
library(gridExtra)
library(strap)
library(cowplot)   
library(sf)
library(coin)
library(rcompanion)
library(rr2)
library(psych)
library(kableExtra)
library(ggbeeswarm)
options(scipen = 999)
```

\pagebreak
 
# Morphometrics
## Corolla

```{r, label="read_in_linear_measurements", cache=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
### We read in the measurement data
measurements <- data.frame(read_excel("spreadsheets/ericaceae_floral_measurements.xls"), stringsAsFactors = FALSE)

# remove outgroups and 
measurements <- measurements[!(measurements$genus=="Cyrilla" ),]
measurements <- measurements[!(measurements$genus=="Clethra" ),]

# Keep only relevent characters
data_reduced <- measurements[, c("species","corolla_tube_length")]

# Get anther measurments
measurements$total_large_anther_length <- measurements$large_thecae_length + measurements$large_anther_tubule_length
measurements_anthers <- measurements[, c("species","total_large_anther_length")]

```

```{r, label="Corolla_import", echo=FALSE, cache=TRUE, message=FALSE, warning=FALSE,results='hide'}
# List and import outlines
# jpg.list_corollas <- list.files(path = "outlines/corolla_ready",pattern = c( ".jpg"))
# returns_flowers <- import_jpg(jpg.paths = paste0("outlines/corolla_ready", "/", jpg.list_corollas),auto.notcentered = T) 
#returns_flowers_1301_1372 <- Out(returns_flowers_1301_1372) 
#returns_flowers_1301_1372 <- def_ldk(returns_flowers_1301_1372,3)
#saveRDS(flowers,"outlines/outlines_landmarked/ericaceae_corollas_1372_3ldks.rds")
flowers <- readRDS("outlines/outlines_landmarked/ericaceae_corollas_1390_3ldks.rds")

#flowers_df <- data.frame(flowers$fac)

# Import groups
groups_flowers <- read.csv("spreadsheets/groups_corollas.csv")
groups_flowers <- data.frame(groups_flowers[,1:5])

#t <- unique(groups_flowers[c("species", "continent")])
#u <- table(t$species) %>% data.frame()

# Import pollinators

pollinators <- read.csv("spreadsheets/pollinator_data_jan2020.csv", na.strings = c(""," "))
pollinators <- pollinators[c(1:3)]

pollinators <- pollinators[!duplicated(pollinators$species),]
pollinators$pollinator_referenced <- as.character(pollinators$pollinator_referenced)
pollinators$pollinator_referenced[is.na(pollinators$pollinator_referenced)] <- "unknown"
pollinators$pollinator_general <- pollinators$pollinator_referenced

# make column with general pollinator coding

pollinators$pollinator_referenced <- gsub("unknown|intermediate","-",pollinators$pollinator_referenced)
pollinators$pollinator_referenced <- gsub("passerine","honeyeater",pollinators$pollinator_referenced)
pollinators$pollinator_referenced <- gsub("spinebill","honeyeater",pollinators$pollinator_referenced)
pollinators$pollinator_referenced <- gsub("moth","lepidoptera",pollinators$pollinator_referenced)
pollinators$pollinator_referenced <- gsub("butterfly","lepidoptera",pollinators$pollinator_referenced)

# make a column with bird united and insects separate

pollinators$pollinators_bird_sep <- pollinators$pollinator_general
pollinators$pollinators_bird_sep <- gsub("unknown|intermediate","-",pollinators$pollinators_bird_sep)
pollinators$pollinators_bird_sep <- gsub("passerine","honeyeater",pollinators$pollinators_bird_sep)
pollinators$pollinators_bird_sep <- gsub("spinebill","honeyeater",pollinators$pollinators_bird_sep)
pollinators$pollinators_bird_sep <- gsub("mammal","-",pollinators$pollinators_bird_sep)
pollinators$pollinators_bird_sep <- gsub("long_proboscid_fly|moth|butterfly|wind","insect",pollinators$pollinators_bird_sep)

#
pollinators$pollinator_general <- gsub("honeyeater","bird",pollinators$pollinator_general)
pollinators$pollinator_general <- gsub("hummingbird_OW","bird",pollinators$pollinator_general)
pollinators$pollinator_general <- gsub("hummingbird","bird",pollinators$pollinator_general)
pollinators$pollinator_general <- gsub("passerine","bird",pollinators$pollinator_general)
pollinators$pollinator_general <- gsub("spinebill","bird",pollinators$pollinator_general)
pollinators$pollinator_general <- gsub("sunbird","bird",pollinators$pollinator_general)
pollinators$pollinator_general <- gsub("mammal","unknown",pollinators$pollinator_general)
pollinators$pollinator_general <- gsub("intermediate","unknown",pollinators$pollinator_general)
pollinators$pollinator_general <- gsub("moth","insect",pollinators$pollinator_general)
pollinators$pollinator_general <- gsub("butterfly","insect",pollinators$pollinator_general)
pollinators$pollinator_general <- gsub("long_proboscid_fly","insect",pollinators$pollinator_general)
pollinators$pollinator_general <- gsub("wind","insect",pollinators$pollinator_general)

# Make factor these grouping vars

pollinators$pollinator_referenced <- as.factor(pollinators$pollinator_referenced)
pollinators$pollinator_general <- as.factor(pollinators$pollinator_general)
pollinators$pollinators_bird_sep <- as.factor(pollinators$pollinators_bird_sep)

# Add pollinator data to groups

groups_flowers <- left_join(groups_flowers, pollinators, "species")

# Make more groups

groups_flowers$pollinator_by_landmass <- paste0(groups_flowers$pollinator_general,"_",groups_flowers$land_mass)
groups_flowers$pollinator_by_continent <- paste0(groups_flowers$pollinator_general,"_",groups_flowers$continent)
groups_flowers$pollinator_by_subfamily <- paste0(groups_flowers$pollinator_general,"_",groups_flowers$subfamily)

# Make factor these grouping vars
groups_flowers$pollinator_by_landmass <- as.factor(groups_flowers$pollinator_by_landmass)
groups_flowers$pollinator_by_continent <- as.factor(groups_flowers$pollinator_by_continent)
groups_flowers$pollinator_by_subfamily <- as.factor(groups_flowers$pollinator_by_subfamily)

# Clean some synonym after passing by tnrs
groups_flowers$species <- gsub("Arctostaphylos_alpina","Arctous_alpina", groups_flowers$species)
groups_flowers$species <- gsub("Blaeria_coccinia","Erica_longimontana", groups_flowers$species)
groups_flowers$species <- gsub("Blaeria_dumosa","Erica_equisetifolia", groups_flowers$species)
groups_flowers$species <- gsub("Comarostaphylis_macvaughii","Comarostaphylis_discolor", groups_flowers$species)
groups_flowers$species <- gsub("Erica_decora","Erica_viscaria", groups_flowers$species)
groups_flowers$species <- gsub("Erica_fervida","Erica_pillansii", groups_flowers$species)
groups_flowers$species <- gsub("Erica_fourcadei","Erica_glandulosa", groups_flowers$species)
groups_flowers$species <- gsub("Erica_lineata","Erica_plukenetii", groups_flowers$species)
groups_flowers$species <- gsub("Erica_mediterranea","Erica_herbacea", groups_flowers$species)
groups_flowers$species <- gsub("Erica_ruwenzoriensis","Erica_kingaensis", groups_flowers$species)
groups_flowers$species <- gsub("Kalmia_aggregata","Kalmia_ericoides", groups_flowers$species)
groups_flowers$species <- gsub("Rhododendron_fimbriatum","Rhododendron_hippophaeoides", groups_flowers$species)
groups_flowers$species <- gsub("Rhododendron_radicans","Rhododendron_keleticum", groups_flowers$species)
groups_flowers$species <- gsub("Rhododendron_rhabdotum","Rhododendron_dalhousieae", groups_flowers$species)
groups_flowers$species <- gsub("Rhododendron_supranubium","Rhododendron_pachypodum", groups_flowers$species)
groups_flowers$species <- gsub("Rhododendron_tamaense","Rhododendron_cinnabarinum", groups_flowers$species)

# Assign groups

groups_flowers$continent <- as.factor(groups_flowers$continent)
flowers$fac <- groups_flowers

###
flowers_no_ldks <- flowers

###
coo_slide(flowers, ldk=2) -> flowers
fgProcrustes(flowers) -> flowers

table(flowers$fac$pollinator_referenced)
flowers$fac$pollinator_referenced <- droplevels(flowers$fac$pollinator_referenced)
```

```{r, label="elliptic_Fourier_analysis_corolla", echo=FALSE, cache=TRUE, message=FALSE, warning=FALSE}
#calibrate_harmonicpower_efourier(flowers)
efou_flowers <- efourier(flowers, norm=F, nb.h=32, smooth.it=1) 
efou_flowers_mean <- MSHAPES(efou_flowers, 'species') 
pca_efou_flowers <- PCA(efou_flowers_mean$Coe) 
spp_corollas <-pca_efou_flowers$fac$species %>% unique()
efou_flowers_no_ldks <- efourier(flowers_no_ldks, norm=F, nb.h=32, smooth.it=1) 
pca_efou_flowers_no_ldks <- PCA(efou_flowers_no_ldks) 
```

```{r, label="Panel_corollas", fig.height=3, fig.width=3, fig.align='center', echo=FALSE, cache=TRUE, message=FALSE, warning=FALSE}
panel(flowers, col=0, border=1)
```

Sample sizes

```{r, label="Count_corollas", fig.height=3, fig.width=3, fig.align='center', echo=FALSE, cache=TRUE, message=FALSE, warning=FALSE}
sample_size_contintent <- table(flowers$fac$continent) %>% t() %>% data.frame()
sample_size_contintent <- sample_size_contintent[2:3]
kable(sample_size_contintent)
sample_size_pollinator_referenced <- table(flowers$fac$pollinator_referenced) %>% t() %>% data.frame()
sample_size_pollinator_referenced <- sample_size_pollinator_referenced[2:3]
kable(sample_size_pollinator_referenced)
```

```{r,label="PC_contrib_corolla", fig.height=2, fig.width=3, fig.align='center',echo=FALSE, cache=TRUE, message=FALSE, warning=FALSE,eval=T}
#PCcontrib(pca_efou_flowers, nax = c(1:2),sd.r = c(-1.5, -0.5, 0, 0.5, 1.5))
gg <- PCcontrib(pca_efou_flowers, nax=1:2, sd.r=c(-1.5, -0.5, 0, 0.5, 1.5))
#gg$gg + geom_polygon(fill="gray", col="black") 
#gg$gg + geom_polygon(fill="white", col="black") 
```

```{r,label="morphospace corolla", fig.height=3.5, fig.width=12, fig.align='center',echo=FALSE, cache=TRUE, message=FALSE, warning=FALSE,eval=T}
pca_efou_flowers$fac$pollinator_referenced <- droplevels(pca_efou_flowers$fac$pollinator_referenced)

par(mfrow=c(1,3))

plot_PCA(pca_efou_flowers,  morphospace=F, points=F,chull=F,
         zoom=0.85, center_origin = F,legend=F,axes=c(1,2),eigen=F) %>%
    layer_box(border="black",lwd=2) %>%
    layer_axesvar %>%
    layer_morphospace_PCA(size=0.35, pos="xy",col=1)

plot_PCA(pca_efou_flowers, ~continent, morphospace=F, points=F,chull=F,
         zoom=0.85, center_origin = F,legend=F,axes=c(1,2),eigen=F,
    palette=colorRampPalette(c("red","orange","purple","blue","green",
                               "forestgreen"))) %>%
    layer_box(border="black",lwd=2) %>%
    layer_points(cex=0.1, transp=0.1) %>%
    layer_axesvar %>%
    layer_morphospace_PCA(size=1, nr = 5, nc = 5, pos="range") %>%
  layer_chullfilled(0.9) %>% 
  layer_ellipses()

plot_PCA(pca_efou_flowers, ~pollinator_referenced, morphospace=F, points=F,chull=F,
         zoom=0.85, center_origin = F,legend=F,axes=c(1,2),eigen=F,
    palette=colorRampPalette(c("white","orange","magenta","red","blue","black","gold","green","aquamarine"))) %>%
    layer_points(cex=0.1, transp=0.5) %>%
    layer_box(border="black",lwd=2) %>%
    layer_axesvar %>%
    layer_morphospace_PCA(size=1, nr = 5, nc = 5, pos="range") %>%
  layer_chullfilled(0.9) %>% 
  layer_ellipses() 
```

```{r, label="area of morphospace corolla by geography", echo=FALSE, cache=FALSE, message=FALSE, warning=FALSE, results="hide"}
pcs_corolla <- as_df(pca_efou_flowers)

area_corolla_Africa<-subset(pcs_corolla,pcs_corolla$continent=="Africa")
area_corolla_Asia<-subset(pcs_corolla,pcs_corolla$continent=="Asia")
area_corolla_Australia<-subset(pcs_corolla,pcs_corolla$continent=="Australia")
area_corolla_Europe<-subset(pcs_corolla,pcs_corolla$continent=="Europe")
area_corolla_North_America<-subset(pcs_corolla,pcs_corolla$continent=="North_America")
area_corolla_South_America<-subset(pcs_corolla,pcs_corolla$continent=="South_America")

area_corolla_Africa_mat <- as.matrix(area_corolla_Africa[c(13:14)])
area_corolla_Asia_mat <- as.matrix(area_corolla_Asia[c(13:14)])
area_corolla_Australia_mat <- as.matrix(area_corolla_Australia[c(13:14)])
area_corolla_Europe_mat <- as.matrix(area_corolla_Europe[c(13:14)])
area_corolla_North_America_mat <- as.matrix(area_corolla_North_America[c(13:14)])
area_corolla_South_America_mat <- as.matrix(area_corolla_South_America[c(13:14)])

area_corolla_Africa_mat_hull <- chull(area_corolla_Africa_mat)
area_corolla_Asia_mat_hull <- chull(area_corolla_Asia_mat)
area_corolla_Australia_mat_hull <- chull(area_corolla_Australia_mat)
area_corolla_Europe_mat_hull <- chull(area_corolla_Europe_mat)
area_corolla_North_America_mat_hull <- chull(area_corolla_North_America_mat)
area_corolla_South_America_mat_hull <- chull(area_corolla_South_America_mat)

area_corolla_Africa_hull_mat<-area_corolla_Africa_mat[c(area_corolla_Africa_mat_hull,area_corolla_Africa_mat_hull[1]),]  
area_corolla_Asia_hull_mat<-area_corolla_Asia_mat[c(area_corolla_Asia_mat_hull,area_corolla_Asia_mat_hull[1]),]  
area_corolla_Australia_hull_mat<-area_corolla_Australia_mat[c(area_corolla_Australia_mat_hull,area_corolla_Australia_mat_hull[1]),]  
area_corolla_Europe_hull_mat<-area_corolla_Europe_mat[c(area_corolla_Europe_mat_hull,area_corolla_Europe_mat_hull[1]),]  
area_corolla_North_America_hull_mat<-area_corolla_North_America_mat[c(area_corolla_North_America_mat_hull,area_corolla_North_America_mat_hull[1]),]  
area_corolla_South_America_hull_mat<-area_corolla_South_America_mat[c(area_corolla_South_America_mat_hull,area_corolla_South_America_mat_hull[1]),]  

area_corolla_Africa_poly <- st_polygon(list(area_corolla_Africa_hull_mat))
area_corolla_Asia_poly <- st_polygon(list(area_corolla_Asia_hull_mat))
area_corolla_Australia_poly <- st_polygon(list(area_corolla_Australia_hull_mat))
area_corolla_Europe_poly <- st_polygon(list(area_corolla_Europe_hull_mat))
area_corolla_North_America_poly <- st_polygon(list(area_corolla_North_America_hull_mat))
area_corolla_South_America_poly <- st_polygon(list(area_corolla_South_America_hull_mat))

# int_Africa_Asia <- st_intersection(area_corolla_Africa_poly, area_corolla_Asia_poly)
# plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
# plot(area_corolla_Africa_poly,add=T, col="blue")
# plot(area_corolla_Asia_poly,add=T, col="green")
# plot(int_Africa_Asia,add=T, col="red")

### Africa vs Asia
b <- st_sfc(area_corolla_Africa_poly, area_corolla_Asia_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_Africa","area_corolla_Asia")
areas_per_group<-cbind(overlap$area_corolla_Africa[1],overlap$area_corolla_Asia[2],overlap$area_corolla_Africa[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_Africa_Asia <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","Africa","Asia","shared"))
areas_per_group_corolla_Africa_Asia$shared <- paste0(areas_per_group_corolla_Africa_Asia$shared," (",areas_per_group_percent,"%)")

#int_Africa_Australia <- st_intersection(area_corolla_Africa_poly, area_corolla_Australia_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_corolla_Africa_poly,add=T, col="blue")
#plot(area_corolla_Australia_poly,add=T, col="green")
#plot(int_Africa_Australia,add=T, col="red")

### Africa vs Australia
b <- st_sfc(area_corolla_Africa_poly, area_corolla_Australia_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_Africa","area_corolla_Australia")
areas_per_group<-cbind(overlap$area_corolla_Africa[1],overlap$area_corolla_Australia[2],overlap$area_corolla_Africa[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_Africa_Australia <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","Africa","Australia","shared"))
areas_per_group_corolla_Africa_Australia$shared <- paste0(areas_per_group_corolla_Africa_Australia$shared," (",areas_per_group_percent,"%)")

#int_Africa_Europe <- st_intersection(area_corolla_Africa_poly, area_corolla_Europe_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_corolla_Africa_poly,add=T, col="blue")
#plot(area_corolla_Europe_poly,add=T, col="green")
#plot(int_Africa_Europe,add=T, col="red")

### Africa vs Europe
b <- st_sfc(area_corolla_Africa_poly, area_corolla_Europe_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_Africa","area_corolla_Europe")
areas_per_group<-cbind(overlap$area_corolla_Africa[1],overlap$area_corolla_Europe[2],overlap$area_corolla_Africa[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_Africa_Europe <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","Africa","Europe","shared"))
areas_per_group_corolla_Africa_Europe$shared <- paste0(areas_per_group_corolla_Africa_Europe$shared," (",areas_per_group_percent,"%)")

#int_Africa_Australia <- st_intersection(area_corolla_Africa_poly, area_corolla_Australia_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_corolla_Africa_poly,add=T, col="blue")
#plot(area_corolla_Australia_poly,add=T, col="green")
#plot(int_Africa_Australia,add=T, col="red")

### Africa vs North_America
b <- st_sfc(area_corolla_Africa_poly, area_corolla_North_America_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_Africa","area_corolla_North_America")
areas_per_group<-cbind(overlap$area_corolla_Africa[1],overlap$area_corolla_North_America[2],overlap$area_corolla_Africa[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_Africa_North_America <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","Africa","North_America","shared"))
areas_per_group_corolla_Africa_North_America$shared <- paste0(areas_per_group_corolla_Africa_North_America$shared," (",areas_per_group_percent,"%)")

# int_Africa_North_America <- st_intersection(area_corolla_Africa_poly, area_corolla_North_America_poly)
# plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
# plot(area_corolla_Africa_poly,add=T, col="blue")
# plot(area_corolla_North_America_poly,add=T, col="green")
# plot(int_Africa_North_America,add=T, col="red")

### Africa vs South_America
b <- st_sfc(area_corolla_Africa_poly, area_corolla_South_America_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_Africa","area_corolla_South_America")
areas_per_group<-cbind(overlap$area_corolla_Africa[1],overlap$area_corolla_South_America[2],overlap$area_corolla_Africa[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_Africa_South_America <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","Africa","South_America","shared"))
areas_per_group_corolla_Africa_South_America$shared <- paste0(areas_per_group_corolla_Africa_South_America$shared," (",areas_per_group_percent,"%)")

#int_Asia_Australia <- st_intersection(area_corolla_Asia_poly, area_corolla_Australia_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_corolla_Asia_poly,add=T, col="blue")
#plot(area_corolla_Australia_poly,add=T, col="green")
#plot(int_Asia_Australia,add=T, col="red")

### Asia vs Australia
b <- st_sfc(area_corolla_Asia_poly, area_corolla_Australia_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_Asia","area_corolla_Australia")
areas_per_group<-cbind(overlap$area_corolla_Asia[1],overlap$area_corolla_Australia[2],overlap$area_corolla_Asia[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_Asia_Australia <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","Asia","Australia","shared"))
areas_per_group_corolla_Asia_Australia$shared <- paste0(areas_per_group_corolla_Asia_Australia$shared," (",areas_per_group_percent,"%)")

#int_Asia_Europe <- st_intersection(area_corolla_Asia_poly, area_corolla_Europe_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_corolla_Asia_poly,add=T, col="blue")
#plot(area_corolla_Europe_poly,add=T, col="green")
#plot(int_Asia_Europe,add=T, col="red")

### Asia vs Europe
b <- st_sfc(area_corolla_Asia_poly, area_corolla_Europe_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_Asia","area_corolla_Europe")
areas_per_group<-cbind(overlap$area_corolla_Asia[1],overlap$area_corolla_Europe[2],overlap$area_corolla_Asia[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_Asia_Europe <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","Asia","Europe","shared"))
areas_per_group_corolla_Asia_Europe$shared <- paste0(areas_per_group_corolla_Asia_Europe$shared," (",areas_per_group_percent,"%)")

#int_Asia_North_America <- st_intersection(area_corolla_Asia_poly, area_corolla_North_America_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_corolla_Asia_poly,add=T, col="blue")
#plot(area_corolla_North_America_poly,add=T, col="green")
#plot(int_Asia_North_America,add=T, col="red")

### Asia vs North_America
b <- st_sfc(area_corolla_Asia_poly, area_corolla_North_America_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_Asia","area_corolla_North_America")
areas_per_group<-cbind(overlap$area_corolla_Asia[1],overlap$area_corolla_North_America[2],overlap$area_corolla_Asia[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_Asia_North_America <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","Asia","North_America","shared"))
areas_per_group_corolla_Asia_North_America$shared <- paste0(areas_per_group_corolla_Asia_North_America$shared," (",areas_per_group_percent,"%)")

#int_Asia_South_America <- st_intersection(area_corolla_Asia_poly, area_corolla_South_America_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_corolla_Asia_poly,add=T, col="blue")
#plot(area_corolla_South_America_poly,add=T, col="green")
#plot(int_Asia_South_America,add=T, col="red")

### Asia vs South_America
b <- st_sfc(area_corolla_Asia_poly, area_corolla_South_America_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_Asia","area_corolla_South_America")
areas_per_group<-cbind(overlap$area_corolla_Asia[1],overlap$area_corolla_South_America[2],overlap$area_corolla_Asia[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_Asia_South_America <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","Asia","South_America","shared"))
areas_per_group_corolla_Asia_South_America$shared <- paste0(areas_per_group_corolla_Asia_South_America$shared," (",areas_per_group_percent,"%)")

#int_Australia_Europe <- st_intersection(area_corolla_Australia_poly, area_corolla_Europe_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_corolla_Australia_poly,add=T, col="blue")
#plot(area_corolla_Europe_poly,add=T, col="green")
#plot(int_Australia_Europe,add=T, col="red")

### Australia vs Europe
b <- st_sfc(area_corolla_Australia_poly, area_corolla_Europe_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_Australia","area_corolla_Europe")
areas_per_group<-cbind(overlap$area_corolla_Australia[1],overlap$area_corolla_Europe[2],overlap$area_corolla_Australia[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_Australia_Europe <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","Australia","Europe","shared"))
areas_per_group_corolla_Australia_Europe$shared <- paste0(areas_per_group_corolla_Australia_Europe$shared," (",areas_per_group_percent,"%)")

#int_Australia_North_America <- st_intersection(area_corolla_Australia_poly, area_corolla_North_America_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_corolla_Australia_poly,add=T, col="blue")
#plot(area_corolla_North_America_poly,add=T, col="green")
#plot(int_Australia_North_America,add=T, col="red")

### Australia vs North_America
b <- st_sfc(area_corolla_Australia_poly, area_corolla_North_America_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_Australia","area_corolla_North_America")
areas_per_group<-cbind(overlap$area_corolla_Australia[1],overlap$area_corolla_North_America[2],overlap$area_corolla_Australia[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_Australia_North_America <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","Australia","North_America","shared"))
areas_per_group_corolla_Australia_North_America$shared <- paste0(areas_per_group_corolla_Australia_North_America$shared," (",areas_per_group_percent,"%)")

#int_Australia_South_America <- st_intersection(area_corolla_Australia_poly, area_corolla_South_America_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_corolla_Australia_poly,add=T, col="blue")
#plot(area_corolla_South_America_poly,add=T, col="green")
#plot(int_Australia_South_America,add=T, col="red")

### Australia vs South_America
b <- st_sfc(area_corolla_Australia_poly, area_corolla_South_America_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_Australia","area_corolla_South_America")
areas_per_group<-cbind(overlap$area_corolla_Australia[1],overlap$area_corolla_South_America[2],overlap$area_corolla_Australia[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_Australia_South_America <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","Australia","South_America","shared"))
areas_per_group_corolla_Australia_South_America$shared <- paste0(areas_per_group_corolla_Australia_South_America$shared," (",areas_per_group_percent,"%)")

#int_Europe_North_America <- st_intersection(area_corolla_Europe_poly, area_corolla_North_America_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_corolla_Europe_poly,add=T, col="blue")
#plot(area_corolla_North_America_poly,add=T, col="green")
#plot(int_Europe_North_America,add=T, col="red")

### Europe vs North_America
b <- st_sfc(area_corolla_Europe_poly, area_corolla_North_America_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_Europe","area_corolla_North_America")
areas_per_group<-cbind(overlap$area_corolla_Europe[1],overlap$area_corolla_North_America[2],overlap$area_corolla_Europe[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_Europe_North_America <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","Europe","North_America","shared"))
areas_per_group_corolla_Europe_North_America$shared <- paste0(areas_per_group_corolla_Europe_North_America$shared," (",areas_per_group_percent,"%)")

#int_Europe_South_America <- st_intersection(area_corolla_Europe_poly, area_corolla_South_America_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_corolla_Europe_poly,add=T, col="blue")
#plot(area_corolla_South_America_poly,add=T, col="green")
#plot(int_Europe_South_America,add=T, col="red")

### Europe vs South_America
b <- st_sfc(area_corolla_Europe_poly, area_corolla_South_America_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_Europe","area_corolla_South_America")
areas_per_group<-cbind(overlap$area_corolla_Europe[1],overlap$area_corolla_South_America[2],overlap$area_corolla_Europe[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_Europe_South_America <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","Europe","South_America","shared"))
areas_per_group_corolla_Europe_South_America$shared <- paste0(areas_per_group_corolla_Europe_South_America$shared," (",areas_per_group_percent,"%)")

#int_North_America_South_America <- st_intersection(area_corolla_North_America_poly, area_corolla_South_America_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_corolla_North_America_poly,add=T, col="blue")
#plot(area_corolla_South_America_poly,add=T, col="green")
#plot(int_North_America_South_America,add=T, col="red")

### North_America vs South_America
b <- st_sfc(area_corolla_North_America_poly, area_corolla_South_America_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_North_America","area_corolla_South_America")
areas_per_group<-cbind(overlap$area_corolla_North_America[1],overlap$area_corolla_South_America[2],overlap$area_corolla_North_America[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_North_America_South_America <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","North_America","South_America","shared"))
areas_per_group_corolla_North_America_South_America$shared <- paste0(areas_per_group_corolla_North_America_South_America$shared," (",areas_per_group_percent,"%)")
```

```{r, label="area of morphospace corolla by pollinator", echo=FALSE, cache=FALSE, message=FALSE, warning=FALSE}

area_corolla_honeyeater<-subset(pcs_corolla,pcs_corolla$pollinator_referenced=="honeyeater")
area_corolla_hummingbird<-subset(pcs_corolla,pcs_corolla$pollinator_referenced=="hummingbird")
area_corolla_insect<-subset(pcs_corolla,pcs_corolla$pollinator_referenced=="insect")
area_corolla_sunbird<-subset(pcs_corolla,pcs_corolla$pollinator_referenced=="sunbird")

area_corolla_lepidoptera<-subset(pcs_corolla,pcs_corolla$pollinator_referenced=="lepidoptera")
area_corolla_long_proboscid_fly<-subset(pcs_corolla,pcs_corolla$pollinator_referenced=="long_proboscid_fly")
area_corolla_wind<-subset(pcs_corolla,pcs_corolla$pollinator_referenced=="wind")
area_corolla_hummingbird_OW<-subset(pcs_corolla,pcs_corolla$pollinator_referenced=="hummingbird_OW")

###

area_corolla_honeyeater_mat <- as.matrix(area_corolla_honeyeater[c(13:14)])
area_corolla_hummingbird_mat <- as.matrix(area_corolla_hummingbird[c(13:14)])
area_corolla_insect_mat <- as.matrix(area_corolla_insect[c(13:14)])
area_corolla_sunbird_mat <- as.matrix(area_corolla_sunbird[c(13:14)])
area_corolla_lepidoptera_mat <- as.matrix(area_corolla_lepidoptera[c(13:14)])
area_corolla_long_proboscid_fly_mat <- as.matrix(area_corolla_long_proboscid_fly[c(13:14)])
area_corolla_wind_mat <- as.matrix(area_corolla_wind[c(13:14)])
area_corolla_hummingbird_OW_mat <- as.matrix(area_corolla_hummingbird_OW[c(13:14)])

###

area_corolla_honeyeater_mat_hull <- chull(area_corolla_honeyeater_mat)
area_corolla_hummingbird_mat_hull <- chull(area_corolla_hummingbird_mat)
area_corolla_insect_mat_hull <- chull(area_corolla_insect_mat)
area_corolla_sunbird_mat_hull <- chull(area_corolla_sunbird_mat)
area_corolla_lepidoptera_mat_hull <- chull(area_corolla_lepidoptera_mat)
area_corolla_long_proboscid_fly_mat_hull <- chull(area_corolla_long_proboscid_fly_mat)
area_corolla_wind_mat_hull <- chull(area_corolla_wind_mat)
area_corolla_hummingbird_OW_mat_hull <- chull(area_corolla_hummingbird_OW_mat)

area_corolla_honeyeater_hull_mat<-area_corolla_honeyeater_mat[c(area_corolla_honeyeater_mat_hull,area_corolla_honeyeater_mat_hull[1]),]  
area_corolla_hummingbird_hull_mat<-area_corolla_hummingbird_mat[c(area_corolla_hummingbird_mat_hull,area_corolla_hummingbird_mat_hull[1]),]  
area_corolla_insect_hull_mat<-area_corolla_insect_mat[c(area_corolla_insect_mat_hull,area_corolla_insect_mat_hull[1]),]  
area_corolla_sunbird_hull_mat<-area_corolla_sunbird_mat[c(area_corolla_sunbird_mat_hull,area_corolla_sunbird_mat_hull[1]),]  
area_corolla_lepidoptera_hull_mat<-area_corolla_lepidoptera_mat[c(area_corolla_lepidoptera_mat_hull,area_corolla_lepidoptera_mat_hull[1]),]
area_corolla_long_proboscid_fly_hull_mat<-area_corolla_long_proboscid_fly_mat[c(area_corolla_long_proboscid_fly_mat_hull,area_corolla_long_proboscid_fly_mat_hull[1]),]  
area_corolla_wind_hull_mat<-area_corolla_wind_mat[c(area_corolla_wind_mat_hull,area_corolla_wind_mat_hull[1]),]  
area_corolla_hummingbird_OW_hull_mat<-area_corolla_hummingbird_OW_mat[c(area_corolla_hummingbird_OW_mat_hull,area_corolla_hummingbird_OW_mat_hull[1]),]  

###

area_corolla_honeyeater_poly <- st_polygon(list(area_corolla_honeyeater_hull_mat))
area_corolla_hummingbird_poly <- st_polygon(list(area_corolla_hummingbird_hull_mat))
area_corolla_insect_poly <- st_polygon(list(area_corolla_insect_hull_mat))
area_corolla_sunbird_poly <- st_polygon(list(area_corolla_sunbird_hull_mat))
area_corolla_lepidoptera_poly <- st_polygon(list(area_corolla_lepidoptera_hull_mat))
area_corolla_long_proboscid_fly_poly <- st_polygon(list(area_corolla_long_proboscid_fly_hull_mat))
area_corolla_wind_poly <- st_polygon(list(area_corolla_wind_hull_mat))
area_corolla_hummingbird_OW_poly <- st_polygon(list(area_corolla_hummingbird_OW_hull_mat))

### honeyeater vs hummingbird
### honeyeater vs insect
### honeyeater vs sunbird
### honeyeater vs lepidoptera
### honeyeater vs long_proboscid_fly
### honeyeater vs wind
### honeyeater vs hummingbird_OW

### hummingbird vs insect
### hummingbird vs sunbird
### hummingbird vs lepidoptera
### hummingbird vs long_proboscid_fly
### hummingbird vs wind
### hummingbird vs hummingbird_OW

### insect vs sunbird
### insect vs lepidoptera
### insect vs long_proboscid_fly
### insect vs wind
### insect vs hummingbird_OW

### sunbird vs lepidoptera
### sunbird vs long_proboscid_fly
### sunbird vs wind
### sunbird vs hummingbird_OW

### lepidoptera vs long_proboscid_fly
### lepidoptera vs wind
### lepidoptera vs hummingbird_OW

### long_proboscid_fly vs wind
### long_proboscid_fly vs hummingbird_OW

### hummingbird_OW vs wind

### honeyeater vs hummingbird
b <- st_sfc(area_corolla_honeyeater_poly, area_corolla_hummingbird_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_honeyeater","area_corolla_hummingbird")
areas_per_group<-cbind(overlap$area_corolla_honeyeater[1],overlap$area_corolla_hummingbird[2],overlap$area_corolla_honeyeater[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_honeyeater_hummingbird <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","honeyeater","hummingbird","shared"))
areas_per_group_corolla_honeyeater_hummingbird$shared <- paste0(areas_per_group_corolla_honeyeater_hummingbird$shared," (",areas_per_group_percent,"%)")

### honeyeater vs insect
b <- st_sfc(area_corolla_honeyeater_poly, area_corolla_insect_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_honeyeater","area_corolla_insect")
areas_per_group<-cbind(overlap$area_corolla_honeyeater[1],overlap$area_corolla_insect[2],overlap$area_corolla_honeyeater[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_honeyeater_insect <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","honeyeater","insect","shared"))
areas_per_group_corolla_honeyeater_insect$shared <- paste0(areas_per_group_corolla_honeyeater_insect$shared," (",areas_per_group_percent,"%)")

#int_honeyeater_sunbird <- st_intersection(area_corolla_honeyeater_poly, area_corolla_sunbird_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_corolla_honeyeater_poly,add=T, col="blue")
#plot(area_corolla_sunbird_poly,add=T, col="green")
#plot(int_honeyeater_sunbird,add=T, col="red")

### honeyeater vs sunbird
b <- st_sfc(area_corolla_honeyeater_poly, area_corolla_sunbird_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_honeyeater","area_corolla_sunbird")
areas_per_group<-cbind(overlap$area_corolla_honeyeater[1],overlap$area_corolla_sunbird[2],overlap$area_corolla_honeyeater[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_honeyeater_sunbird <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","honeyeater","sunbird","shared"))
areas_per_group_corolla_honeyeater_sunbird$shared <- paste0(areas_per_group_corolla_honeyeater_sunbird$shared," (",areas_per_group_percent,"%)")

### honeyeater vs lepidoptera
b <- st_sfc(area_corolla_honeyeater_poly, area_corolla_lepidoptera_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_honeyeater","area_corolla_lepidoptera")
areas_per_group<-cbind(overlap$area_corolla_honeyeater[1],overlap$area_corolla_lepidoptera[2],overlap$area_corolla_honeyeater[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_honeyeater_lepidoptera <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","honeyeater","lepidoptera","shared"))
areas_per_group_corolla_honeyeater_lepidoptera$shared <- paste0(areas_per_group_corolla_honeyeater_lepidoptera$shared," (",areas_per_group_percent,"%)")

# int_honeyeater_lepidoptera <- st_intersection(area_corolla_honeyeater_poly, area_corolla_lepidoptera_poly)
# plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
# plot(area_corolla_honeyeater_poly,add=T, col="blue")
# plot(area_corolla_lepidoptera_poly,add=T, col="green")
# plot(int_honeyeater_lepidoptera,add=T, col="red")
# 
### honeyeater vs long_proboscid_fly
b <- st_sfc(area_corolla_honeyeater_poly, area_corolla_long_proboscid_fly_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_honeyeater","area_corolla_long_proboscid_fly")
areas_per_group<-cbind(overlap$area_corolla_honeyeater[1],overlap$area_corolla_long_proboscid_fly[2],overlap$area_corolla_honeyeater[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_honeyeater_long_proboscid_fly <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","honeyeater","long_proboscid_fly","shared"))
areas_per_group_corolla_honeyeater_long_proboscid_fly$shared <- paste0(areas_per_group_corolla_honeyeater_long_proboscid_fly$shared," (",areas_per_group_percent,"%)")

### honeyeater vs wind
b <- st_sfc(area_corolla_honeyeater_poly, area_corolla_wind_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_honeyeater","area_corolla_wind")
areas_per_group<-cbind(overlap$area_corolla_honeyeater[1],overlap$area_corolla_wind[2],overlap$area_corolla_honeyeater[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_honeyeater_wind <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","honeyeater","wind","shared"))
areas_per_group_corolla_honeyeater_wind$shared <- paste0(areas_per_group_corolla_honeyeater_wind$shared," (",areas_per_group_percent,"%)")

### honeyeater vs hummingbird_OW
b <- st_sfc(area_corolla_honeyeater_poly, area_corolla_hummingbird_OW_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_honeyeater","area_corolla_hummingbird_OW")
areas_per_group<-cbind(overlap$area_corolla_honeyeater[1],overlap$area_corolla_hummingbird_OW[2],overlap$area_corolla_honeyeater[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_honeyeater_hummingbird_OW <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","honeyeater","hummingbird_OW","shared"))
areas_per_group_corolla_honeyeater_hummingbird_OW$shared <- paste0(areas_per_group_corolla_honeyeater_hummingbird_OW$shared," (",areas_per_group_percent,"%)")

#int_hummingbird_insect <- st_intersection(area_corolla_hummingbird_poly, area_corolla_insect_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_corolla_hummingbird_poly,add=T, col="blue")
#plot(area_corolla_insect_poly,add=T, col="green")
#plot(int_hummingbird_insect,add=T, col="red")

### hummingbird vs insect
b <- st_sfc(area_corolla_hummingbird_poly, area_corolla_insect_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_hummingbird","area_corolla_insect")
areas_per_group<-cbind(overlap$area_corolla_hummingbird[1],overlap$area_corolla_insect[2],overlap$area_corolla_hummingbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_hummingbird_insect <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","hummingbird","insect","shared"))
areas_per_group_corolla_hummingbird_insect$shared <- paste0(areas_per_group_corolla_hummingbird_insect$shared," (",areas_per_group_percent,"%)")

#int_hummingbird_sunbird <- st_intersection(area_corolla_hummingbird_poly, area_corolla_sunbird_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_corolla_hummingbird_poly,add=T, col="blue")
#plot(area_corolla_sunbird_poly,add=T, col="green")
#plot(int_hummingbird_sunbird,add=T, col="red")

### hummingbird vs sunbird
b <- st_sfc(area_corolla_hummingbird_poly, area_corolla_sunbird_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_hummingbird","area_corolla_sunbird")
areas_per_group<-cbind(overlap$area_corolla_hummingbird[1],overlap$area_corolla_sunbird[2],overlap$area_corolla_hummingbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_hummingbird_sunbird <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","hummingbird","sunbird","shared"))
areas_per_group_corolla_hummingbird_sunbird$shared <- paste0(areas_per_group_corolla_hummingbird_sunbird$shared," (",areas_per_group_percent,"%)")

#int_insect_sunbird <- st_intersection(area_corolla_insect_poly, area_corolla_sunbird_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_corolla_insect_poly,add=T, col="blue")
#plot(area_corolla_sunbird_poly,add=T, col="green")
#plot(int_insect_sunbird,add=T, col="red")

### hummingbird vs lepidoptera
b <- st_sfc(area_corolla_hummingbird_poly, area_corolla_lepidoptera_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_hummingbird","area_corolla_lepidoptera")
areas_per_group<-cbind(overlap$area_corolla_hummingbird[1],overlap$area_corolla_lepidoptera[2],overlap$area_corolla_hummingbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_hummingbird_lepidoptera <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","hummingbird","lepidoptera","shared"))
areas_per_group_corolla_hummingbird_lepidoptera$shared <- paste0(areas_per_group_corolla_hummingbird_lepidoptera$shared," (",areas_per_group_percent,"%)")

### hummingbird vs long_proboscid_fly
b <- st_sfc(area_corolla_hummingbird_poly, area_corolla_long_proboscid_fly_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_hummingbird","area_corolla_long_proboscid_fly")
areas_per_group<-cbind(overlap$area_corolla_hummingbird[1],overlap$area_corolla_long_proboscid_fly[2],overlap$area_corolla_hummingbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_hummingbird_long_proboscid_fly <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","hummingbird","long_proboscid_fly","shared"))
areas_per_group_corolla_hummingbird_long_proboscid_fly$shared <- paste0(areas_per_group_corolla_hummingbird_long_proboscid_fly$shared," (",areas_per_group_percent,"%)")

### hummingbird vs wind
b <- st_sfc(area_corolla_hummingbird_poly, area_corolla_wind_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_hummingbird","area_corolla_wind")
areas_per_group<-cbind(overlap$area_corolla_hummingbird[1],overlap$area_corolla_wind[2],overlap$area_corolla_hummingbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_hummingbird_wind <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","hummingbird","wind","shared"))
areas_per_group_corolla_hummingbird_wind$shared <- paste0(areas_per_group_corolla_hummingbird_wind$shared," (",areas_per_group_percent,"%)")

### hummingbird vs hummingbird_OW
b <- st_sfc(area_corolla_hummingbird_poly, area_corolla_hummingbird_OW_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_hummingbird","area_corolla_hummingbird_OW")
areas_per_group<-cbind(overlap$area_corolla_hummingbird[1],overlap$area_corolla_hummingbird_OW[2],overlap$area_corolla_hummingbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_hummingbird_hummingbird_OW <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","hummingbird","hummingbird_OW","shared"))
areas_per_group_corolla_hummingbird_hummingbird_OW$shared <- paste0(areas_per_group_corolla_hummingbird_hummingbird_OW$shared," (",areas_per_group_percent,"%)")


### insect vs sunbird
b <- st_sfc(area_corolla_insect_poly, area_corolla_sunbird_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_insect","area_corolla_sunbird")
areas_per_group<-cbind(overlap$area_corolla_insect[1],overlap$area_corolla_sunbird[2],overlap$area_corolla_insect[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_insect_sunbird <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","insect","sunbird","shared"))
areas_per_group_corolla_insect_sunbird$shared <- paste0(areas_per_group_corolla_insect_sunbird$shared," (",areas_per_group_percent,"%)")

#int_insect_North_America <- st_intersection(area_corolla_insect_poly, area_corolla_North_America_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_corolla_insect_poly,add=T, col="blue")
#plot(area_corolla_North_America_poly,add=T, col="green")
#plot(int_insect_North_America,add=T, col="red")

### insect vs lepidoptera
b <- st_sfc(area_corolla_insect_poly, area_corolla_lepidoptera_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_insect","area_corolla_lepidoptera")
areas_per_group<-cbind(overlap$area_corolla_insect[1],overlap$area_corolla_lepidoptera[2],overlap$area_corolla_insect[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_insect_lepidoptera <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","insect","lepidoptera","shared"))
areas_per_group_corolla_insect_lepidoptera$shared <- paste0(areas_per_group_corolla_insect_lepidoptera$shared," (",areas_per_group_percent,"%)")

### insect vs long_proboscid_fly
b <- st_sfc(area_corolla_insect_poly, area_corolla_long_proboscid_fly_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_insect","area_corolla_long_proboscid_fly")
areas_per_group<-cbind(overlap$area_corolla_insect[1],overlap$area_corolla_long_proboscid_fly[2],overlap$area_corolla_insect[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_insect_long_proboscid_fly <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","insect","long_proboscid_fly","shared"))
areas_per_group_corolla_insect_long_proboscid_fly$shared <- paste0(areas_per_group_corolla_insect_long_proboscid_fly$shared," (",areas_per_group_percent,"%)")

### insect vs wind
b <- st_sfc(area_corolla_insect_poly, area_corolla_wind_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_insect","area_corolla_wind")
areas_per_group<-cbind(overlap$area_corolla_insect[1],overlap$area_corolla_wind[2],overlap$area_corolla_insect[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_insect_wind <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","insect","wind","shared"))
areas_per_group_corolla_insect_wind$shared <- paste0(areas_per_group_corolla_insect_wind$shared," (",areas_per_group_percent,"%)")

### insect vs hummingbird_OW
b <- st_sfc(area_corolla_insect_poly, area_corolla_hummingbird_OW_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_insect","area_corolla_hummingbird_OW")
areas_per_group<-cbind(overlap$area_corolla_insect[1],overlap$area_corolla_hummingbird_OW[2],overlap$area_corolla_insect[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_insect_hummingbird_OW <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","insect","hummingbird_OW","shared"))
areas_per_group_corolla_insect_hummingbird_OW$shared <- paste0(areas_per_group_corolla_insect_hummingbird_OW$shared," (",areas_per_group_percent,"%)")


### sunbird vs lepidoptera
b <- st_sfc(area_corolla_sunbird_poly, area_corolla_lepidoptera_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_sunbird","area_corolla_lepidoptera")
areas_per_group<-cbind(overlap$area_corolla_sunbird[1],overlap$area_corolla_lepidoptera[2],overlap$area_corolla_sunbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_sunbird_lepidoptera <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","sunbird","lepidoptera","shared"))
areas_per_group_corolla_sunbird_lepidoptera$shared <- paste0(areas_per_group_corolla_sunbird_lepidoptera$shared," (",areas_per_group_percent,"%)")

### sunbird vs long_proboscid_fly
b <- st_sfc(area_corolla_sunbird_poly, area_corolla_long_proboscid_fly_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_sunbird","area_corolla_long_proboscid_fly")
areas_per_group<-cbind(overlap$area_corolla_sunbird[1],overlap$area_corolla_long_proboscid_fly[2],overlap$area_corolla_sunbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_sunbird_long_proboscid_fly <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","sunbird","long_proboscid_fly","shared"))
areas_per_group_corolla_sunbird_long_proboscid_fly$shared <- paste0(areas_per_group_corolla_sunbird_long_proboscid_fly$shared," (",areas_per_group_percent,"%)")

### sunbird vs wind
b <- st_sfc(area_corolla_sunbird_poly, area_corolla_wind_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_sunbird","area_corolla_wind")
areas_per_group<-cbind(overlap$area_corolla_sunbird[1],overlap$area_corolla_wind[2],overlap$area_corolla_sunbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_sunbird_wind <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","sunbird","wind","shared"))
areas_per_group_corolla_sunbird_wind$shared <- paste0(areas_per_group_corolla_sunbird_wind$shared," (",areas_per_group_percent,"%)")

### sunbird vs hummingbird_OW
b <- st_sfc(area_corolla_sunbird_poly, area_corolla_hummingbird_OW_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_sunbird","area_corolla_hummingbird_OW")
areas_per_group<-cbind(overlap$area_corolla_sunbird[1],overlap$area_corolla_hummingbird_OW[2],overlap$area_corolla_sunbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_sunbird_hummingbird_OW <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","sunbird","hummingbird_OW","shared"))
areas_per_group_corolla_sunbird_hummingbird_OW$shared <- paste0(areas_per_group_corolla_sunbird_hummingbird_OW$shared," (",areas_per_group_percent,"%)")

### lepidoptera vs long_proboscid_fly
b <- st_sfc(area_corolla_lepidoptera_poly, area_corolla_long_proboscid_fly_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_lepidoptera","area_corolla_long_proboscid_fly")
areas_per_group<-cbind(overlap$area_corolla_lepidoptera[1],overlap$area_corolla_long_proboscid_fly[2],overlap$area_corolla_lepidoptera[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_lepidoptera_long_proboscid_fly <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","lepidoptera","long_proboscid_fly","shared"))
areas_per_group_corolla_lepidoptera_long_proboscid_fly$shared <- paste0(areas_per_group_corolla_lepidoptera_long_proboscid_fly$shared," (",areas_per_group_percent,"%)")

### lepidoptera vs wind
b <- st_sfc(area_corolla_lepidoptera_poly, area_corolla_wind_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_lepidoptera","area_corolla_wind")
areas_per_group<-cbind(overlap$area_corolla_lepidoptera[1],overlap$area_corolla_wind[2],overlap$area_corolla_lepidoptera[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_lepidoptera_wind <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","lepidoptera","wind","shared"))
areas_per_group_corolla_lepidoptera_wind$shared <- paste0(areas_per_group_corolla_lepidoptera_wind$shared," (",areas_per_group_percent,"%)")

### lepidoptera vs hummingbird_OW
b <- st_sfc(area_corolla_lepidoptera_poly, area_corolla_hummingbird_OW_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_lepidoptera","area_corolla_hummingbird_OW")
areas_per_group<-cbind(overlap$area_corolla_lepidoptera[1],overlap$area_corolla_hummingbird_OW[2],overlap$area_corolla_lepidoptera[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_lepidoptera_hummingbird_OW <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","lepidoptera","hummingbird_OW","shared"))
areas_per_group_corolla_lepidoptera_hummingbird_OW$shared <- paste0(areas_per_group_corolla_lepidoptera_hummingbird_OW$shared," (",areas_per_group_percent,"%)")

### long_proboscid_fly vs wind
b <- st_sfc(area_corolla_long_proboscid_fly_poly, area_corolla_wind_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_long_proboscid_fly","area_corolla_wind")
areas_per_group<-cbind(overlap$area_corolla_long_proboscid_fly[1],overlap$area_corolla_wind[2],overlap$area_corolla_long_proboscid_fly[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_long_proboscid_fly_wind <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","long_proboscid_fly","wind","shared"))
areas_per_group_corolla_long_proboscid_fly_wind$shared <- paste0(areas_per_group_corolla_long_proboscid_fly_wind$shared," (",areas_per_group_percent,"%)")

### long_proboscid_fly vs hummingbird_OW
b <- st_sfc(area_corolla_long_proboscid_fly_poly, area_corolla_hummingbird_OW_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_long_proboscid_fly","area_corolla_hummingbird_OW")
areas_per_group<-cbind(overlap$area_corolla_long_proboscid_fly[1],overlap$area_corolla_hummingbird_OW[2],overlap$area_corolla_long_proboscid_fly[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_long_proboscid_fly_hummingbird_OW <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","long_proboscid_fly","hummingbird_OW","shared"))
areas_per_group_corolla_long_proboscid_fly_hummingbird_OW$shared <- paste0(areas_per_group_corolla_long_proboscid_fly_hummingbird_OW$shared," (",areas_per_group_percent,"%)")

### hummingbird_OW vs wind
b <- st_sfc(area_corolla_hummingbird_OW_poly, area_corolla_wind_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_corolla_hummingbird_OW","area_corolla_wind")
areas_per_group<-cbind(overlap$area_corolla_hummingbird_OW[1],overlap$area_corolla_wind[2],overlap$area_corolla_hummingbird_OW[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_corolla_hummingbird_OW_wind <- cbind("corolla",areas_per_group) %>% data.frame() %>% setNames(c("variable","hummingbird_OW","wind","shared"))
areas_per_group_corolla_hummingbird_OW_wind$shared <- paste0(areas_per_group_corolla_hummingbird_OW_wind$shared," (",areas_per_group_percent,"%)")
```

\pagebreak

## Anthers

```{r, label="Anther_import", echo=FALSE, cache=F, message=FALSE, warning=FALSE, results='hide'}
#jpg.list_anthers <- list.files("outlines/anther_sideway_no_app",pattern = ".jpg",full.names=T)
#returns_anthers <- import_jpg(jpg.paths = jpg.list_anthers, auto.notcentered=T) 
#saveRDS(returns_anthers,"outlines/outlines_landmarked/ericaceae_anthers_930.rds")

returns_anthers <- readRDS("outlines/outlines_landmarked/ericaceae_anthers_930.rds")
anthers <- Out(returns_anthers) 

groups_anthers <- read.csv("spreadsheets/anther_groups.csv")
groups_anthers <- data.frame(groups_anthers[,1:5])

t <- unique(groups_anthers[c("species", "continent")])
u <- table(t$species) %>% data.frame()


# Make more groups
#groups_anthers$pollinator_by_landmass <- paste0(groups_anthers$pollinator_general,"_",groups_anthers$land_mass)
#groups_anthers$pollinator_by_continent <- paste0(groups_anthers$pollinator_general,"_",groups_anthers$continent)
#groups_anthers$pollinator_by_subfamily <- paste0(groups_anthers$pollinator_general,"_",groups_anthers$subfamily)

# Make factor these grouping vars
#groups_anthers$pollinator_by_landmass <- as.factor(groups_anthers$pollinator_by_landmass)
#groups_anthers$pollinator_by_continent <- as.factor(groups_anthers$pollinator_by_continent)
#groups_anthers$pollinator_by_subfamily <- as.factor(groups_anthers$pollinator_by_subfamily)

groups_anthers$species <- gsub("Cladothamnus_pyroliflorus","Elliottia_pyroliflora", groups_anthers$species)
groups_anthers$species <- gsub("Comarostaphylis_macvaughii","Comarostaphylis_discolor", groups_anthers$species)
groups_anthers$species <- gsub("Daboecia_polifolia","Daboecia_cantabrica", groups_anthers$species)
groups_anthers$species <- gsub("Empetrum_hermaphroditum","Empetrum_nigrum", groups_anthers$species)
groups_anthers$species <- gsub("Enkianthus_taiwanianus","Enkianthus_perulatus", groups_anthers$species)
groups_anthers$species <- gsub("Erica_bowieana","Erica_bauera", groups_anthers$species)
groups_anthers$species <- gsub("Erica_fervida","Erica_pillansii", groups_anthers$species)
groups_anthers$species <- gsub("Erica_mediterranea","Erica_herbacea", groups_anthers$species)
groups_anthers$species <- gsub("Erica_mucosa","Erica_ferrea", groups_anthers$species)
groups_anthers$species <- gsub("Erica_ruwenzoriensis","Erica_kingaensis", groups_anthers$species)
groups_anthers$species <- gsub("Erica_tegetiformis","Erica_senilis", groups_anthers$species)
groups_anthers$species <- gsub("Macleania_punctata","Macleania_cordifolia", groups_anthers$species)
groups_anthers$species <- gsub("Hypopitys_monotropa","Monotropa_hypopitys", groups_anthers$species)
groups_anthers$species <- gsub("Pieris_ovalifolia","Lyonia_ovalifolia", groups_anthers$species)
groups_anthers$species <- gsub("Pieris_villosa","Lyonia_ovalifolia", groups_anthers$species)
groups_anthers$species <- gsub("Rhododendron_fictolacteum","Rhododendron_rex", groups_anthers$species)
groups_anthers$species <- gsub("Rhododendron_tamaense","Rhododendron_cinnabarinum", groups_anthers$species)

groups_anthers <- left_join(groups_anthers, pollinators, "species")

groups_anthers$continent <- as.factor(groups_anthers$continent)
anthers$fac <- groups_anthers
anthers$fac$species <- as.factor(anthers$fac$species)
anthers$fac$pollinator_referenced <- droplevels(anthers$fac$pollinator_referenced)

# Remove outgroups

anthers <- filter(anthers,!anthers$fac$species=="Clethra_alnifolia")
anthers <- filter(anthers,!anthers$fac$species=="Cyrilla_racemiflora")
anthers <- filter(anthers,!anthers$fac$species=="Purdiaea_bissei")

groups_anthers <- subset(groups_anthers,!groups_anthers$species=="Clethra_alnifolia")
groups_anthers <- subset(groups_anthers,!groups_anthers$species=="Cyrilla_racemiflora")
groups_anthers <- subset(groups_anthers,!groups_anthers$species=="Purdiaea_bissei")
```
 
```{r, label="Centering_and_scaling_of_anthers", cache=F, echo=FALSE}
anthers$coo <- lapply(anthers$coo, coo_interpolate, n=200) 
anthers <- coo_center(anthers)
anthers$coo <- lapply(anthers$coo, FUN=function(x)(coo_scale(x, max(x[,2]/1000)))) 
anthers <- coo_scale(anthers, 1000) 
```

```{r, label="Landmarking_of_anthers",echo=FALSE, cache=F, message=FALSE, warning=FALSE,results='hide'}
ldks2 <- vector("list", length=length(anthers$coo))
names(ldks2) <- names(anthers$coo)
centroids <- coo_centpos(anthers) 
for (i in 1:length(anthers)) {
  ldk <- numeric(4)
  anthers$coo[[i]] -> x
  # lower middle
  p <- c(centroids[i,1], min(x[,2]))
  l <- apply(x, 1, function(y) sqrt(sum((p - y)^2)))
  ldk[1] <- which.min(l)
  # upper middle
  p <- c(centroids[i,1], max(x[,2]))
  l <- apply(x, 1, function(y) sqrt(sum((p - y)^2)))
  ldk[2] <- which.min(l)
  # middle left
  p <- c(min(x[,1]), centroids[i,2])
  l <- apply(x, 1, function(y) sqrt(sum((p - y)^2)))
  ldk[3] <- which.min(l)
  # middle right
  p <- c(max(x[,1]), centroids[i,2])
  l <- apply(x, 1, function(y) sqrt(sum((p - y)^2)))
  ldk[4] <- which.min(l)
  ldk -> ldks2[[i]]
}
anthers$ldk <- ldks2
anthers <- coo_slide(anthers, ldk=2) 
anthers <- fgProcrustes(anthers) 
```
  
```{r, label="elliptic_Fourier_analysis_anthers", echo=FALSE, cache=TRUE, message=FALSE, warning=FALSE}
#calibrate_harmonicpower_efourier(anthers)
efou_anthers <- efourier(anthers, norm=T, nb.h=32, smooth.it=1) 
efou_anthers_mean <- MSHAPES(efou_anthers, 'species') 
pca_efou_anthers <- PCA(efou_anthers_mean$Coe) 
```

```{r, fig.height=3, fig.width=3, fig.align='center', label="Panel_anthers", echo=FALSE, cache=TRUE, message=FALSE, warning=FALSE}
panel(anthers, col=0, border=1)
```

Sample sizes

```{r, label="Count_anthers", fig.height=3, fig.width=3, fig.align='center', echo=FALSE, cache=TRUE, message=FALSE, warning=FALSE}
sample_size_contintent <- table(anthers$fac$continent) %>% t() %>% data.frame()
sample_size_contintent <- sample_size_contintent[2:3]
kable(sample_size_contintent)
sample_size_pollinator_referenced <- table(anthers$fac$pollinator_referenced) %>% t() %>% data.frame()
sample_size_pollinator_referenced <- sample_size_pollinator_referenced[2:3]
kable(sample_size_pollinator_referenced)
```

```{r,label="PC_contrib_anther", fig.height=2, fig.width=3, fig.align='center',echo=FALSE, cache=TRUE, message=FALSE, warning=FALSE,eval=T}
#PCcontrib(pca_efou_anthers, nax = c(1:2),sd.r = c(-1.5, -0.5, 0, 0.5, 1.5), cex.labels = 10) 
gg <- PCcontrib(pca_efou_anthers, nax=1:2, sd.r=c(-1.5, -0.5, 0, 0.5, 1.5))
#gg$gg + geom_polygon(fill="gray", col="black") 
#gg$gg + geom_polygon(fill="white", col="black") 
```

```{r,label="morphospace anthers", fig.height=3.5, fig.width=12, fig.align='center',echo=FALSE, cache=TRUE, message=FALSE, warning=FALSE,eval=T}

pca_efou_anthers$fac$pollinator_referenced <- droplevels(pca_efou_anthers$fac$pollinator_referenced)

par(mfrow=c(1,3))
plot_PCA(pca_efou_anthers, morphospace=F, points=F,chull=F,
         zoom=0.85, center_origin = F,legend=F,axes=c(1,2),eigen=F) %>%
    layer_box(border="black",lwd=2) %>%
    layer_axesvar %>%
    layer_morphospace_PCA(size=0.4, pos="xy",rotate=1.6,col="black") 

plot_PCA(pca_efou_anthers, ~continent, morphospace=F, points=F,chull=F,
         zoom=0.85, center_origin = F,legend=F,axes=c(1,2),eigen=F,
    palette=colorRampPalette(c("red","orange","purple","blue","green",
                               "forestgreen"))) %>%
    layer_box(border="black",lwd=2) %>%
    layer_points(cex=0.1, transp=0.1) %>%
    layer_axesvar %>%
    layer_morphospace_PCA(size=1, nr = 5, nc = 5, pos="range",rotate=1.6) %>%
 layer_chullfilled(0.9) %>% 
  layer_ellipses() 

plot_PCA(pca_efou_anthers, ~pollinator_referenced, morphospace=F, points=F,chull=F,
         zoom=0.85, center_origin = F,legend=F,axes=c(1,2),eigen=F,
         palette=colorRampPalette(c("white","orange","magenta","red","blue","black","gold","green","aquamarine"))) %>%
  layer_box(border="black",lwd=2) %>%
  layer_points(cex=0.1, transp=0.5) %>%
  layer_axesvar %>%
  layer_morphospace_PCA(size=0.8, nr = 5, nc = 5, pos="range",rotate=1.6) %>%
  layer_chullfilled(0.9) %>% 
  layer_ellipses() 
```

```{r, label="area of morphospace anther by geography", echo=FALSE, cache=FALSE, message=FALSE, warning=FALSE, results="hide"}
pcs_anther <- as_df(pca_efou_anthers)

area_anther_Africa<-subset(pcs_anther,pcs_anther$continent=="Africa")
area_anther_Asia<-subset(pcs_anther,pcs_anther$continent=="Asia")
area_anther_Australia<-subset(pcs_anther,pcs_anther$continent=="Australia")
area_anther_Europe<-subset(pcs_anther,pcs_anther$continent=="Europe")
area_anther_North_America<-subset(pcs_anther,pcs_anther$continent=="North_America")
area_anther_South_America<-subset(pcs_anther,pcs_anther$continent=="South_America")

area_anther_Africa_mat <- as.matrix(area_anther_Africa[c(10:11)])
area_anther_Asia_mat <- as.matrix(area_anther_Asia[c(10:11)])
area_anther_Australia_mat <- as.matrix(area_anther_Australia[c(10:11)])
area_anther_Europe_mat <- as.matrix(area_anther_Europe[c(10:11)])
area_anther_North_America_mat <- as.matrix(area_anther_North_America[c(10:11)])
area_anther_South_America_mat <- as.matrix(area_anther_South_America[c(10:11)])

area_anther_Africa_mat_hull <- chull(area_anther_Africa_mat)
area_anther_Asia_mat_hull <- chull(area_anther_Asia_mat)
area_anther_Australia_mat_hull <- chull(area_anther_Australia_mat)
area_anther_Europe_mat_hull <- chull(area_anther_Europe_mat)
area_anther_North_America_mat_hull <- chull(area_anther_North_America_mat)
area_anther_South_America_mat_hull <- chull(area_anther_South_America_mat)

area_anther_Africa_hull_mat<-area_anther_Africa_mat[c(area_anther_Africa_mat_hull,area_anther_Africa_mat_hull[1]),]  
area_anther_Asia_hull_mat<-area_anther_Asia_mat[c(area_anther_Asia_mat_hull,area_anther_Asia_mat_hull[1]),]  
area_anther_Australia_hull_mat<-area_anther_Australia_mat[c(area_anther_Australia_mat_hull,area_anther_Australia_mat_hull[1]),]  
area_anther_Europe_hull_mat<-area_anther_Europe_mat[c(area_anther_Europe_mat_hull,area_anther_Europe_mat_hull[1]),]  
area_anther_North_America_hull_mat<-area_anther_North_America_mat[c(area_anther_North_America_mat_hull,area_anther_North_America_mat_hull[1]),]  
area_anther_South_America_hull_mat<-area_anther_South_America_mat[c(area_anther_South_America_mat_hull,area_anther_South_America_mat_hull[1]),]  

area_anther_Africa_poly <- st_polygon(list(area_anther_Africa_hull_mat))
area_anther_Asia_poly <- st_polygon(list(area_anther_Asia_hull_mat))
area_anther_Australia_poly <- st_polygon(list(area_anther_Australia_hull_mat))
area_anther_Europe_poly <- st_polygon(list(area_anther_Europe_hull_mat))
area_anther_North_America_poly <- st_polygon(list(area_anther_North_America_hull_mat))
area_anther_South_America_poly <- st_polygon(list(area_anther_South_America_hull_mat))

#int_Africa_Asia <- st_intersection(area_anther_Africa_poly, area_anther_Asia_poly)
#plot(1,1,ylim=c(-0.6,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_Africa_poly,add=T, col="blue")
#plot(area_anther_Asia_poly,add=T, col="green")
#plot(int_Africa_Asia,add=T, col="red")

### Africa vs Asia
b <- st_sfc(area_anther_Africa_poly, area_anther_Asia_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_Africa","area_anther_Asia")
areas_per_group<-cbind(overlap$area_anther_Africa[1],overlap$area_anther_Asia[2],overlap$area_anther_Africa[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_Africa_Asia <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","Africa","Asia","shared"))
areas_per_group_anther_Africa_Asia$shared <- paste0(areas_per_group_anther_Africa_Asia$shared," (",areas_per_group_percent,"%)")

#int_Africa_Australia <- st_intersection(area_anther_Africa_poly, area_anther_Australia_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_Africa_poly,add=T, col="blue")
#plot(area_anther_Australia_poly,add=T, col="green")
#plot(int_Africa_Australia,add=T, col="red")

### Africa vs Australia
b <- st_sfc(area_anther_Africa_poly, area_anther_Australia_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_Africa","area_anther_Australia")
areas_per_group<-cbind(overlap$area_anther_Africa[1],overlap$area_anther_Australia[2],overlap$area_anther_Africa[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_Africa_Australia <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","Africa","Australia","shared"))
areas_per_group_anther_Africa_Australia$shared <- paste0(areas_per_group_anther_Africa_Australia$shared," (",areas_per_group_percent,"%)")

#int_Africa_Europe <- st_intersection(area_anther_Africa_poly, area_anther_Europe_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_Africa_poly,add=T, col="blue")
#plot(area_anther_Europe_poly,add=T, col="green")
#plot(int_Africa_Europe,add=T, col="red")

### Africa vs Europe
b <- st_sfc(area_anther_Africa_poly, area_anther_Europe_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_Africa","area_anther_Europe")
areas_per_group<-cbind(overlap$area_anther_Africa[1],overlap$area_anther_Europe[2],overlap$area_anther_Africa[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_Africa_Europe <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","Africa","Europe","shared"))
areas_per_group_anther_Africa_Europe$shared <- paste0(areas_per_group_anther_Africa_Europe$shared," (",areas_per_group_percent,"%)")

#int_Africa_Australia <- st_intersection(area_anther_Africa_poly, area_anther_Australia_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_Africa_poly,add=T, col="blue")
#plot(area_anther_Australia_poly,add=T, col="green")
#plot(int_Africa_Australia,add=T, col="red")

### Africa vs Australia
b <- st_sfc(area_anther_Africa_poly, area_anther_Australia_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_Africa","area_anther_Australia")
areas_per_group<-cbind(overlap$area_anther_Africa[1],overlap$area_anther_Australia[2],overlap$area_anther_Africa[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_Africa_Australia <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","Africa","Australia","shared"))
areas_per_group_anther_Africa_Australia$shared <- paste0(areas_per_group_anther_Africa_Australia$shared," (",areas_per_group_percent,"%)")

#int_Africa_North_America <- st_intersection(area_anther_Africa_poly, area_anther_North_America_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_Africa_poly,add=T, col="blue")
#plot(area_anther_North_America_poly,add=T, col="green")
#plot(int_Africa_North_America,add=T, col="red")

### Africa vs North_America
b <- st_sfc(area_anther_Africa_poly, area_anther_North_America_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_Africa","area_anther_North_America")
areas_per_group<-cbind(overlap$area_anther_Africa[1],overlap$area_anther_North_America[2],overlap$area_anther_Africa[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_Africa_North_America <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","Africa","North_America","shared"))
areas_per_group_anther_Africa_North_America$shared <- paste0(areas_per_group_anther_Africa_North_America$shared," (",areas_per_group_percent,"%)")

#int_Africa_South_America <- st_intersection(area_anther_Africa_poly, area_anther_South_America_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_Africa_poly,add=T, col="blue")
#plot(area_anther_South_America_poly,add=T, col="green")
#plot(int_Africa_South_America,add=T, col="red")

### Africa vs South_America
b <- st_sfc(area_anther_Africa_poly, area_anther_South_America_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_Africa","area_anther_South_America")
areas_per_group<-cbind(overlap$area_anther_Africa[1],overlap$area_anther_South_America[2],overlap$area_anther_Africa[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_Africa_South_America <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","Africa","South_America","shared"))
areas_per_group_anther_Africa_South_America$shared <- paste0(areas_per_group_anther_Africa_South_America$shared," (",areas_per_group_percent,"%)")

#int_Asia_Australia <- st_intersection(area_anther_Asia_poly, area_anther_Australia_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_Asia_poly,add=T, col="blue")
#plot(area_anther_Australia_poly,add=T, col="green")
#plot(int_Asia_Australia,add=T, col="red")

### Asia vs Australia
b <- st_sfc(area_anther_Asia_poly, area_anther_Australia_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_Asia","area_anther_Australia")
areas_per_group<-cbind(overlap$area_anther_Asia[1],overlap$area_anther_Australia[2],overlap$area_anther_Asia[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_Asia_Australia <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","Asia","Australia","shared"))
areas_per_group_anther_Asia_Australia$shared <- paste0(areas_per_group_anther_Asia_Australia$shared," (",areas_per_group_percent,"%)")

#int_Asia_Europe <- st_intersection(area_anther_Asia_poly, area_anther_Europe_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_Asia_poly,add=T, col="blue")
#plot(area_anther_Europe_poly,add=T, col="green")
#plot(int_Asia_Europe,add=T, col="red")

### Asia vs Europe
b <- st_sfc(area_anther_Asia_poly, area_anther_Europe_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_Asia","area_anther_Europe")
areas_per_group<-cbind(overlap$area_anther_Asia[1],overlap$area_anther_Europe[2],overlap$area_anther_Asia[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_Asia_Europe <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","Asia","Europe","shared"))
areas_per_group_anther_Asia_Europe$shared <- paste0(areas_per_group_anther_Asia_Europe$shared," (",areas_per_group_percent,"%)")

#int_Asia_North_America <- st_intersection(area_anther_Asia_poly, area_anther_North_America_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_Asia_poly,add=T, col="blue")
#plot(area_anther_North_America_poly,add=T, col="green")
#plot(int_Asia_North_America,add=T, col="red")

### Asia vs North_America
b <- st_sfc(area_anther_Asia_poly, area_anther_North_America_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_Asia","area_anther_North_America")
areas_per_group<-cbind(overlap$area_anther_Asia[1],overlap$area_anther_North_America[2],overlap$area_anther_Asia[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_Asia_North_America <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","Asia","North_America","shared"))
areas_per_group_anther_Asia_North_America$shared <- paste0(areas_per_group_anther_Asia_North_America$shared," (",areas_per_group_percent,"%)")

#int_Asia_South_America <- st_intersection(area_anther_Asia_poly, area_anther_South_America_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_Asia_poly,add=T, col="blue")
#plot(area_anther_South_America_poly,add=T, col="green")
#plot(int_Asia_South_America,add=T, col="red")

### Asia vs South_America
b <- st_sfc(area_anther_Asia_poly, area_anther_South_America_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_Asia","area_anther_South_America")
areas_per_group<-cbind(overlap$area_anther_Asia[1],overlap$area_anther_South_America[2],overlap$area_anther_Asia[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_Asia_South_America <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","Asia","South_America","shared"))
areas_per_group_anther_Asia_South_America$shared <- paste0(areas_per_group_anther_Asia_South_America$shared," (",areas_per_group_percent,"%)")

#int_Australia_Europe <- st_intersection(area_anther_Australia_poly, area_anther_Europe_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_Australia_poly,add=T, col="blue")
#plot(area_anther_Europe_poly,add=T, col="green")
#plot(int_Australia_Europe,add=T, col="red")

### Australia vs Europe
b <- st_sfc(area_anther_Australia_poly, area_anther_Europe_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_Australia","area_anther_Europe")
areas_per_group<-cbind(overlap$area_anther_Australia[1],overlap$area_anther_Europe[2],overlap$area_anther_Australia[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_Australia_Europe <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","Australia","Europe","shared"))
areas_per_group_anther_Australia_Europe$shared <- paste0(areas_per_group_anther_Australia_Europe$shared," (",areas_per_group_percent,"%)")

#int_Australia_North_America <- st_intersection(area_anther_Australia_poly, area_anther_North_America_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_Australia_poly,add=T, col="blue")
#plot(area_anther_North_America_poly,add=T, col="green")
#plot(int_Australia_North_America,add=T, col="red")

### Australia vs North_America
b <- st_sfc(area_anther_Australia_poly, area_anther_North_America_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_Australia","area_anther_North_America")
areas_per_group<-cbind(overlap$area_anther_Australia[1],overlap$area_anther_North_America[2],overlap$area_anther_Australia[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_Australia_North_America <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","Australia","North_America","shared"))
areas_per_group_anther_Australia_North_America$shared <- paste0(areas_per_group_anther_Australia_North_America$shared," (",areas_per_group_percent,"%)")

#int_Australia_South_America <- st_intersection(area_anther_Australia_poly, area_anther_South_America_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_Australia_poly,add=T, col="blue")
#plot(area_anther_South_America_poly,add=T, col="green")
#plot(int_Australia_South_America,add=T, col="red")

### Australia vs South_America
b <- st_sfc(area_anther_Australia_poly, area_anther_South_America_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_Australia","area_anther_South_America")
areas_per_group<-cbind(overlap$area_anther_Australia[1],overlap$area_anther_South_America[2],overlap$area_anther_Australia[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_Australia_South_America <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","Australia","South_America","shared"))
areas_per_group_anther_Australia_South_America$shared <- paste0(areas_per_group_anther_Australia_South_America$shared," (",areas_per_group_percent,"%)")

#int_Europe_North_America <- st_intersection(area_anther_Europe_poly, area_anther_North_America_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_Europe_poly,add=T, col="blue")
#plot(area_anther_North_America_poly,add=T, col="green")
#plot(int_Europe_North_America,add=T, col="red")

### Europe vs North_America
b <- st_sfc(area_anther_Europe_poly, area_anther_North_America_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_Europe","area_anther_North_America")
areas_per_group<-cbind(overlap$area_anther_Europe[1],overlap$area_anther_North_America[2],overlap$area_anther_Europe[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_Europe_North_America <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","Europe","North_America","shared"))
areas_per_group_anther_Europe_North_America$shared <- paste0(areas_per_group_anther_Europe_North_America$shared," (",areas_per_group_percent,"%)")

#int_Europe_South_America <- st_intersection(area_anther_Europe_poly, area_anther_South_America_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_Europe_poly,add=T, col="blue")
#plot(area_anther_South_America_poly,add=T, col="green")
#plot(int_Europe_South_America,add=T, col="red")

### Europe vs South_America
b <- st_sfc(area_anther_Europe_poly, area_anther_South_America_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_Europe","area_anther_South_America")
areas_per_group<-cbind(overlap$area_anther_Europe[1],overlap$area_anther_South_America[2],overlap$area_anther_Europe[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_Europe_South_America <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","Europe","South_America","shared"))
areas_per_group_anther_Europe_South_America$shared <- paste0(areas_per_group_anther_Europe_South_America$shared," (",areas_per_group_percent,"%)")

#int_North_America_South_America <- st_intersection(area_anther_North_America_poly, area_anther_South_America_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_North_America_poly,add=T, col="blue")
#plot(area_anther_South_America_poly,add=T, col="green")
#plot(int_North_America_South_America,add=T, col="red")

### North_America vs South_America
b <- st_sfc(area_anther_North_America_poly, area_anther_South_America_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_North_America","area_anther_South_America")
areas_per_group<-cbind(overlap$area_anther_North_America[1],overlap$area_anther_South_America[2],overlap$area_anther_North_America[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_North_America_South_America <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","North_America","South_America","shared"))
areas_per_group_anther_North_America_South_America$shared <- paste0(areas_per_group_anther_North_America_South_America$shared," (",areas_per_group_percent,"%)")

```

```{r, label="area of morphospace anther by pollinator", echo=FALSE, cache=FALSE, message=FALSE, warning=FALSE}

area_anther_honeyeater<-subset(pcs_anther,pcs_anther$pollinator_referenced=="honeyeater")
area_anther_hummingbird<-subset(pcs_anther,pcs_anther$pollinator_referenced=="hummingbird")
area_anther_insect<-subset(pcs_anther,pcs_anther$pollinator_referenced=="insect")
area_anther_sunbird<-subset(pcs_anther,pcs_anther$pollinator_referenced=="sunbird")
area_anther_lepidoptera<-subset(pcs_anther,pcs_anther$pollinator_referenced=="lepidoptera")
area_anther_long_proboscid_fly<-subset(pcs_anther,pcs_anther$pollinator_referenced=="long_proboscid_fly")
area_anther_wind<-subset(pcs_anther,pcs_anther$pollinator_referenced=="wind")
area_anther_hummingbird_OW<-subset(pcs_anther,pcs_anther$pollinator_referenced=="hummingbird_OW")

###

area_anther_honeyeater_mat <- as.matrix(area_anther_honeyeater[c(10:11)])
area_anther_hummingbird_mat <- as.matrix(area_anther_hummingbird[c(10:11)])
area_anther_insect_mat <- as.matrix(area_anther_insect[c(10:11)])
area_anther_sunbird_mat <- as.matrix(area_anther_sunbird[c(10:11)])
area_anther_lepidoptera_mat <- as.matrix(area_anther_lepidoptera[c(10:11)])
area_anther_long_proboscid_fly_mat <- as.matrix(area_anther_long_proboscid_fly[c(10:11)])
area_anther_wind_mat <- as.matrix(area_anther_wind[c(10:11)])
area_anther_hummingbird_OW_mat <- as.matrix(area_anther_hummingbird_OW[c(10:11)])

###

area_anther_honeyeater_mat_hull <- chull(area_anther_honeyeater_mat)
area_anther_hummingbird_mat_hull <- chull(area_anther_hummingbird_mat)
area_anther_insect_mat_hull <- chull(area_anther_insect_mat)
area_anther_sunbird_mat_hull <- chull(area_anther_sunbird_mat)
area_anther_lepidoptera_mat_hull <- chull(area_anther_lepidoptera_mat)
area_anther_long_proboscid_fly_mat_hull <- chull(area_anther_long_proboscid_fly_mat)
area_anther_wind_mat_hull <- chull(area_anther_wind_mat)
area_anther_hummingbird_OW_mat_hull <- chull(area_anther_hummingbird_OW_mat)

area_anther_honeyeater_hull_mat<-area_anther_honeyeater_mat[c(area_anther_honeyeater_mat_hull,area_anther_honeyeater_mat_hull[1]),]  
area_anther_hummingbird_hull_mat<-area_anther_hummingbird_mat[c(area_anther_hummingbird_mat_hull,area_anther_hummingbird_mat_hull[1]),]  
area_anther_insect_hull_mat<-area_anther_insect_mat[c(area_anther_insect_mat_hull,area_anther_insect_mat_hull[1]),]  
area_anther_sunbird_hull_mat<-area_anther_sunbird_mat[c(area_anther_sunbird_mat_hull,area_anther_sunbird_mat_hull[1]),]  
area_anther_lepidoptera_hull_mat<-area_anther_lepidoptera_mat[c(area_anther_lepidoptera_mat_hull,area_anther_lepidoptera_mat_hull[1]),]
area_anther_long_proboscid_fly_hull_mat<-area_anther_long_proboscid_fly_mat[c(area_anther_long_proboscid_fly_mat_hull,area_anther_long_proboscid_fly_mat_hull[1]),]  
area_anther_wind_hull_mat<-area_anther_wind_mat[c(area_anther_wind_mat_hull,area_anther_wind_mat_hull[1]),]  
area_anther_hummingbird_OW_hull_mat<-area_anther_hummingbird_OW_mat[c(area_anther_hummingbird_OW_mat_hull,area_anther_hummingbird_OW_mat_hull[1]),]  

###

area_anther_honeyeater_poly <- st_polygon(list(area_anther_honeyeater_hull_mat))
area_anther_hummingbird_poly <- st_polygon(list(area_anther_hummingbird_hull_mat))
area_anther_insect_poly <- st_polygon(list(area_anther_insect_hull_mat))
area_anther_sunbird_poly <- st_polygon(list(area_anther_sunbird_hull_mat))
area_anther_lepidoptera_poly <- st_polygon(list(area_anther_lepidoptera_hull_mat))
area_anther_long_proboscid_fly_poly <- st_polygon(list(area_anther_long_proboscid_fly_hull_mat))
area_anther_wind_poly <- st_polygon(list(area_anther_wind_hull_mat))
area_anther_hummingbird_OW_poly <- st_polygon(list(area_anther_hummingbird_OW_hull_mat))

### honeyeater vs hummingbird
### honeyeater vs insect
### honeyeater vs sunbird
### honeyeater vs lepidoptera
### honeyeater vs long_proboscid_fly
### honeyeater vs wind
### honeyeater vs hummingbird_OW

### hummingbird vs insect
### hummingbird vs sunbird
### hummingbird vs lepidoptera
### hummingbird vs long_proboscid_fly
### hummingbird vs wind
### hummingbird vs hummingbird_OW

### insect vs sunbird
### insect vs lepidoptera
### insect vs long_proboscid_fly
### insect vs wind
### insect vs hummingbird_OW

### sunbird vs lepidoptera
### sunbird vs long_proboscid_fly
### sunbird vs wind
### sunbird vs hummingbird_OW

### lepidoptera vs long_proboscid_fly
### lepidoptera vs wind
### lepidoptera vs hummingbird_OW

### long_proboscid_fly vs wind
### long_proboscid_fly vs hummingbird_OW

### hummingbird_OW vs wind

### honeyeater vs hummingbird
b <- st_sfc(area_anther_honeyeater_poly, area_anther_hummingbird_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_honeyeater","area_anther_hummingbird")
areas_per_group<-cbind(overlap$area_anther_honeyeater[1],overlap$area_anther_hummingbird[2],overlap$area_anther_honeyeater[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_honeyeater_hummingbird <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","honeyeater","hummingbird","shared"))
areas_per_group_anther_honeyeater_hummingbird$shared <- paste0(areas_per_group_anther_honeyeater_hummingbird$shared," (",areas_per_group_percent,"%)")

### honeyeater vs insect
b <- st_sfc(area_anther_honeyeater_poly, area_anther_insect_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_honeyeater","area_anther_insect")
areas_per_group<-cbind(overlap$area_anther_honeyeater[1],overlap$area_anther_insect[2],overlap$area_anther_honeyeater[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_honeyeater_insect <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","honeyeater","insect","shared"))
areas_per_group_anther_honeyeater_insect$shared <- paste0(areas_per_group_anther_honeyeater_insect$shared," (",areas_per_group_percent,"%)")

#int_honeyeater_sunbird <- st_intersection(area_anther_honeyeater_poly, area_anther_sunbird_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_honeyeater_poly,add=T, col="blue")
#plot(area_anther_sunbird_poly,add=T, col="green")
#plot(int_honeyeater_sunbird,add=T, col="red")

### honeyeater vs sunbird
b <- st_sfc(area_anther_honeyeater_poly, area_anther_sunbird_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_honeyeater","area_anther_sunbird")
areas_per_group<-cbind(overlap$area_anther_honeyeater[1],overlap$area_anther_sunbird[2],overlap$area_anther_honeyeater[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_honeyeater_sunbird <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","honeyeater","sunbird","shared"))
areas_per_group_anther_honeyeater_sunbird$shared <- paste0(areas_per_group_anther_honeyeater_sunbird$shared," (",areas_per_group_percent,"%)")

### honeyeater vs lepidoptera
b <- st_sfc(area_anther_honeyeater_poly, area_anther_lepidoptera_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_honeyeater","area_anther_lepidoptera")
areas_per_group<-cbind(overlap$area_anther_honeyeater[1],overlap$area_anther_lepidoptera[2],overlap$area_anther_honeyeater[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_honeyeater_lepidoptera <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","honeyeater","lepidoptera","shared"))
areas_per_group_anther_honeyeater_lepidoptera$shared <- paste0(areas_per_group_anther_honeyeater_lepidoptera$shared," (",areas_per_group_percent,"%)")

# int_honeyeater_lepidoptera <- st_intersection(area_anther_honeyeater_poly, area_anther_lepidoptera_poly)
# plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
# plot(area_anther_honeyeater_poly,add=T, col="blue")
# plot(area_anther_lepidoptera_poly,add=T, col="green")
# plot(int_honeyeater_lepidoptera,add=T, col="red")

### honeyeater vs long_proboscid_fly
b <- st_sfc(area_anther_honeyeater_poly, area_anther_long_proboscid_fly_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_honeyeater","area_anther_long_proboscid_fly")
areas_per_group<-cbind(overlap$area_anther_honeyeater[1],overlap$area_anther_long_proboscid_fly[2],overlap$area_anther_honeyeater[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_honeyeater_long_proboscid_fly <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","honeyeater","long_proboscid_fly","shared"))
areas_per_group_anther_honeyeater_long_proboscid_fly$shared <- paste0(areas_per_group_anther_honeyeater_long_proboscid_fly$shared," (",areas_per_group_percent,"%)")

### honeyeater vs wind
b <- st_sfc(area_anther_honeyeater_poly, area_anther_wind_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_honeyeater","area_anther_wind")
areas_per_group<-cbind(overlap$area_anther_honeyeater[1],overlap$area_anther_wind[2],overlap$area_anther_honeyeater[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_honeyeater_wind <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","honeyeater","wind","shared"))
areas_per_group_anther_honeyeater_wind$shared <- paste0(areas_per_group_anther_honeyeater_wind$shared," (",areas_per_group_percent,"%)")

### honeyeater vs hummingbird_OW
b <- st_sfc(area_anther_honeyeater_poly, area_anther_hummingbird_OW_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_honeyeater","area_anther_hummingbird_OW")
areas_per_group<-cbind(overlap$area_anther_honeyeater[1],overlap$area_anther_hummingbird_OW[2],overlap$area_anther_honeyeater[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_honeyeater_hummingbird_OW <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","honeyeater","hummingbird_OW","shared"))
areas_per_group_anther_honeyeater_hummingbird_OW$shared <- paste0(areas_per_group_anther_honeyeater_hummingbird_OW$shared," (",areas_per_group_percent,"%)")

#int_hummingbird_insect <- st_intersection(area_anther_hummingbird_poly, area_anther_insect_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_hummingbird_poly,add=T, col="blue")
#plot(area_anther_insect_poly,add=T, col="green")
#plot(int_hummingbird_insect,add=T, col="red")

### hummingbird vs insect
b <- st_sfc(area_anther_hummingbird_poly, area_anther_insect_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_hummingbird","area_anther_insect")
areas_per_group<-cbind(overlap$area_anther_hummingbird[1],overlap$area_anther_insect[2],overlap$area_anther_hummingbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_hummingbird_insect <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","hummingbird","insect","shared"))
areas_per_group_anther_hummingbird_insect$shared <- paste0(areas_per_group_anther_hummingbird_insect$shared," (",areas_per_group_percent,"%)")

#int_hummingbird_sunbird <- st_intersection(area_anther_hummingbird_poly, area_anther_sunbird_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_hummingbird_poly,add=T, col="blue")
#plot(area_anther_sunbird_poly,add=T, col="green")
#plot(int_hummingbird_sunbird,add=T, col="red")

### hummingbird vs sunbird
b <- st_sfc(area_anther_hummingbird_poly, area_anther_sunbird_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_hummingbird","area_anther_sunbird")
areas_per_group<-cbind(overlap$area_anther_hummingbird[1],overlap$area_anther_sunbird[2],overlap$area_anther_hummingbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_hummingbird_sunbird <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","hummingbird","sunbird","shared"))
areas_per_group_anther_hummingbird_sunbird$shared <- paste0(areas_per_group_anther_hummingbird_sunbird$shared," (",areas_per_group_percent,"%)")

#int_insect_sunbird <- st_intersection(area_anther_insect_poly, area_anther_sunbird_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_insect_poly,add=T, col="blue")
#plot(area_anther_sunbird_poly,add=T, col="green")
#plot(int_insect_sunbird,add=T, col="red")

### hummingbird vs lepidoptera
b <- st_sfc(area_anther_hummingbird_poly, area_anther_lepidoptera_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_hummingbird","area_anther_lepidoptera")
areas_per_group<-cbind(overlap$area_anther_hummingbird[1],overlap$area_anther_lepidoptera[2],overlap$area_anther_hummingbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_hummingbird_lepidoptera <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","hummingbird","lepidoptera","shared"))
areas_per_group_anther_hummingbird_lepidoptera$shared <- paste0(areas_per_group_anther_hummingbird_lepidoptera$shared," (",areas_per_group_percent,"%)")

### hummingbird vs long_proboscid_fly
b <- st_sfc(area_anther_hummingbird_poly, area_anther_long_proboscid_fly_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_hummingbird","area_anther_long_proboscid_fly")
areas_per_group<-cbind(overlap$area_anther_hummingbird[1],overlap$area_anther_long_proboscid_fly[2],overlap$area_anther_hummingbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_hummingbird_long_proboscid_fly <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","hummingbird","long_proboscid_fly","shared"))
areas_per_group_anther_hummingbird_long_proboscid_fly$shared <- paste0(areas_per_group_anther_hummingbird_long_proboscid_fly$shared," (",areas_per_group_percent,"%)")

### hummingbird vs wind
b <- st_sfc(area_anther_hummingbird_poly, area_anther_wind_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_hummingbird","area_anther_wind")
areas_per_group<-cbind(overlap$area_anther_hummingbird[1],overlap$area_anther_wind[2],overlap$area_anther_hummingbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_hummingbird_wind <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","hummingbird","wind","shared"))
areas_per_group_anther_hummingbird_wind$shared <- paste0(areas_per_group_anther_hummingbird_wind$shared," (",areas_per_group_percent,"%)")

### hummingbird vs hummingbird_OW
b <- st_sfc(area_anther_hummingbird_poly, area_anther_hummingbird_OW_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_hummingbird","area_anther_hummingbird_OW")
areas_per_group<-cbind(overlap$area_anther_hummingbird[1],overlap$area_anther_hummingbird_OW[2],overlap$area_anther_hummingbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_hummingbird_hummingbird_OW <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","hummingbird","hummingbird_OW","shared"))
areas_per_group_anther_hummingbird_hummingbird_OW$shared <- paste0(areas_per_group_anther_hummingbird_hummingbird_OW$shared," (",areas_per_group_percent,"%)")


### insect vs sunbird
b <- st_sfc(area_anther_insect_poly, area_anther_sunbird_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_insect","area_anther_sunbird")
areas_per_group<-cbind(overlap$area_anther_insect[1],overlap$area_anther_sunbird[2],overlap$area_anther_insect[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_insect_sunbird <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","insect","sunbird","shared"))
areas_per_group_anther_insect_sunbird$shared <- paste0(areas_per_group_anther_insect_sunbird$shared," (",areas_per_group_percent,"%)")

#int_insect_North_America <- st_intersection(area_anther_insect_poly, area_anther_North_America_poly)
#plot(1,1,ylim=c(-0.7,0.4),xlim=c(-0.7,0.5), t="n", xlab="", ylab="")
#plot(area_anther_insect_poly,add=T, col="blue")
#plot(area_anther_North_America_poly,add=T, col="green")
#plot(int_insect_North_America,add=T, col="red")

### insect vs lepidoptera
b <- st_sfc(area_anther_insect_poly, area_anther_lepidoptera_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_insect","area_anther_lepidoptera")
areas_per_group<-cbind(overlap$area_anther_insect[1],overlap$area_anther_lepidoptera[2],overlap$area_anther_insect[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_insect_lepidoptera <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","insect","lepidoptera","shared"))
areas_per_group_anther_insect_lepidoptera$shared <- paste0(areas_per_group_anther_insect_lepidoptera$shared," (",areas_per_group_percent,"%)")

### insect vs long_proboscid_fly
b <- st_sfc(area_anther_insect_poly, area_anther_long_proboscid_fly_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_insect","area_anther_long_proboscid_fly")
areas_per_group<-cbind(overlap$area_anther_insect[1],overlap$area_anther_long_proboscid_fly[2],overlap$area_anther_insect[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_insect_long_proboscid_fly <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","insect","long_proboscid_fly","shared"))
areas_per_group_anther_insect_long_proboscid_fly$shared <- paste0(areas_per_group_anther_insect_long_proboscid_fly$shared," (",areas_per_group_percent,"%)")

### insect vs wind
b <- st_sfc(area_anther_insect_poly, area_anther_wind_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_insect","area_anther_wind")
areas_per_group<-cbind(overlap$area_anther_insect[1],overlap$area_anther_wind[2],overlap$area_anther_insect[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_insect_wind <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","insect","wind","shared"))
areas_per_group_anther_insect_wind$shared <- paste0(areas_per_group_anther_insect_wind$shared," (",areas_per_group_percent,"%)")

### insect vs hummingbird_OW
b <- st_sfc(area_anther_insect_poly, area_anther_hummingbird_OW_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_insect","area_anther_hummingbird_OW")
areas_per_group<-cbind(overlap$area_anther_insect[1],overlap$area_anther_hummingbird_OW[2],overlap$area_anther_insect[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_insect_hummingbird_OW <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","insect","hummingbird_OW","shared"))
areas_per_group_anther_insect_hummingbird_OW$shared <- paste0(areas_per_group_anther_insect_hummingbird_OW$shared," (",areas_per_group_percent,"%)")


### sunbird vs lepidoptera
b <- st_sfc(area_anther_sunbird_poly, area_anther_lepidoptera_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_sunbird","area_anther_lepidoptera")
areas_per_group<-cbind(overlap$area_anther_sunbird[1],overlap$area_anther_lepidoptera[2],overlap$area_anther_sunbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_sunbird_lepidoptera <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","sunbird","lepidoptera","shared"))
areas_per_group_anther_sunbird_lepidoptera$shared <- paste0(areas_per_group_anther_sunbird_lepidoptera$shared," (",areas_per_group_percent,"%)")

### sunbird vs long_proboscid_fly
b <- st_sfc(area_anther_sunbird_poly, area_anther_long_proboscid_fly_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_sunbird","area_anther_long_proboscid_fly")
areas_per_group<-cbind(overlap$area_anther_sunbird[1],overlap$area_anther_long_proboscid_fly[2],overlap$area_anther_sunbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_sunbird_long_proboscid_fly <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","sunbird","long_proboscid_fly","shared"))
areas_per_group_anther_sunbird_long_proboscid_fly$shared <- paste0(areas_per_group_anther_sunbird_long_proboscid_fly$shared," (",areas_per_group_percent,"%)")

### sunbird vs wind
b <- st_sfc(area_anther_sunbird_poly, area_anther_wind_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_sunbird","area_anther_wind")
areas_per_group<-cbind(overlap$area_anther_sunbird[1],overlap$area_anther_wind[2],overlap$area_anther_sunbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_sunbird_wind <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","sunbird","wind","shared"))
areas_per_group_anther_sunbird_wind$shared <- paste0(areas_per_group_anther_sunbird_wind$shared," (",areas_per_group_percent,"%)")

### sunbird vs hummingbird_OW
b <- st_sfc(area_anther_sunbird_poly, area_anther_hummingbird_OW_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_sunbird","area_anther_hummingbird_OW")
areas_per_group<-cbind(overlap$area_anther_sunbird[1],overlap$area_anther_hummingbird_OW[2],overlap$area_anther_sunbird[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_sunbird_hummingbird_OW <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","sunbird","hummingbird_OW","shared"))
areas_per_group_anther_sunbird_hummingbird_OW$shared <- paste0(areas_per_group_anther_sunbird_hummingbird_OW$shared," (",areas_per_group_percent,"%)")

### lepidoptera vs long_proboscid_fly
b <- st_sfc(area_anther_lepidoptera_poly, area_anther_long_proboscid_fly_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_lepidoptera","area_anther_long_proboscid_fly")
areas_per_group<-cbind(overlap$area_anther_lepidoptera[1],overlap$area_anther_long_proboscid_fly[2],overlap$area_anther_lepidoptera[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_lepidoptera_long_proboscid_fly <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","lepidoptera","long_proboscid_fly","shared"))
areas_per_group_anther_lepidoptera_long_proboscid_fly$shared <- paste0(areas_per_group_anther_lepidoptera_long_proboscid_fly$shared," (",areas_per_group_percent,"%)")

### lepidoptera vs wind
b <- st_sfc(area_anther_lepidoptera_poly, area_anther_wind_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_lepidoptera","area_anther_wind")
areas_per_group<-cbind(overlap$area_anther_lepidoptera[1],overlap$area_anther_wind[2],overlap$area_anther_lepidoptera[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_lepidoptera_wind <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","lepidoptera","wind","shared"))
areas_per_group_anther_lepidoptera_wind$shared <- paste0(areas_per_group_anther_lepidoptera_wind$shared," (",areas_per_group_percent,"%)")

### lepidoptera vs hummingbird_OW
b <- st_sfc(area_anther_lepidoptera_poly, area_anther_hummingbird_OW_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_lepidoptera","area_anther_hummingbird_OW")
areas_per_group<-cbind(overlap$area_anther_lepidoptera[1],overlap$area_anther_hummingbird_OW[2],overlap$area_anther_lepidoptera[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_lepidoptera_hummingbird_OW <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","lepidoptera","hummingbird_OW","shared"))
areas_per_group_anther_lepidoptera_hummingbird_OW$shared <- paste0(areas_per_group_anther_lepidoptera_hummingbird_OW$shared," (",areas_per_group_percent,"%)")

### long_proboscid_fly vs wind
b <- st_sfc(area_anther_long_proboscid_fly_poly, area_anther_wind_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_long_proboscid_fly","area_anther_wind")
areas_per_group<-cbind(overlap$area_anther_long_proboscid_fly[1],overlap$area_anther_wind[2],overlap$area_anther_long_proboscid_fly[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_long_proboscid_fly_wind <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","long_proboscid_fly","wind","shared"))
areas_per_group_anther_long_proboscid_fly_wind$shared <- paste0(areas_per_group_anther_long_proboscid_fly_wind$shared," (",areas_per_group_percent,"%)")

### long_proboscid_fly vs hummingbird_OW
b <- st_sfc(area_anther_long_proboscid_fly_poly, area_anther_hummingbird_OW_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_long_proboscid_fly","area_anther_hummingbird_OW")
areas_per_group<-cbind(overlap$area_anther_long_proboscid_fly[1],overlap$area_anther_hummingbird_OW[2],overlap$area_anther_long_proboscid_fly[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_long_proboscid_fly_hummingbird_OW <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","long_proboscid_fly","hummingbird_OW","shared"))
areas_per_group_anther_long_proboscid_fly_hummingbird_OW$shared <- paste0(areas_per_group_anther_long_proboscid_fly_hummingbird_OW$shared," (",areas_per_group_percent,"%)")

### hummingbird_OW vs wind
b <- st_sfc(area_anther_hummingbird_OW_poly, area_anther_wind_poly)
areas <- lapply( b, function(x) { 
  lapply(b, function(y) st_intersection(x,y) %>% st_area())})
overlap <- matrix(unlist(areas), ncol = length(b), byrow = TRUE) %>%  data.frame()
colnames(overlap) <- c("area_anther_hummingbird_OW","area_anther_wind")
areas_per_group<-cbind(overlap$area_anther_hummingbird_OW[1],overlap$area_anther_wind[2],overlap$area_anther_hummingbird_OW[2])
areas_per_group <- round(areas_per_group,5)
areas_per_group_percent <-  areas_per_group[1] + areas_per_group[2] - areas_per_group[3] 
areas_per_group_percent <- round(areas_per_group[3] / areas_per_group_percent * 100,1)
areas_per_group_anther_hummingbird_OW_wind <- cbind("anther",areas_per_group) %>% data.frame() %>% setNames(c("variable","hummingbird_OW","wind","shared"))
areas_per_group_anther_hummingbird_OW_wind$shared <- paste0(areas_per_group_anther_hummingbird_OW_wind$shared," (",areas_per_group_percent,"%)")
```

```{r, label="unite all data corolla", cache=TRUE, echo=FALSE, message=FALSE, warning=FALSE,eval=T}
### Now we unite all the data
pcs_flowers_unique <- pcs_corolla[c(2,13:15)]
colnames(pcs_flowers_unique)[2:4] <- c("PC1_corolla", "PC2_corolla","PC3_corolla")

spp_measurements <- data.frame(data_reduced$species)
colnames(spp_measurements) <- "species"

spp_corollas <- data.frame(pcs_flowers_unique$species)
colnames(spp_corollas) <- "species"

spp_all <- unique(rbind(spp_measurements,spp_corollas))

all_data <- join(spp_all,
                data_reduced,
                 by = "species", match = "first") 

all_data <- join(all_data,
                pcs_flowers_unique,
                 by = "species", match = "first") 

### Log transform the sizes

#all_data$corolla_tube_length[all_data$corolla_tube_length == "0"] <- 0.001
#all_data[2:3] <- log(all_data[2:3])

all_data <- all_data[rowSums(is.na(all_data))!=6, ]

##### Add the groups

all_data <- left_join(all_data, pollinators[c(1,3:5)],"species")
all_data <- left_join(all_data, measurements[c(1:4)],"species")

continents_corolla <- pcs_corolla[c(2,4)]
continents_anther <- pcs_anther[c(2,4)]
continents <- rbind(continents_corolla,continents_anther) %>% unique()
continents2 <- measurements[c(1,41)]
colnames(continents2)[2] <- "continent"
continents <- rbind(continents,continents2) %>% unique
all_data <- join(all_data, continents,"species", match="f") # add continent

rownames(all_data) <- all_data[,1]
```

```{r, label="unite anther data", cache=TRUE, echo=FALSE, message=FALSE, warning=FALSE,eval=T}
### Now we unite all the data

pcs_anthers_unique <- pcs_anther[c(2,10:12)]
colnames(pcs_anthers_unique)[2:4] <- c("PC1_anthers", "PC2_anthers","PC3_anthers")

spp_measurements <- data.frame(measurements_anthers$species)
colnames(spp_measurements) <- "species"

spp_anthers<- data.frame(pcs_anthers_unique$species)
colnames(spp_anthers) <- "species"

spp_all_anthers <- unique(rbind(spp_measurements,spp_anthers))

all_data_anthers <- join(spp_all_anthers,
                         measurements_anthers,
                 by = "species", match = "first") 

all_data_anthers <- join(all_data_anthers,
                 pcs_anthers_unique,
                 by = "species", match = "first") 

### Log transform the sizes

#all_data_anthers$corolla_tube_length[all_data_anthers$corolla_tube_length == "0"] <- 0.001
#all_data_anthers[2:3] <- log(all_data_anthers[2:3])

all_data_anthers <- all_data_anthers[rowSums(is.na(all_data_anthers))!=6, ]

##### Add the groups
subfamily <-  measurements[c(1,3)]
subfamily2 <-  pollinators[c(1,2)]
subfamily <- rbind(subfamily,subfamily2) %>% unique

all_data_anthers <- left_join(all_data_anthers, pollinators[c(1,3:5)],"species")
all_data_anthers <- left_join(all_data_anthers, subfamily,"species" )
all_data_anthers <- join(all_data_anthers, continents,"species", match="f") # add continent

rownames(all_data_anthers) <- all_data_anthers[,1]
```

```{r,label="make boxplots of shape", fig.height=4, fig.width=10, fig.align='center',echo=FALSE, cache=TRUE, message=FALSE, warning=FALSE,eval=T}
pcs_corolla_no_NA <- subset(pcs_corolla, !pollinator_referenced=="-")
pcs_corolla_no_NA <- droplevels(pcs_corolla_no_NA)

# Compare anther shape by continent
boxplot_corolla_PC1_continents <- ggplot(pcs_corolla, aes(x=continent, y=PC1, fill=continent)) 
boxplot_corolla_PC1_continents <- boxplot_corolla_PC1_continents + geom_boxplot(outlier.size = 0.5) + theme_bw()  + 
  theme(axis.title = element_blank(), axis.text=element_text(size=10,angle =45, hjust = 1)) + 
  guides(fill=FALSE) + ggtitle("Corolla shape (PC1)")
boxplot_corolla_PC1_continents <- boxplot_corolla_PC1_continents + scale_fill_manual(values=c("red","orange","purple","blue","green",
                               "forestgreen"))
boxplot_corolla_PC1_continents <- boxplot_corolla_PC1_continents +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
    theme(plot.title = element_text(size = 10))

boxplot_corolla_PC2_continents <- ggplot(pcs_corolla, aes(x=continent, y=PC2, fill=continent)) 
boxplot_corolla_PC2_continents <- boxplot_corolla_PC2_continents + geom_boxplot(outlier.size = 0.5) + theme_bw()  + 
  theme(axis.title = element_blank(), axis.text=element_text(size=10,angle =45, hjust = 1)) + 
  guides(fill=FALSE) + ggtitle("Corolla shape (PC2)")
boxplot_corolla_PC2_continents <- boxplot_corolla_PC2_continents + scale_fill_manual(values=c("red","orange","purple","blue","green",
                                                                                              "forestgreen"))
boxplot_corolla_PC2_continents <- boxplot_corolla_PC2_continents +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
    theme(plot.title = element_text(size = 10))

# Compare anther shape by pollinator
boxplot_corolla_PC1_pollinators <- ggplot(pcs_corolla_no_NA, aes(x=pollinator_referenced, y=PC1, fill=pollinator_referenced)) 
boxplot_corolla_PC1_pollinators <- boxplot_corolla_PC1_pollinators + geom_boxplot(outlier.size = 0.5) + theme_bw()  + 
  theme(axis.title = element_blank(), axis.text=element_text(size=10,angle =45, hjust = 1)) + 
  guides(fill=FALSE) + ggtitle("Corolla shape (PC1)")
boxplot_corolla_PC1_pollinators <- boxplot_corolla_PC1_pollinators + scale_fill_manual(values=c("orange","magenta","red","blue","black","gold","green","aquamarine"))

boxplot_corolla_PC1_pollinators <- boxplot_corolla_PC1_pollinators +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
    theme(plot.title = element_text(size = 10))

boxplot_corolla_PC2_pollinators <- ggplot(pcs_corolla_no_NA, aes(x=pollinator_referenced, y=PC2, fill=pollinator_referenced)) 
boxplot_corolla_PC2_pollinators <- boxplot_corolla_PC2_pollinators + geom_boxplot(outlier.size = 0.5) + theme_bw()  + 
  theme(axis.title = element_blank(), axis.text=element_text(size=10,angle =45, hjust = 1)) + 
  guides(fill=FALSE) + ggtitle("Corolla shape (PC2)")
boxplot_corolla_PC2_pollinators <- boxplot_corolla_PC2_pollinators + scale_fill_manual(values=c("orange","magenta","red","blue","black","gold","green","aquamarine"))

boxplot_corolla_PC2_pollinators <- boxplot_corolla_PC2_pollinators +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
    theme(plot.title = element_text(size = 10))

# Anther
pcs_anther_no_NA <- subset(pcs_anther, !pollinator_referenced=="-")
pcs_anther_no_NA <- droplevels(pcs_anther_no_NA)

boxplot_anther_PC1_continents <- ggplot(pcs_anther, aes(x=continent, y=PC1, fill=continent)) 
boxplot_anther_PC1_continents <- boxplot_anther_PC1_continents + geom_boxplot(outlier.size = 0.5) + theme_bw()  + 
  theme(axis.title = element_blank(), axis.text=element_text(size=10,angle =45, hjust = 1)) + 
  guides(fill=FALSE) + ggtitle("Anther shape (PC1)")
boxplot_anther_PC1_continents <- boxplot_anther_PC1_continents + scale_fill_manual(values=c("red","orange","purple","blue","green",
                                                                                              "forestgreen")) 
boxplot_anther_PC1_continents <- boxplot_anther_PC1_continents +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
    theme(plot.title = element_text(size = 10))

boxplot_anther_PC2_continents <- ggplot(pcs_anther, aes(x=continent, y=PC2, fill=continent)) 
boxplot_anther_PC2_continents <- boxplot_anther_PC2_continents + geom_boxplot(outlier.size = 0.5) + theme_bw()  + 
  theme(axis.title = element_blank(), axis.text=element_text(size=10,angle =45, hjust = 1)) + 
  guides(fill=FALSE) + ggtitle("Anther shape (PC2)")
boxplot_anther_PC2_continents <- boxplot_anther_PC2_continents + scale_fill_manual(values=c("red","orange","purple","blue","green",
                                                                                              "forestgreen"))
boxplot_anther_PC2_continents <- boxplot_anther_PC2_continents +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
    theme(plot.title = element_text(size = 10))

# Compare anther shape by pollinator
boxplot_anther_PC1_pollinators <- ggplot(pcs_anther_no_NA, aes(x=pollinator_referenced, y=PC1, fill=pollinator_referenced)) 
boxplot_anther_PC1_pollinators <- boxplot_anther_PC1_pollinators + geom_boxplot(outlier.size = 0.5) + theme_bw()  + 
  theme(axis.title = element_blank(), axis.text=element_text(size=10,angle =45, hjust = 1)) + 
  guides(fill=FALSE) + ggtitle("Anther shape (PC1)")
boxplot_anther_PC1_pollinators <- boxplot_anther_PC1_pollinators + scale_fill_manual(values=c("orange","magenta","red","blue","black","gold","green","aquamarine"))

boxplot_anther_PC1_pollinators <- boxplot_anther_PC1_pollinators +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
    theme(plot.title = element_text(size = 10))

boxplot_anther_PC2_pollinators <- ggplot(pcs_anther_no_NA, aes(x=pollinator_referenced, y=PC2, fill=pollinator_referenced)) 
boxplot_anther_PC2_pollinators <- boxplot_anther_PC2_pollinators + geom_boxplot(outlier.size = 0.5) + theme_bw()  + 
  theme(axis.title = element_blank(), axis.text=element_text(size=10,angle =45, hjust = 1)) + 
  guides(fill=FALSE) + ggtitle("Anther shape (PC2)")
boxplot_anther_PC2_pollinators <- boxplot_anther_PC2_pollinators + scale_fill_manual(values=c("orange","magenta","red","blue","black","gold","green","aquamarine"))

boxplot_anther_PC2_pollinators <- boxplot_anther_PC2_pollinators +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
    theme(plot.title = element_text(size = 10))

```

```{r,label="make boxplots of length", fig.height=4, fig.width=10, fig.align='center',echo=FALSE, cache=TRUE, message=FALSE, warning=FALSE,eval=T}
pcs_corolla_length_no_NA <- all_data[complete.cases(all_data$corolla_tube_length),]
pcs_corolla_length_no_NA <- pcs_corolla_length_no_NA[complete.cases(pcs_corolla_length_no_NA$continent),]
pcs_corolla_length_no_NA$continent <- droplevels(pcs_corolla_length_no_NA$continent)

spp <- unique(pcs_corolla_length_no_NA$species) %>% data.frame()

# Compare anther shape by continent
boxplot_corolla_length_continents <- ggplot(pcs_corolla_length_no_NA, aes(x=continent, y=corolla_tube_length, fill=continent)) 
boxplot_corolla_length_continents <- boxplot_corolla_length_continents + geom_boxplot(outlier.size = 0.5) + theme_bw()  + 
  theme(axis.title = element_blank(), axis.text=element_text(size=10,angle =45, hjust = 1)) + 
  guides(fill=FALSE) + ggtitle("Corolla length")
boxplot_corolla_length_continents <- boxplot_corolla_length_continents + scale_fill_manual(values=c("red","orange","purple","blue","green","forestgreen"))
boxplot_corolla_length_continents <- boxplot_corolla_length_continents +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  theme(plot.title = element_text(size = 10))

# Compare anther shape by pollinator

pcs_corolla_length_no_NA <- subset(pcs_corolla_length_no_NA, !pollinator_referenced=="-")

boxplot_corolla_length_pollinators <- ggplot(pcs_corolla_length_no_NA, aes(x=pollinator_referenced, y=corolla_tube_length, fill=pollinator_referenced)) 
boxplot_corolla_length_pollinators <- boxplot_corolla_length_pollinators + geom_boxplot(outlier.size = 0.5) + theme_bw()  + 
  theme(axis.title = element_blank(), axis.text=element_text(size=10,angle =45, hjust = 1)) + 
  guides(fill=FALSE) + ggtitle("Corolla length")
boxplot_corolla_length_pollinators <- boxplot_corolla_length_pollinators + scale_fill_manual(values=c("orange","magenta","red","blue","black","gold","green","aquamarine"))

boxplot_corolla_length_pollinators <- boxplot_corolla_length_pollinators +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  theme(plot.title = element_text(size = 10))

# Anther
pcs_anther_length_no_NA <- all_data_anthers[complete.cases(all_data_anthers$total_large_anther_length),]
pcs_anther_length_no_NA <- pcs_anther_length_no_NA[complete.cases(pcs_anther_length_no_NA$continent),]
pcs_anther_length_no_NA <- droplevels(pcs_anther_length_no_NA)

spp <- unique(pcs_corolla_length_no_NA$species) %>% data.frame()

boxplot_anther_length_continents <- ggplot(pcs_anther_length_no_NA, aes(x=continent, y=total_large_anther_length, fill=continent)) 
boxplot_anther_length_continents <- boxplot_anther_length_continents + geom_boxplot(outlier.size = 0.5) + theme_bw()  + 
  theme(axis.title = element_blank(), axis.text=element_text(size=10,angle =45, hjust = 1)) + 
  guides(fill=FALSE) + ggtitle("Anther length")
boxplot_anther_length_continents <- boxplot_anther_length_continents + scale_fill_manual(values=c("red","orange","purple","blue","green",
                                                                                            "forestgreen")) 
boxplot_anther_length_continents <- boxplot_anther_length_continents +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  theme(plot.title = element_text(size = 10))

# Compare anther shape by pollinator
pcs_anther_length_no_NA <- subset(pcs_anther_length_no_NA, !pollinator_referenced=="-")
pcs_anther_length_no_NA <- droplevels(pcs_anther_length_no_NA)

boxplot_anther_length_pollinators <- ggplot(pcs_anther_length_no_NA, aes(x=pollinator_referenced, y=total_large_anther_length, fill=pollinator_referenced)) 
boxplot_anther_length_pollinators <- boxplot_anther_length_pollinators + geom_boxplot(outlier.size = 0.5) + theme_bw()  + 
  theme(axis.title = element_blank(), axis.text=element_text(size=10,angle =45, hjust = 1)) + 
  guides(fill=FALSE) + ggtitle("Anther length")
boxplot_anther_length_pollinators <- boxplot_anther_length_pollinators + scale_fill_manual(values=c("orange","magenta","red","blue","black","gold","green","aquamarine"))

boxplot_anther_length_pollinators <- boxplot_anther_length_pollinators +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
  theme(plot.title = element_text(size = 10))

```


```{r, label="permutation tests shape", echo=FALSE, cache=FALSE, message=FALSE, warning=FALSE,fig.height=9, fig.width=6, fig.align='center'}
# test by continent 
# corolla
independence_test_corollaPC1_continent <- independence_test(PC1~continent, data = pcs_corolla,distribution = approximate(nresample = 10000))
pvalue_corollaPC1_continent <- pvalue(independence_test_corollaPC1_continent)[1]

independence_test_corollaPC2_continent <- independence_test(PC2~continent, data = pcs_corolla,distribution = approximate(nresample = 10000))
pvalue_corollaPC2_continent <- pvalue(independence_test_corollaPC2_continent)[1]

pvalues_corolla_continent <- cbind(pvalue_corollaPC1_continent,pvalue_corollaPC2_continent)
colnames(pvalues_corolla_continent) <- c("PC1","PC2")           
pvalues_corolla_continent <- round(pvalues_corolla_continent,3)   

permTest_corollaPC1_continent <- pairwisePermutationTest(PC1~continent,data=pcs_corolla,distribution = approximate(nresample = 10000))
corollaPC1_continent_letters <- cldList(p.adjust~Comparison,data=permTest_corollaPC1_continent,threshold=0.05)
permTest_corollaPC2_continent <- pairwisePermutationTest(PC2~continent,data=pcs_corolla,distribution = approximate(nresample = 10000))
corollaPC2_continent_letters <- cldList(p.adjust~Comparison,data=permTest_corollaPC2_continent,threshold=0.05)

# test by pollinator_referenced -  frist frop ones not sure of pollinator
# corolla
pcs_corolla_no_NA <- subset(pcs_corolla, !pollinator_referenced=="-")
pcs_corolla_no_NA <- droplevels(pcs_corolla_no_NA)

independence_test_corollaPC1_pollinator_referenced <- independence_test(PC1~pollinator_referenced, data = pcs_corolla_no_NA,distribution = approximate(nresample = 10000))
pvalue_corollaPC1_pollinator_referenced <- pvalue(independence_test_corollaPC1_pollinator_referenced)[1]
independence_test_corollaPC2_pollinator_referenced <- independence_test(PC2~pollinator_referenced, data = pcs_corolla_no_NA,distribution = approximate(nresample = 10000))
pvalue_corollaPC2_pollinator_referenced <- pvalue(independence_test_corollaPC2_pollinator_referenced)[1]
pvalues_corolla_pollinator_referenced <- cbind(pvalue_corollaPC1_pollinator_referenced,pvalue_corollaPC2_pollinator_referenced)
colnames(pvalues_corolla_pollinator_referenced) <- c("PC1","PC2")           
pvalues_corolla_pollinator_referenced <- round(pvalues_corolla_pollinator_referenced,3)   

permTest_corollaPC1_pollinator_referenced <- pairwisePermutationTest(PC1~pollinator_referenced,data=pcs_corolla_no_NA,distribution = approximate(nresample = 10000))
corollaPC1_pollinator_referenced_letters <- cldList(p.adjust~Comparison,data=permTest_corollaPC1_pollinator_referenced,threshold=0.05)
permTest_corollaPC2_pollinator_referenced <- pairwisePermutationTest(PC2~pollinator_referenced,data=pcs_corolla_no_NA,distribution = approximate(nresample = 10000))
corollaPC2_pollinator_referenced_letters <- cldList(p.adjust~Comparison,data=permTest_corollaPC2_pollinator_referenced,threshold=0.05)

# anther
independence_test_antherPC1_continent <- independence_test(PC1~continent, data = pcs_anther)
pvalue_antherPC1_continent <- pvalue(independence_test_antherPC1_continent)[1]
independence_test_antherPC2_continent <- independence_test(PC2~continent, data = pcs_anther)
pvalue_antherPC2_continent <- pvalue(independence_test_antherPC2_continent)[1]
pvalues_anther_continent <- cbind(pvalue_antherPC1_continent,pvalue_antherPC2_continent)
colnames(pvalues_anther_continent) <- c("PC1","PC2")           
pvalues_anther_continent <- round(pvalues_anther_continent,3)   

permTest_antherPC1_continent <- pairwisePermutationTest(PC1~continent,data=pcs_anther,distribution = approximate(nresample = 10000))
antherPC1_continent_letters <- cldList(p.adjust~Comparison,data=permTest_antherPC1_continent,threshold=0.05)
permTest_antherPC2_continent <- pairwisePermutationTest(PC2~continent,data=pcs_anther,distribution = approximate(nresample = 10000))
antherPC2_continent_letters <- cldList(p.adjust~Comparison,data=permTest_antherPC2_continent,threshold=0.05)

# anther
pcs_anther_no_NA <- subset(pcs_anther, !pollinator_referenced=="-")
pcs_anther_no_NA <- droplevels(pcs_anther_no_NA)

independence_test_antherPC1_pollinator_referenced <- independence_test(PC1~pollinator_referenced, data = pcs_anther_no_NA,distribution = approximate(nresample = 10000))
pvalue_antherPC1_pollinator_referenced <- pvalue(independence_test_antherPC1_pollinator_referenced)[1]
independence_test_antherPC2_pollinator_referenced <- independence_test(PC2~pollinator_referenced, data = pcs_anther_no_NA,distribution = approximate(nresample = 10000))
pvalue_antherPC2_pollinator_referenced <- pvalue(independence_test_antherPC2_pollinator_referenced)[1]
pvalues_anther_pollinator_referenced <- cbind(pvalue_antherPC1_pollinator_referenced,pvalue_antherPC2_pollinator_referenced)
colnames(pvalues_anther_pollinator_referenced) <- c("PC1","PC2")           
pvalues_anther_pollinator_referenced <- round(pvalues_anther_pollinator_referenced,3)   

permTest_antherPC1_pollinator_referenced <- pairwisePermutationTest(PC1~pollinator_referenced,data=pcs_anther_no_NA,distribution = approximate(nresample = 10000))
antherPC1_pollinator_referenced_letters <- cldList(p.adjust~Comparison,data=permTest_antherPC1_pollinator_referenced,threshold=0.05)
permTest_antherPC2_pollinator_referenced <- pairwisePermutationTest(PC2~pollinator_referenced,data=pcs_anther_no_NA,distribution = approximate(nresample = 10000))
antherPC2_pollinator_referenced_letters <- cldList(p.adjust~Comparison,data=permTest_antherPC2_pollinator_referenced,threshold=0.05)
```

```{r, label="table corolla areas", echo=FALSE, cache=FALSE, message=FALSE, warning=FALSE,fig.height=9, fig.width=6, fig.align='center'}

areas_per_group_corolla_Africa_Asia$Africa <- paste0(areas_per_group_corolla_Africa_Asia$Africa," (",corollaPC1_continent_letters$Letter[1],",",corollaPC2_continent_letters$Letter[1],")")
areas_per_group_corolla_Africa_Asia$Asia <- paste0(areas_per_group_corolla_Africa_Asia$Asia," (",corollaPC1_continent_letters$Letter[2],",",corollaPC2_continent_letters$Letter[2],")")
areas_per_group_corolla_Africa_Australia$Africa <- paste0(areas_per_group_corolla_Africa_Australia$Africa," (",corollaPC1_continent_letters$Letter[1],",",corollaPC2_continent_letters$Letter[1],")")
areas_per_group_corolla_Africa_Australia$Australia <- paste0(areas_per_group_corolla_Africa_Australia$Australia," (",corollaPC1_continent_letters$Letter[3],",",corollaPC2_continent_letters$Letter[3],")")
areas_per_group_corolla_Africa_Europe$Africa <- paste0(areas_per_group_corolla_Africa_Europe$Africa," (",corollaPC1_continent_letters$Letter[1],",",corollaPC2_continent_letters$Letter[1],")")
areas_per_group_corolla_Africa_Europe$Europe <- paste0(areas_per_group_corolla_Africa_Europe$Europe," (",corollaPC1_continent_letters$Letter[4],",",corollaPC2_continent_letters$Letter[4],")")
areas_per_group_corolla_Africa_North_America$Africa <- paste0(areas_per_group_corolla_Africa_North_America$Africa," (",corollaPC1_continent_letters$Letter[1],",",corollaPC2_continent_letters$Letter[1],")")
areas_per_group_corolla_Africa_North_America$North_America <- paste0(areas_per_group_corolla_Africa_North_America$North_America," (",corollaPC1_continent_letters$Letter[5],",",corollaPC2_continent_letters$Letter[5],")")
areas_per_group_corolla_Africa_South_America$Africa  <- paste0(areas_per_group_corolla_Africa_South_America$Africa," (",corollaPC1_continent_letters$Letter[1],",",corollaPC2_continent_letters$Letter[1],")")
areas_per_group_corolla_Africa_South_America$South_America  <- paste0(areas_per_group_corolla_Africa_South_America$South_America," (",corollaPC1_continent_letters$Letter[6],",",corollaPC2_continent_letters$Letter[6],")")
areas_per_group_corolla_Asia_Australia$Asia  <- paste0(areas_per_group_corolla_Asia_Australia$Asia," (",corollaPC1_continent_letters$Letter[2],",",corollaPC2_continent_letters$Letter[2],")")
areas_per_group_corolla_Asia_Australia$Australia  <- paste0(areas_per_group_corolla_Asia_Australia$Australia," (",corollaPC1_continent_letters$Letter[3],",",corollaPC2_continent_letters$Letter[3],")")
areas_per_group_corolla_Asia_Europe$Asia  <- paste0(areas_per_group_corolla_Asia_Europe$Asia," (",corollaPC1_continent_letters$Letter[2],",",corollaPC2_continent_letters$Letter[2],")")
areas_per_group_corolla_Asia_Europe$Europe  <- paste0(areas_per_group_corolla_Asia_Europe$Europe," (",corollaPC1_continent_letters$Letter[4],",",corollaPC2_continent_letters$Letter[4],")")
areas_per_group_corolla_Asia_North_America$Asia  <- paste0(areas_per_group_corolla_Asia_North_America$Asia," (",corollaPC1_continent_letters$Letter[2],",",corollaPC2_continent_letters$Letter[2],")")
areas_per_group_corolla_Asia_North_America$North_America  <- paste0(areas_per_group_corolla_Asia_North_America$North_America," (",corollaPC1_continent_letters$Letter[5],",",corollaPC2_continent_letters$Letter[5],")")
areas_per_group_corolla_Asia_South_America$Asia  <- paste0(areas_per_group_corolla_Asia_South_America$Asia," (",corollaPC1_continent_letters$Letter[2],",",corollaPC2_continent_letters$Letter[2],")")
areas_per_group_corolla_Asia_South_America$South_America  <- paste0(areas_per_group_corolla_Asia_South_America$South_America," (",corollaPC1_continent_letters$Letter[6],",",corollaPC2_continent_letters$Letter[6],")")
areas_per_group_corolla_Australia_Europe$Australia  <- paste0(areas_per_group_corolla_Australia_Europe$Australia," (",corollaPC1_continent_letters$Letter[3],",",corollaPC2_continent_letters$Letter[3],")")
areas_per_group_corolla_Australia_Europe$Europe  <- paste0(areas_per_group_corolla_Australia_Europe$Europe," (",corollaPC1_continent_letters$Letter[4],",",corollaPC2_continent_letters$Letter[4],")")
areas_per_group_corolla_Australia_North_America$Australia  <- paste0(areas_per_group_corolla_Australia_North_America$Australia," (",corollaPC1_continent_letters$Letter[3],",",corollaPC2_continent_letters$Letter[3],")")
areas_per_group_corolla_Australia_North_America$North_America  <- paste0(areas_per_group_corolla_Australia_North_America$North_America," (",corollaPC1_continent_letters$Letter[5],",",corollaPC2_continent_letters$Letter[5],")")
areas_per_group_corolla_Australia_South_America$Australia  <- paste0(areas_per_group_corolla_Australia_South_America$Australia," (",corollaPC1_continent_letters$Letter[3],",",corollaPC2_continent_letters$Letter[3],")")
areas_per_group_corolla_Australia_South_America$South_America  <- paste0(areas_per_group_corolla_Australia_South_America$South_America," (",corollaPC1_continent_letters$Letter[6],",",corollaPC2_continent_letters$Letter[6],")")
areas_per_group_corolla_Europe_North_America$Europe  <- paste0(areas_per_group_corolla_Europe_North_America$Europe," (",corollaPC1_continent_letters$Letter[4],",",corollaPC2_continent_letters$Letter[4],")")
areas_per_group_corolla_Europe_North_America$North_America  <- paste0(areas_per_group_corolla_Europe_North_America$North_America," (",corollaPC1_continent_letters$Letter[5],",",corollaPC2_continent_letters$Letter[5],")")
areas_per_group_corolla_Europe_South_America$Europe  <- paste0(areas_per_group_corolla_Europe_South_America$Europe," (",corollaPC1_continent_letters$Letter[4],",",corollaPC2_continent_letters$Letter[4],")")
areas_per_group_corolla_Europe_South_America$South_America  <- paste0(areas_per_group_corolla_Europe_South_America$South_America," (",corollaPC1_continent_letters$Letter[6],",",corollaPC2_continent_letters$Letter[6],")")
areas_per_group_corolla_North_America_South_America$North_America  <- paste0(areas_per_group_corolla_North_America_South_America$North_America," (",corollaPC1_continent_letters$Letter[5],",",corollaPC2_continent_letters$Letter[5],")")
areas_per_group_corolla_North_America_South_America$South_America  <- paste0(areas_per_group_corolla_North_America_South_America$South_America," (",corollaPC1_continent_letters$Letter[6],",",corollaPC2_continent_letters$Letter[6],")")

table_areas_corolla_by_continent <- cbind(areas_per_group_corolla_Africa_Asia[2:4],areas_per_group_corolla_Africa_Australia[2:4],areas_per_group_corolla_Africa_Europe[2:4],areas_per_group_corolla_Africa_North_America[2:4],areas_per_group_corolla_Africa_South_America[2:4],areas_per_group_corolla_Asia_Australia[2:4],areas_per_group_corolla_Asia_Europe[2:4],areas_per_group_corolla_Asia_North_America[2:4],areas_per_group_corolla_Asia_South_America[2:4],areas_per_group_corolla_Australia_Europe[2:4],areas_per_group_corolla_Australia_North_America[2:4],areas_per_group_corolla_Australia_South_America[2:4],areas_per_group_corolla_Europe_North_America[2:4],areas_per_group_corolla_Europe_South_America[2:4],areas_per_group_corolla_North_America_South_America[2:4]) 
#write.csv(table_areas_corolla_by_continent,"table_areas_corolla_by_continent.csv",row.names = F)
```

```{r, label="table corolla pollinator", echo=FALSE, cache=FALSE, message=FALSE, warning=FALSE,fig.height=9, fig.width=6, fig.align='center'}

areas_per_group_corolla_honeyeater_hummingbird$honeyeater <- paste0(areas_per_group_corolla_honeyeater_hummingbird$honeyeater," (",corollaPC1_pollinator_referenced_letters$Letter[1],",",corollaPC2_pollinator_referenced_letters$Letter[1],")")
areas_per_group_corolla_honeyeater_hummingbird$hummingbird <- paste0(areas_per_group_corolla_honeyeater_hummingbird$hummingbird," (",corollaPC1_pollinator_referenced_letters$Letter[2],",",corollaPC2_pollinator_referenced_letters$Letter[2],")")

areas_per_group_corolla_honeyeater_insect$honeyeater <- paste0(areas_per_group_corolla_honeyeater_insect$honeyeater," (",corollaPC1_pollinator_referenced_letters$Letter[1],",",corollaPC2_pollinator_referenced_letters$Letter[1],")")
areas_per_group_corolla_honeyeater_insect$insect <- paste0(areas_per_group_corolla_honeyeater_insect$insect," (",corollaPC1_pollinator_referenced_letters$Letter[4],",",corollaPC2_pollinator_referenced_letters$Letter[4],")")

areas_per_group_corolla_honeyeater_sunbird$honeyeater <- paste0(areas_per_group_corolla_honeyeater_sunbird$honeyeater," (",corollaPC1_pollinator_referenced_letters$Letter[1],",",corollaPC2_pollinator_referenced_letters$Letter[1],")")
areas_per_group_corolla_honeyeater_sunbird$sunbird <- paste0(areas_per_group_corolla_honeyeater_sunbird$sunbird," (",corollaPC1_pollinator_referenced_letters$Letter[7],",",corollaPC2_pollinator_referenced_letters$Letter[7],")")

areas_per_group_corolla_honeyeater_lepidoptera$honeyeater <- paste0(areas_per_group_corolla_honeyeater_lepidoptera$honeyeater," (",corollaPC1_pollinator_referenced_letters$Letter[1],",",corollaPC2_pollinator_referenced_letters$Letter[1],")")
areas_per_group_corolla_honeyeater_lepidoptera$lepidoptera <- paste0(areas_per_group_corolla_honeyeater_lepidoptera$lepidoptera," (",corollaPC1_pollinator_referenced_letters$Letter[5],",",corollaPC2_pollinator_referenced_letters$Letter[5],")")

areas_per_group_corolla_honeyeater_long_proboscid_fly$honeyeater <- paste0(areas_per_group_corolla_honeyeater_long_proboscid_fly$honeyeater," (",corollaPC1_pollinator_referenced_letters$Letter[1],",",corollaPC2_pollinator_referenced_letters$Letter[1],")")
areas_per_group_corolla_honeyeater_long_proboscid_fly$long_proboscid_fly <- paste0(areas_per_group_corolla_honeyeater_long_proboscid_fly$long_proboscid_fly," (",corollaPC1_pollinator_referenced_letters$Letter[6],",",corollaPC2_pollinator_referenced_letters$Letter[6],")")

areas_per_group_corolla_honeyeater_wind$honeyeater <- paste0(areas_per_group_corolla_honeyeater_wind$honeyeater," (",corollaPC1_pollinator_referenced_letters$Letter[1],",",corollaPC2_pollinator_referenced_letters$Letter[1],")")
areas_per_group_corolla_honeyeater_wind$wind <- paste0(areas_per_group_corolla_honeyeater_wind$wind," (",corollaPC1_pollinator_referenced_letters$Letter[8],",",corollaPC2_pollinator_referenced_letters$Letter[8],")")

areas_per_group_corolla_honeyeater_hummingbird_OW$honeyeater <- paste0(areas_per_group_corolla_honeyeater_hummingbird_OW$honeyeater," (",corollaPC1_pollinator_referenced_letters$Letter[1],",",corollaPC2_pollinator_referenced_letters$Letter[1],")")
areas_per_group_corolla_honeyeater_hummingbird_OW$hummingbird_OW <- paste0(areas_per_group_corolla_honeyeater_hummingbird_OW$hummingbird_OW," (",corollaPC1_pollinator_referenced_letters$Letter[3],",",corollaPC2_pollinator_referenced_letters$Letter[3],")")


areas_per_group_corolla_hummingbird_insect$hummingbird  <- paste0(areas_per_group_corolla_hummingbird_insect$hummingbird," (",corollaPC1_pollinator_referenced_letters$Letter[2],",",corollaPC2_pollinator_referenced_letters$Letter[2],")")
areas_per_group_corolla_hummingbird_insect$insect  <- paste0(areas_per_group_corolla_hummingbird_insect$insect," (",corollaPC1_pollinator_referenced_letters$Letter[4],",",corollaPC2_pollinator_referenced_letters$Letter[4],")")

areas_per_group_corolla_hummingbird_sunbird$hummingbird  <- paste0(areas_per_group_corolla_hummingbird_sunbird$hummingbird," (",corollaPC1_pollinator_referenced_letters$Letter[2],",",corollaPC2_pollinator_referenced_letters$Letter[2],")")
areas_per_group_corolla_hummingbird_sunbird$sunbird  <- paste0(areas_per_group_corolla_hummingbird_sunbird$sunbird," (",corollaPC1_pollinator_referenced_letters$Letter[7],",",corollaPC2_pollinator_referenced_letters$Letter[7],")")

areas_per_group_corolla_hummingbird_lepidoptera$hummingbird  <- paste0(areas_per_group_corolla_hummingbird_lepidoptera$hummingbird," (",corollaPC1_pollinator_referenced_letters$Letter[2],",",corollaPC2_pollinator_referenced_letters$Letter[2],")")
areas_per_group_corolla_hummingbird_lepidoptera$lepidoptera  <- paste0(areas_per_group_corolla_hummingbird_lepidoptera$lepidoptera," (",corollaPC1_pollinator_referenced_letters$Letter[5],",",corollaPC2_pollinator_referenced_letters$Letter[5],")")

areas_per_group_corolla_hummingbird_long_proboscid_fly$hummingbird  <- paste0(areas_per_group_corolla_hummingbird_long_proboscid_fly$hummingbird," (",corollaPC1_pollinator_referenced_letters$Letter[2],",",corollaPC2_pollinator_referenced_letters$Letter[2],")")
areas_per_group_corolla_hummingbird_long_proboscid_fly$long_proboscid_fly  <- paste0(areas_per_group_corolla_hummingbird_long_proboscid_fly$long_proboscid_fly," (",corollaPC1_pollinator_referenced_letters$Letter[6],",",corollaPC2_pollinator_referenced_letters$Letter[6],")")

areas_per_group_corolla_hummingbird_wind$hummingbird  <- paste0(areas_per_group_corolla_hummingbird_wind$hummingbird," (",corollaPC1_pollinator_referenced_letters$Letter[2],",",corollaPC2_pollinator_referenced_letters$Letter[2],")")
areas_per_group_corolla_hummingbird_wind$wind  <- paste0(areas_per_group_corolla_hummingbird_wind$wind," (",corollaPC1_pollinator_referenced_letters$Letter[8],",",corollaPC2_pollinator_referenced_letters$Letter[8],")")

areas_per_group_corolla_hummingbird_hummingbird_OW$hummingbird  <- paste0(areas_per_group_corolla_hummingbird_hummingbird_OW$hummingbird," (",corollaPC1_pollinator_referenced_letters$Letter[2],",",corollaPC2_pollinator_referenced_letters$Letter[2],")")
areas_per_group_corolla_hummingbird_hummingbird_OW$hummingbird_OW  <- paste0(areas_per_group_corolla_hummingbird_hummingbird_OW$hummingbird_OW," (",corollaPC1_pollinator_referenced_letters$Letter[3],",",corollaPC2_pollinator_referenced_letters$Letter[3],")")

areas_per_group_corolla_insect_sunbird$insect  <- paste0(areas_per_group_corolla_insect_sunbird$insect," (",corollaPC1_pollinator_referenced_letters$Letter[4],",",corollaPC2_pollinator_referenced_letters$Letter[4],")")
areas_per_group_corolla_insect_sunbird$sunbird  <- paste0(areas_per_group_corolla_insect_sunbird$sunbird," (",corollaPC1_pollinator_referenced_letters$Letter[7],",",corollaPC2_pollinator_referenced_letters$Letter[7],")")

areas_per_group_corolla_insect_lepidoptera$insect  <- paste0(areas_per_group_corolla_insect_lepidoptera$insect," (",corollaPC1_pollinator_referenced_letters$Letter[4],",",corollaPC2_pollinator_referenced_letters$Letter[4],")")
areas_per_group_corolla_insect_lepidoptera$lepidoptera  <- paste0(areas_per_group_corolla_insect_lepidoptera$lepidoptera," (",corollaPC1_pollinator_referenced_letters$Letter[5],",",corollaPC2_pollinator_referenced_letters$Letter[5],")")

areas_per_group_corolla_insect_long_proboscid_fly$insect  <- paste0(areas_per_group_corolla_insect_long_proboscid_fly$insect," (",corollaPC1_pollinator_referenced_letters$Letter[4],",",corollaPC2_pollinator_referenced_letters$Letter[4],")")
areas_per_group_corolla_insect_long_proboscid_fly$long_proboscid_fly  <- paste0(areas_per_group_corolla_insect_long_proboscid_fly$long_proboscid_fly," (",corollaPC1_pollinator_referenced_letters$Letter[6],",",corollaPC2_pollinator_referenced_letters$Letter[6],")")


areas_per_group_corolla_insect_wind$insect  <- paste0(areas_per_group_corolla_insect_wind$insect," (",corollaPC1_pollinator_referenced_letters$Letter[4],",",corollaPC2_pollinator_referenced_letters$Letter[4],")")
areas_per_group_corolla_insect_wind$wind  <- paste0(areas_per_group_corolla_insect_wind$wind," (",corollaPC1_pollinator_referenced_letters$Letter[8],",",corollaPC2_pollinator_referenced_letters$Letter[8],")")

areas_per_group_corolla_insect_hummingbird_OW$insect  <- paste0(areas_per_group_corolla_insect_hummingbird_OW$insect," (",corollaPC1_pollinator_referenced_letters$Letter[4],",",corollaPC2_pollinator_referenced_letters$Letter[4],")")
areas_per_group_corolla_insect_hummingbird_OW$hummingbird_OW  <- paste0(areas_per_group_corolla_insect_hummingbird_OW$hummingbird_OW," (",corollaPC1_pollinator_referenced_letters$Letter[3],",",corollaPC2_pollinator_referenced_letters$Letter[3],")")

areas_per_group_corolla_sunbird_lepidoptera$sunbird  <- paste0(areas_per_group_corolla_sunbird_lepidoptera$sunbird," (",corollaPC1_pollinator_referenced_letters$Letter[7],",",corollaPC2_pollinator_referenced_letters$Letter[7],")")
areas_per_group_corolla_sunbird_lepidoptera$lepidoptera  <- paste0(areas_per_group_corolla_sunbird_lepidoptera$lepidoptera," (",corollaPC1_pollinator_referenced_letters$Letter[5],",",corollaPC2_pollinator_referenced_letters$Letter[5],")")

areas_per_group_corolla_sunbird_long_proboscid_fly$sunbird  <- paste0(areas_per_group_corolla_sunbird_long_proboscid_fly$sunbird," (",corollaPC1_pollinator_referenced_letters$Letter[7],",",corollaPC2_pollinator_referenced_letters$Letter[7],")")
areas_per_group_corolla_sunbird_long_proboscid_fly$long_proboscid_fly  <- paste0(areas_per_group_corolla_sunbird_long_proboscid_fly$long_proboscid_fly," (",corollaPC1_pollinator_referenced_letters$Letter[6],",",corollaPC2_pollinator_referenced_letters$Letter[6],")")

areas_per_group_corolla_sunbird_wind$sunbird  <- paste0(areas_per_group_corolla_sunbird_wind$sunbird," (",corollaPC1_pollinator_referenced_letters$Letter[7],",",corollaPC2_pollinator_referenced_letters$Letter[7],")")
areas_per_group_corolla_sunbird_wind$wind  <- paste0(areas_per_group_corolla_sunbird_wind$wind," (",corollaPC1_pollinator_referenced_letters$Letter[8],",",corollaPC2_pollinator_referenced_letters$Letter[8],")")

areas_per_group_corolla_sunbird_hummingbird_OW$sunbird  <- paste0(areas_per_group_corolla_sunbird_hummingbird_OW$sunbird," (",corollaPC1_pollinator_referenced_letters$Letter[7],",",corollaPC2_pollinator_referenced_letters$Letter[7],")")
areas_per_group_corolla_sunbird_hummingbird_OW$hummingbird_OW  <- paste0(areas_per_group_corolla_sunbird_hummingbird_OW$hummingbird_OW," (",corollaPC1_pollinator_referenced_letters$Letter[3],",",corollaPC2_pollinator_referenced_letters$Letter[3],")")

areas_per_group_corolla_lepidoptera_long_proboscid_fly$lepidoptera  <- paste0(areas_per_group_corolla_lepidoptera_long_proboscid_fly$lepidoptera," (",corollaPC1_pollinator_referenced_letters$Letter[5],",",corollaPC2_pollinator_referenced_letters$Letter[5],")")
areas_per_group_corolla_lepidoptera_long_proboscid_fly$long_proboscid_fly  <- paste0(areas_per_group_corolla_lepidoptera_long_proboscid_fly$long_proboscid_fly," (",corollaPC1_pollinator_referenced_letters$Letter[6],",",corollaPC2_pollinator_referenced_letters$Letter[6],")")

areas_per_group_corolla_lepidoptera_wind$lepidoptera  <- paste0(areas_per_group_corolla_lepidoptera_wind$lepidoptera," (",corollaPC1_pollinator_referenced_letters$Letter[5],",",corollaPC2_pollinator_referenced_letters$Letter[5],")")
areas_per_group_corolla_lepidoptera_wind$wind  <- paste0(areas_per_group_corolla_lepidoptera_wind$wind," (",corollaPC1_pollinator_referenced_letters$Letter[8],",",corollaPC2_pollinator_referenced_letters$Letter[8],")")

areas_per_group_corolla_lepidoptera_hummingbird_OW$lepidoptera  <- paste0(areas_per_group_corolla_lepidoptera_hummingbird_OW$lepidoptera," (",corollaPC1_pollinator_referenced_letters$Letter[5],",",corollaPC2_pollinator_referenced_letters$Letter[5],")")
areas_per_group_corolla_lepidoptera_hummingbird_OW$hummingbird_OW  <- paste0(areas_per_group_corolla_lepidoptera_hummingbird_OW$hummingbird_OW," (",corollaPC1_pollinator_referenced_letters$Letter[3],",",corollaPC2_pollinator_referenced_letters$Letter[3],")")

areas_per_group_corolla_long_proboscid_fly_wind$long_proboscid_fly  <- paste0(areas_per_group_corolla_long_proboscid_fly_wind$long_proboscid_fly," (",corollaPC1_pollinator_referenced_letters$Letter[6],",",corollaPC2_pollinator_referenced_letters$Letter[6],")")
areas_per_group_corolla_long_proboscid_fly_wind$wind  <- paste0(areas_per_group_corolla_long_proboscid_fly_wind$wind," (",corollaPC1_pollinator_referenced_letters$Letter[8],",",corollaPC2_pollinator_referenced_letters$Letter[8],")")

areas_per_group_corolla_long_proboscid_fly_hummingbird_OW$long_proboscid_fly  <- paste0(areas_per_group_corolla_long_proboscid_fly_hummingbird_OW$long_proboscid_fly," (",corollaPC1_pollinator_referenced_letters$Letter[6],",",corollaPC2_pollinator_referenced_letters$Letter[6],")")
areas_per_group_corolla_long_proboscid_fly_hummingbird_OW$hummingbird_OW  <- paste0(areas_per_group_corolla_long_proboscid_fly_hummingbird_OW$hummingbird_OW," (",corollaPC1_pollinator_referenced_letters$Letter[3],",",corollaPC2_pollinator_referenced_letters$Letter[3],")")

areas_per_group_corolla_hummingbird_OW_wind$hummingbird_OW  <- paste0(areas_per_group_corolla_hummingbird_OW_wind$hummingbird_OW," (",corollaPC1_pollinator_referenced_letters$Letter[3],",",corollaPC2_pollinator_referenced_letters$Letter[3],")")
areas_per_group_corolla_hummingbird_OW_wind$wind  <- paste0(areas_per_group_corolla_hummingbird_OW_wind$wind," (",corollaPC1_pollinator_referenced_letters$Letter[8],",",corollaPC2_pollinator_referenced_letters$Letter[8],")")


table_areas_corolla_by_pollinator <- cbind(areas_per_group_corolla_honeyeater_hummingbird[2:4],
                                           areas_per_group_corolla_honeyeater_insect[2:4],
                                           areas_per_group_corolla_honeyeater_sunbird[2:4],
                                           areas_per_group_corolla_honeyeater_lepidoptera[2:4],
                                           areas_per_group_corolla_honeyeater_long_proboscid_fly[2:4],
                                           areas_per_group_corolla_honeyeater_wind[2:4],
                                           areas_per_group_corolla_honeyeater_hummingbird_OW[2:4],
                                           areas_per_group_corolla_hummingbird_insect[2:4],
                                           areas_per_group_corolla_hummingbird_sunbird[2:4],
                                           areas_per_group_corolla_hummingbird_lepidoptera[2:4],
                                           areas_per_group_corolla_hummingbird_long_proboscid_fly[2:4],
                                           areas_per_group_corolla_hummingbird_wind[2:4],
                                           areas_per_group_corolla_hummingbird_hummingbird_OW[2:4],
                                           areas_per_group_corolla_insect_sunbird[2:4],
                                           areas_per_group_corolla_insect_lepidoptera[2:4],
                                           areas_per_group_corolla_insect_long_proboscid_fly[2:4],
                                           areas_per_group_corolla_insect_wind[2:4],
                                           areas_per_group_corolla_insect_hummingbird_OW[2:4],
                                           areas_per_group_corolla_sunbird_lepidoptera[2:4],
                                           areas_per_group_corolla_sunbird_long_proboscid_fly[2:4],
                                           areas_per_group_corolla_sunbird_wind[2:4],
                                           areas_per_group_corolla_sunbird_hummingbird_OW[2:4],
                                           areas_per_group_corolla_lepidoptera_long_proboscid_fly[2:4],
                                           areas_per_group_corolla_lepidoptera_wind[2:4],
                                           areas_per_group_corolla_lepidoptera_hummingbird_OW[2:4],
                                           areas_per_group_corolla_long_proboscid_fly_wind[2:4],
                                           areas_per_group_corolla_long_proboscid_fly_hummingbird_OW[2:4],
                                           areas_per_group_corolla_hummingbird_OW_wind[2:4])

#write.csv(table_areas_corolla_by_pollinator,"table_areas_corolla_by_pollinator.csv",row.names = F)
```

```{r, label="table anther areas", echo=FALSE, cache=FALSE, message=FALSE, warning=FALSE,fig.height=9, fig.width=6, fig.align='center'}

areas_per_group_anther_Africa_Asia$Africa <- paste0(areas_per_group_anther_Africa_Asia$Africa," (",antherPC1_continent_letters$Letter[1],",",antherPC2_continent_letters$Letter[1],")")
areas_per_group_anther_Africa_Asia$Asia <- paste0(areas_per_group_anther_Africa_Asia$Asia," (",antherPC1_continent_letters$Letter[2],",",antherPC2_continent_letters$Letter[2],")")
areas_per_group_anther_Africa_Australia$Africa <- paste0(areas_per_group_anther_Africa_Australia$Africa," (",antherPC1_continent_letters$Letter[1],",",antherPC2_continent_letters$Letter[1],")")
areas_per_group_anther_Africa_Australia$Australia <- paste0(areas_per_group_anther_Africa_Australia$Australia," (",antherPC1_continent_letters$Letter[3],",",antherPC2_continent_letters$Letter[3],")")
areas_per_group_anther_Africa_Europe$Africa <- paste0(areas_per_group_anther_Africa_Europe$Africa," (",antherPC1_continent_letters$Letter[1],",",antherPC2_continent_letters$Letter[1],")")
areas_per_group_anther_Africa_Europe$Europe <- paste0(areas_per_group_anther_Africa_Europe$Europe," (",antherPC1_continent_letters$Letter[4],",",antherPC2_continent_letters$Letter[4],")")
areas_per_group_anther_Africa_North_America$Africa <- paste0(areas_per_group_anther_Africa_North_America$Africa," (",antherPC1_continent_letters$Letter[1],",",antherPC2_continent_letters$Letter[1],")")
areas_per_group_anther_Africa_North_America$North_America <- paste0(areas_per_group_anther_Africa_North_America$North_America," (",antherPC1_continent_letters$Letter[5],",",antherPC2_continent_letters$Letter[5],")")
areas_per_group_anther_Africa_South_America$Africa  <- paste0(areas_per_group_anther_Africa_South_America$Africa," (",antherPC1_continent_letters$Letter[1],",",antherPC2_continent_letters$Letter[1],")")
areas_per_group_anther_Africa_South_America$South_America  <- paste0(areas_per_group_anther_Africa_South_America$South_America," (",antherPC1_continent_letters$Letter[6],",",antherPC2_continent_letters$Letter[6],")")
areas_per_group_anther_Asia_Australia$Asia  <- paste0(areas_per_group_anther_Asia_Australia$Asia," (",antherPC1_continent_letters$Letter[2],",",antherPC2_continent_letters$Letter[2],")")
areas_per_group_anther_Asia_Australia$Australia  <- paste0(areas_per_group_anther_Asia_Australia$Australia," (",antherPC1_continent_letters$Letter[3],",",antherPC2_continent_letters$Letter[3],")")
areas_per_group_anther_Asia_Europe$Asia  <- paste0(areas_per_group_anther_Asia_Europe$Asia," (",antherPC1_continent_letters$Letter[2],",",antherPC2_continent_letters$Letter[2],")")
areas_per_group_anther_Asia_Europe$Europe  <- paste0(areas_per_group_anther_Asia_Europe$Europe," (",antherPC1_continent_letters$Letter[4],",",antherPC2_continent_letters$Letter[4],")")
areas_per_group_anther_Asia_North_America$Asia  <- paste0(areas_per_group_anther_Asia_North_America$Asia," (",antherPC1_continent_letters$Letter[2],",",antherPC2_continent_letters$Letter[2],")")
areas_per_group_anther_Asia_North_America$North_America  <- paste0(areas_per_group_anther_Asia_North_America$North_America," (",antherPC1_continent_letters$Letter[5],",",antherPC2_continent_letters$Letter[5],")")
areas_per_group_anther_Asia_South_America$Asia  <- paste0(areas_per_group_anther_Asia_South_America$Asia," (",antherPC1_continent_letters$Letter[2],",",antherPC2_continent_letters$Letter[2],")")
areas_per_group_anther_Asia_South_America$South_America  <- paste0(areas_per_group_anther_Asia_South_America$South_America," (",antherPC1_continent_letters$Letter[6],",",antherPC2_continent_letters$Letter[6],")")
areas_per_group_anther_Australia_Europe$Australia  <- paste0(areas_per_group_anther_Australia_Europe$Australia," (",antherPC1_continent_letters$Letter[3],",",antherPC2_continent_letters$Letter[3],")")
areas_per_group_anther_Australia_Europe$Europe  <- paste0(areas_per_group_anther_Australia_Europe$Europe," (",antherPC1_continent_letters$Letter[4],",",antherPC2_continent_letters$Letter[4],")")
areas_per_group_anther_Australia_North_America$Australia  <- paste0(areas_per_group_anther_Australia_North_America$Australia," (",antherPC1_continent_letters$Letter[3],",",antherPC2_continent_letters$Letter[3],")")
areas_per_group_anther_Australia_North_America$North_America  <- paste0(areas_per_group_anther_Australia_North_America$North_America," (",antherPC1_continent_letters$Letter[5],",",antherPC2_continent_letters$Letter[5],")")
areas_per_group_anther_Australia_South_America$Australia  <- paste0(areas_per_group_anther_Australia_South_America$Australia," (",antherPC1_continent_letters$Letter[3],",",antherPC2_continent_letters$Letter[3],")")
areas_per_group_anther_Australia_South_America$South_America  <- paste0(areas_per_group_anther_Australia_South_America$South_America," (",antherPC1_continent_letters$Letter[6],",",antherPC2_continent_letters$Letter[6],")")
areas_per_group_anther_Europe_North_America$Europe  <- paste0(areas_per_group_anther_Europe_North_America$Europe," (",antherPC1_continent_letters$Letter[4],",",antherPC2_continent_letters$Letter[4],")")
areas_per_group_anther_Europe_North_America$North_America  <- paste0(areas_per_group_anther_Europe_North_America$North_America," (",antherPC1_continent_letters$Letter[5],",",antherPC2_continent_letters$Letter[5],")")
areas_per_group_anther_Europe_South_America$Europe  <- paste0(areas_per_group_anther_Europe_South_America$Europe," (",antherPC1_continent_letters$Letter[4],",",antherPC2_continent_letters$Letter[4],")")
areas_per_group_anther_Europe_South_America$South_America  <- paste0(areas_per_group_anther_Europe_South_America$South_America," (",antherPC1_continent_letters$Letter[6],",",antherPC2_continent_letters$Letter[6],")")
areas_per_group_anther_North_America_South_America$North_America  <- paste0(areas_per_group_anther_North_America_South_America$North_America," (",antherPC1_continent_letters$Letter[5],",",antherPC2_continent_letters$Letter[5],")")
areas_per_group_anther_North_America_South_America$South_America  <- paste0(areas_per_group_anther_North_America_South_America$South_America," (",antherPC1_continent_letters$Letter[6],",",antherPC2_continent_letters$Letter[6],")")

table_areas_anther_by_continent <- cbind(areas_per_group_anther_Africa_Asia[2:4],areas_per_group_anther_Africa_Australia[2:4],areas_per_group_anther_Africa_Europe[2:4],areas_per_group_anther_Africa_North_America[2:4],areas_per_group_anther_Africa_South_America[2:4],areas_per_group_anther_Asia_Australia[2:4],areas_per_group_anther_Asia_Europe[2:4],areas_per_group_anther_Asia_North_America[2:4],areas_per_group_anther_Asia_South_America[2:4],areas_per_group_anther_Australia_Europe[2:4],areas_per_group_anther_Australia_North_America[2:4],areas_per_group_anther_Australia_South_America[2:4], areas_per_group_anther_Europe_North_America[2:4],areas_per_group_anther_Europe_South_America[2:4],areas_per_group_anther_North_America_South_America[2:4])

#write.csv(table_areas_anther_by_continent,"table_areas_anther_by_continent.csv",row.names = F)
```

```{r, label="table anther pollinator", echo=FALSE, cache=FALSE, message=FALSE, warning=FALSE,fig.height=9, fig.width=6, fig.align='center'}

areas_per_group_anther_honeyeater_hummingbird$honeyeater <- paste0(areas_per_group_anther_honeyeater_hummingbird$honeyeater," (",antherPC1_pollinator_referenced_letters$Letter[1],",",antherPC2_pollinator_referenced_letters$Letter[1],")")
areas_per_group_anther_honeyeater_hummingbird$hummingbird <- paste0(areas_per_group_anther_honeyeater_hummingbird$hummingbird," (",antherPC1_pollinator_referenced_letters$Letter[2],",",antherPC2_pollinator_referenced_letters$Letter[2],")")

areas_per_group_anther_honeyeater_insect$honeyeater <- paste0(areas_per_group_anther_honeyeater_insect$honeyeater," (",antherPC1_pollinator_referenced_letters$Letter[1],",",antherPC2_pollinator_referenced_letters$Letter[1],")")
areas_per_group_anther_honeyeater_insect$insect <- paste0(areas_per_group_anther_honeyeater_insect$insect," (",antherPC1_pollinator_referenced_letters$Letter[4],",",antherPC2_pollinator_referenced_letters$Letter[4],")")

areas_per_group_anther_honeyeater_sunbird$honeyeater <- paste0(areas_per_group_anther_honeyeater_sunbird$honeyeater," (",antherPC1_pollinator_referenced_letters$Letter[1],",",antherPC2_pollinator_referenced_letters$Letter[1],")")
areas_per_group_anther_honeyeater_sunbird$sunbird <- paste0(areas_per_group_anther_honeyeater_sunbird$sunbird," (",antherPC1_pollinator_referenced_letters$Letter[7],",",antherPC2_pollinator_referenced_letters$Letter[7],")")

areas_per_group_anther_honeyeater_lepidoptera$honeyeater <- paste0(areas_per_group_anther_honeyeater_lepidoptera$honeyeater," (",antherPC1_pollinator_referenced_letters$Letter[1],",",antherPC2_pollinator_referenced_letters$Letter[1],")")
areas_per_group_anther_honeyeater_lepidoptera$lepidoptera <- paste0(areas_per_group_anther_honeyeater_lepidoptera$lepidoptera," (",antherPC1_pollinator_referenced_letters$Letter[5],",",antherPC2_pollinator_referenced_letters$Letter[5],")")

areas_per_group_anther_honeyeater_long_proboscid_fly$honeyeater <- paste0(areas_per_group_anther_honeyeater_long_proboscid_fly$honeyeater," (",antherPC1_pollinator_referenced_letters$Letter[1],",",antherPC2_pollinator_referenced_letters$Letter[1],")")
areas_per_group_anther_honeyeater_long_proboscid_fly$long_proboscid_fly <- paste0(areas_per_group_anther_honeyeater_long_proboscid_fly$long_proboscid_fly," (",antherPC1_pollinator_referenced_letters$Letter[6],",",antherPC2_pollinator_referenced_letters$Letter[6],")")

areas_per_group_anther_honeyeater_wind$honeyeater <- paste0(areas_per_group_anther_honeyeater_wind$honeyeater," (",antherPC1_pollinator_referenced_letters$Letter[1],",",antherPC2_pollinator_referenced_letters$Letter[1],")")
areas_per_group_anther_honeyeater_wind$wind <- paste0(areas_per_group_anther_honeyeater_wind$wind," (",antherPC1_pollinator_referenced_letters$Letter[8],",",antherPC2_pollinator_referenced_letters$Letter[8],")")

areas_per_group_anther_honeyeater_hummingbird_OW$honeyeater <- paste0(areas_per_group_anther_honeyeater_hummingbird_OW$honeyeater," (",antherPC1_pollinator_referenced_letters$Letter[1],",",antherPC2_pollinator_referenced_letters$Letter[1],")")
areas_per_group_anther_honeyeater_hummingbird_OW$hummingbird_OW <- paste0(areas_per_group_anther_honeyeater_hummingbird_OW$hummingbird_OW," (",antherPC1_pollinator_referenced_letters$Letter[3],",",antherPC2_pollinator_referenced_letters$Letter[3],")")


areas_per_group_anther_hummingbird_insect$hummingbird  <- paste0(areas_per_group_anther_hummingbird_insect$hummingbird," (",antherPC1_pollinator_referenced_letters$Letter[2],",",antherPC2_pollinator_referenced_letters$Letter[2],")")
areas_per_group_anther_hummingbird_insect$insect  <- paste0(areas_per_group_anther_hummingbird_insect$insect," (",antherPC1_pollinator_referenced_letters$Letter[4],",",antherPC2_pollinator_referenced_letters$Letter[4],")")

areas_per_group_anther_hummingbird_sunbird$hummingbird  <- paste0(areas_per_group_anther_hummingbird_sunbird$hummingbird," (",antherPC1_pollinator_referenced_letters$Letter[2],",",antherPC2_pollinator_referenced_letters$Letter[2],")")
areas_per_group_anther_hummingbird_sunbird$sunbird  <- paste0(areas_per_group_anther_hummingbird_sunbird$sunbird," (",antherPC1_pollinator_referenced_letters$Letter[7],",",antherPC2_pollinator_referenced_letters$Letter[7],")")

areas_per_group_anther_hummingbird_lepidoptera$hummingbird  <- paste0(areas_per_group_anther_hummingbird_lepidoptera$hummingbird," (",antherPC1_pollinator_referenced_letters$Letter[2],",",antherPC2_pollinator_referenced_letters$Letter[2],")")
areas_per_group_anther_hummingbird_lepidoptera$lepidoptera  <- paste0(areas_per_group_anther_hummingbird_lepidoptera$lepidoptera," (",antherPC1_pollinator_referenced_letters$Letter[5],",",antherPC2_pollinator_referenced_letters$Letter[5],")")

areas_per_group_anther_hummingbird_long_proboscid_fly$hummingbird  <- paste0(areas_per_group_anther_hummingbird_long_proboscid_fly$hummingbird," (",antherPC1_pollinator_referenced_letters$Letter[2],",",antherPC2_pollinator_referenced_letters$Letter[2],")")
areas_per_group_anther_hummingbird_long_proboscid_fly$long_proboscid_fly  <- paste0(areas_per_group_anther_hummingbird_long_proboscid_fly$long_proboscid_fly," (",antherPC1_pollinator_referenced_letters$Letter[6],",",antherPC2_pollinator_referenced_letters$Letter[6],")")

areas_per_group_anther_hummingbird_wind$hummingbird  <- paste0(areas_per_group_anther_hummingbird_wind$hummingbird," (",antherPC1_pollinator_referenced_letters$Letter[2],",",antherPC2_pollinator_referenced_letters$Letter[2],")")
areas_per_group_anther_hummingbird_wind$wind  <- paste0(areas_per_group_anther_hummingbird_wind$wind," (",antherPC1_pollinator_referenced_letters$Letter[8],",",antherPC2_pollinator_referenced_letters$Letter[8],")")

areas_per_group_anther_hummingbird_hummingbird_OW$hummingbird  <- paste0(areas_per_group_anther_hummingbird_hummingbird_OW$hummingbird," (",antherPC1_pollinator_referenced_letters$Letter[2],",",antherPC2_pollinator_referenced_letters$Letter[2],")")
areas_per_group_anther_hummingbird_hummingbird_OW$hummingbird_OW  <- paste0(areas_per_group_anther_hummingbird_hummingbird_OW$hummingbird_OW," (",antherPC1_pollinator_referenced_letters$Letter[3],",",antherPC2_pollinator_referenced_letters$Letter[3],")")

areas_per_group_anther_insect_sunbird$insect  <- paste0(areas_per_group_anther_insect_sunbird$insect," (",antherPC1_pollinator_referenced_letters$Letter[4],",",antherPC2_pollinator_referenced_letters$Letter[4],")")
areas_per_group_anther_insect_sunbird$sunbird  <- paste0(areas_per_group_anther_insect_sunbird$sunbird," (",antherPC1_pollinator_referenced_letters$Letter[7],",",antherPC2_pollinator_referenced_letters$Letter[7],")")

areas_per_group_anther_insect_lepidoptera$insect  <- paste0(areas_per_group_anther_insect_lepidoptera$insect," (",antherPC1_pollinator_referenced_letters$Letter[4],",",antherPC2_pollinator_referenced_letters$Letter[4],")")
areas_per_group_anther_insect_lepidoptera$lepidoptera  <- paste0(areas_per_group_anther_insect_lepidoptera$lepidoptera," (",antherPC1_pollinator_referenced_letters$Letter[5],",",antherPC2_pollinator_referenced_letters$Letter[5],")")

areas_per_group_anther_insect_long_proboscid_fly$insect  <- paste0(areas_per_group_anther_insect_long_proboscid_fly$insect," (",antherPC1_pollinator_referenced_letters$Letter[4],",",antherPC2_pollinator_referenced_letters$Letter[4],")")
areas_per_group_anther_insect_long_proboscid_fly$long_proboscid_fly  <- paste0(areas_per_group_anther_insect_long_proboscid_fly$long_proboscid_fly," (",antherPC1_pollinator_referenced_letters$Letter[6],",",antherPC2_pollinator_referenced_letters$Letter[6],")")


areas_per_group_anther_insect_wind$insect  <- paste0(areas_per_group_anther_insect_wind$insect," (",antherPC1_pollinator_referenced_letters$Letter[4],",",antherPC2_pollinator_referenced_letters$Letter[4],")")
areas_per_group_anther_insect_wind$wind  <- paste0(areas_per_group_anther_insect_wind$wind," (",antherPC1_pollinator_referenced_letters$Letter[8],",",antherPC2_pollinator_referenced_letters$Letter[8],")")

areas_per_group_anther_insect_hummingbird_OW$insect  <- paste0(areas_per_group_anther_insect_hummingbird_OW$insect," (",antherPC1_pollinator_referenced_letters$Letter[4],",",antherPC2_pollinator_referenced_letters$Letter[4],")")
areas_per_group_anther_insect_hummingbird_OW$hummingbird_OW  <- paste0(areas_per_group_anther_insect_hummingbird_OW$hummingbird_OW," (",antherPC1_pollinator_referenced_letters$Letter[3],",",antherPC2_pollinator_referenced_letters$Letter[3],")")

areas_per_group_anther_sunbird_lepidoptera$sunbird  <- paste0(areas_per_group_anther_sunbird_lepidoptera$sunbird," (",antherPC1_pollinator_referenced_letters$Letter[7],",",antherPC2_pollinator_referenced_letters$Letter[7],")")
areas_per_group_anther_sunbird_lepidoptera$lepidoptera  <- paste0(areas_per_group_anther_sunbird_lepidoptera$lepidoptera," (",antherPC1_pollinator_referenced_letters$Letter[5],",",antherPC2_pollinator_referenced_letters$Letter[5],")")

areas_per_group_anther_sunbird_long_proboscid_fly$sunbird  <- paste0(areas_per_group_anther_sunbird_long_proboscid_fly$sunbird," (",antherPC1_pollinator_referenced_letters$Letter[7],",",antherPC2_pollinator_referenced_letters$Letter[7],")")
areas_per_group_anther_sunbird_long_proboscid_fly$long_proboscid_fly  <- paste0(areas_per_group_anther_sunbird_long_proboscid_fly$long_proboscid_fly," (",antherPC1_pollinator_referenced_letters$Letter[6],",",antherPC2_pollinator_referenced_letters$Letter[6],")")

areas_per_group_anther_sunbird_wind$sunbird  <- paste0(areas_per_group_anther_sunbird_wind$sunbird," (",antherPC1_pollinator_referenced_letters$Letter[7],",",antherPC2_pollinator_referenced_letters$Letter[7],")")
areas_per_group_anther_sunbird_wind$wind  <- paste0(areas_per_group_anther_sunbird_wind$wind," (",antherPC1_pollinator_referenced_letters$Letter[8],",",antherPC2_pollinator_referenced_letters$Letter[8],")")

areas_per_group_anther_sunbird_hummingbird_OW$sunbird  <- paste0(areas_per_group_anther_sunbird_hummingbird_OW$sunbird," (",antherPC1_pollinator_referenced_letters$Letter[7],",",antherPC2_pollinator_referenced_letters$Letter[7],")")
areas_per_group_anther_sunbird_hummingbird_OW$hummingbird_OW  <- paste0(areas_per_group_anther_sunbird_hummingbird_OW$hummingbird_OW," (",antherPC1_pollinator_referenced_letters$Letter[3],",",antherPC2_pollinator_referenced_letters$Letter[3],")")

areas_per_group_anther_lepidoptera_long_proboscid_fly$lepidoptera  <- paste0(areas_per_group_anther_lepidoptera_long_proboscid_fly$lepidoptera," (",antherPC1_pollinator_referenced_letters$Letter[5],",",antherPC2_pollinator_referenced_letters$Letter[5],")")
areas_per_group_anther_lepidoptera_long_proboscid_fly$long_proboscid_fly  <- paste0(areas_per_group_anther_lepidoptera_long_proboscid_fly$long_proboscid_fly," (",antherPC1_pollinator_referenced_letters$Letter[6],",",antherPC2_pollinator_referenced_letters$Letter[6],")")

areas_per_group_anther_lepidoptera_wind$lepidoptera  <- paste0(areas_per_group_anther_lepidoptera_wind$lepidoptera," (",antherPC1_pollinator_referenced_letters$Letter[5],",",antherPC2_pollinator_referenced_letters$Letter[5],")")
areas_per_group_anther_lepidoptera_wind$wind  <- paste0(areas_per_group_anther_lepidoptera_wind$wind," (",antherPC1_pollinator_referenced_letters$Letter[8],",",antherPC2_pollinator_referenced_letters$Letter[8],")")

areas_per_group_anther_lepidoptera_hummingbird_OW$lepidoptera  <- paste0(areas_per_group_anther_lepidoptera_hummingbird_OW$lepidoptera," (",antherPC1_pollinator_referenced_letters$Letter[5],",",antherPC2_pollinator_referenced_letters$Letter[5],")")
areas_per_group_anther_lepidoptera_hummingbird_OW$hummingbird_OW  <- paste0(areas_per_group_anther_lepidoptera_hummingbird_OW$hummingbird_OW," (",antherPC1_pollinator_referenced_letters$Letter[3],",",antherPC2_pollinator_referenced_letters$Letter[3],")")

areas_per_group_anther_long_proboscid_fly_wind$long_proboscid_fly  <- paste0(areas_per_group_anther_long_proboscid_fly_wind$long_proboscid_fly," (",antherPC1_pollinator_referenced_letters$Letter[6],",",antherPC2_pollinator_referenced_letters$Letter[6],")")
areas_per_group_anther_long_proboscid_fly_wind$wind  <- paste0(areas_per_group_anther_long_proboscid_fly_wind$wind," (",antherPC1_pollinator_referenced_letters$Letter[8],",",antherPC2_pollinator_referenced_letters$Letter[8],")")

areas_per_group_anther_long_proboscid_fly_hummingbird_OW$long_proboscid_fly  <- paste0(areas_per_group_anther_long_proboscid_fly_hummingbird_OW$long_proboscid_fly," (",antherPC1_pollinator_referenced_letters$Letter[6],",",antherPC2_pollinator_referenced_letters$Letter[6],")")
areas_per_group_anther_long_proboscid_fly_hummingbird_OW$hummingbird_OW  <- paste0(areas_per_group_anther_long_proboscid_fly_hummingbird_OW$hummingbird_OW," (",antherPC1_pollinator_referenced_letters$Letter[3],",",antherPC2_pollinator_referenced_letters$Letter[3],")")

areas_per_group_anther_hummingbird_OW_wind$hummingbird_OW  <- paste0(areas_per_group_anther_hummingbird_OW_wind$hummingbird_OW," (",antherPC1_pollinator_referenced_letters$Letter[3],",",antherPC2_pollinator_referenced_letters$Letter[3],")")
areas_per_group_anther_hummingbird_OW_wind$wind  <- paste0(areas_per_group_anther_hummingbird_OW_wind$wind," (",antherPC1_pollinator_referenced_letters$Letter[8],",",antherPC2_pollinator_referenced_letters$Letter[8],")")


table_areas_anther_by_pollinator <- cbind(areas_per_group_anther_honeyeater_hummingbird[2:4],
                                           areas_per_group_anther_honeyeater_insect[2:4],
                                           areas_per_group_anther_honeyeater_sunbird[2:4],
                                           areas_per_group_anther_honeyeater_lepidoptera[2:4],
                                           areas_per_group_anther_honeyeater_long_proboscid_fly[2:4],
                                           areas_per_group_anther_honeyeater_wind[2:4],
                                           areas_per_group_anther_honeyeater_hummingbird_OW[2:4],
                                           areas_per_group_anther_hummingbird_insect[2:4],
                                           areas_per_group_anther_hummingbird_sunbird[2:4],
                                           areas_per_group_anther_hummingbird_lepidoptera[2:4],
                                           areas_per_group_anther_hummingbird_long_proboscid_fly[2:4],
                                           areas_per_group_anther_hummingbird_wind[2:4],
                                           areas_per_group_anther_hummingbird_hummingbird_OW[2:4],
                                           areas_per_group_anther_insect_sunbird[2:4],
                                           areas_per_group_anther_insect_lepidoptera[2:4],
                                           areas_per_group_anther_insect_long_proboscid_fly[2:4],
                                           areas_per_group_anther_insect_wind[2:4],
                                           areas_per_group_anther_insect_hummingbird_OW[2:4],
                                           areas_per_group_anther_sunbird_lepidoptera[2:4],
                                           areas_per_group_anther_sunbird_long_proboscid_fly[2:4],
                                           areas_per_group_anther_sunbird_wind[2:4],
                                           areas_per_group_anther_sunbird_hummingbird_OW[2:4],
                                           areas_per_group_anther_lepidoptera_long_proboscid_fly[2:4],
                                           areas_per_group_anther_lepidoptera_wind[2:4],
                                           areas_per_group_anther_lepidoptera_hummingbird_OW[2:4],
                                           areas_per_group_anther_long_proboscid_fly_wind[2:4],
                                           areas_per_group_anther_long_proboscid_fly_hummingbird_OW[2:4],
                                           areas_per_group_anther_hummingbird_OW_wind[2:4])

#write.csv(table_areas_anther_by_pollinator,"table_areas_anther_by_pollinator.csv",row.names = F)
```

\pagebreak

```{r, label="permutation tests length", echo=FALSE, cache=FALSE, message=FALSE, warning=FALSE,fig.height=9, fig.width=6, fig.align='center'}
pcs_corolla_length_no_NA_continent <- all_data[complete.cases(all_data$corolla_tube_length),]
pcs_corolla_length_no_NA_continent <- pcs_corolla_length_no_NA_continent[complete.cases(pcs_corolla_length_no_NA_continent$continent),]
pcs_corolla_length_no_NA_continent$continent <- droplevels(pcs_corolla_length_no_NA_continent$continent)

pcs_corolla_length_no_NA$pollinator_referenced <- droplevels(pcs_corolla_length_no_NA$pollinator_referenced)

# test by continent 
# corolla
independence_test_corolla_length_continent <- independence_test(log(corolla_tube_length+1)~continent, data = pcs_corolla_length_no_NA_continent,distribution = approximate(nresample = 10000))
pvalue_corolla_length_continent <- pvalue(independence_test_corolla_length_continent)[1] %>% data.frame()
colnames(pvalue_corolla_length_continent)[1] <- "corolla_length"       
pvalue_corolla_length_continent <- round(pvalue_corolla_length_continent,3)   

permTest_corolla_length_continent <- pairwisePermutationTest(log(corolla_tube_length+1)~continent,data=pcs_corolla_length_no_NA_continent,distribution = approximate(nresample = 10000))
corolla_length_continent_letters <- cldList(p.adjust~Comparison,data=permTest_corolla_length_continent,threshold=0.05)


independence_test_corolla_length_pollinator_referenced <- independence_test(log(corolla_tube_length+1)~pollinator_referenced, data = pcs_corolla_length_no_NA,distribution = approximate(nresample = 10000))
pvalue_corolla_length_pollinator_referenced <- pvalue(independence_test_corolla_length_pollinator_referenced)[1]  %>% data.frame()
colnames(pvalue_corolla_length_pollinator_referenced)[1] <- "corolla_length"        
pvalue_corolla_length_pollinator_referenced <- round(pvalue_corolla_length_pollinator_referenced,3)   

permTest_corolla_length_pollinator_referenced <- pairwisePermutationTest(log(corolla_tube_length+1)~pollinator_referenced,data=pcs_corolla_length_no_NA,distribution = approximate(nresample = 10000))
corolla_length_pollinator_referenced_letters <- cldList(p.adjust~Comparison,data=permTest_corolla_length_pollinator_referenced,threshold=0.05)


# test by continent 
# anther
pcs_anther_length_no_NA_continent <- all_data_anthers[complete.cases(all_data_anthers$total_large_anther_length),]
pcs_anther_length_no_NA_continent <- pcs_anther_length_no_NA_continent[complete.cases(pcs_anther_length_no_NA_continent$continent),]
pcs_anther_length_no_NA_continent <- droplevels(pcs_anther_length_no_NA_continent)

independence_test_anther_length_continent <- independence_test(log(total_large_anther_length)~continent, data = pcs_anther_length_no_NA_continent,distribution = approximate(nresample = 10000))
pvalue_anther_length_continent <- pvalue(independence_test_anther_length_continent)[1] %>% data.frame()
colnames(pvalue_anther_length_continent)[1] <- "anther_length"       
pvalue_anther_length_continent <- round(pvalue_anther_length_continent,3)   

permTest_anther_length_continent <- pairwisePermutationTest(log(total_large_anther_length)~continent,data=pcs_anther_length_no_NA_continent,distribution = approximate(nresample = 10000))
anther_length_continent_letters <- cldList(p.adjust~Comparison,data=permTest_anther_length_continent,threshold=0.05)

independence_test_anther_length_pollinator_referenced <- independence_test(log(total_large_anther_length)~pollinator_referenced, data = pcs_anther_length_no_NA,distribution = approximate(nresample = 10000))
pvalue_anther_length_pollinator_referenced <- pvalue(independence_test_anther_length_pollinator_referenced)[1]  %>% data.frame()
colnames(pvalue_anther_length_pollinator_referenced)[1] <- "anther_length"        
pvalue_anther_length_pollinator_referenced <- round(pvalue_anther_length_pollinator_referenced,3)   

permTest_anther_length_pollinator_referenced <- pairwisePermutationTest(log(total_large_anther_length)~pollinator_referenced,data=pcs_anther_length_no_NA,distribution = approximate(nresample = 10000))
anther_length_pollinator_referenced_letters <- cldList(p.adjust~Comparison,data=permTest_anther_length_pollinator_referenced,threshold=0.05)
```

```{r, label="descriptive stats corolla length", echo=FALSE, cache=FALSE, message=FALSE, warning=FALSE,fig.height=9, fig.width=6, fig.align='center'}
corolla_length_stats <- describeBy(pcs_corolla_length_no_NA_continent[c(12,2)],group="continent",mat=T) 
corolla_length_stats <- corolla_length_stats[c(7:12),]
corolla_length_stats <- corolla_length_stats[c(2,4:6)]
corolla_length_stats$mean <- round(corolla_length_stats$mean,2)
corolla_length_stats$sd <- round(corolla_length_stats$sd,2)
corolla_length_stats_continent <- cbind(corolla_length_stats,corolla_length_continent_letters[2])
#kable(corolla_length_stats_continent, row.names = F, caption = "Descriptive stats corolla length")


corolla_length_stats <- describeBy(pcs_corolla_length_no_NA[c(6,2)],group="pollinator_referenced",mat=T) 
corolla_length_stats <- corolla_length_stats[c(9:16),]
corolla_length_stats <- corolla_length_stats[c(2,4:6)]
corolla_length_stats$mean <- round(corolla_length_stats$mean,2)
corolla_length_stats$sd <- round(corolla_length_stats$sd,2)
corolla_length_stats_pollinator <- cbind(corolla_length_stats,corolla_length_pollinator_referenced_letters[2])
corolla_length_stats_pollinator$group1 <- gsub("insect","bee", corolla_length_stats_pollinator$group1)
corolla_length_stats_pollinator <- corolla_length_stats_pollinator[order(corolla_length_stats_pollinator$group1),]
#kable(corolla_length_stats_pollinator, row.names = F, caption = "Descriptive stats corolla length")

spp_corolla_length <- pcs_corolla_length_no_NA[1] %>% unique

```

```{r, label="descriptive stats anther length", echo=FALSE, cache=FALSE, message=FALSE, warning=FALSE,fig.height=9, fig.width=6, fig.align='center'}
anther_length_stats <- describeBy(pcs_anther_length_no_NA_continent[c(10,2)],group="continent",mat=T) 
anther_length_stats <- anther_length_stats[c(7:12),]
anther_length_stats <- anther_length_stats[c(2,4:6)]
anther_length_stats$mean <- round(anther_length_stats$mean,2)
anther_length_stats$sd <- round(anther_length_stats$sd,2)
anther_length_stats_continent <- cbind(anther_length_stats,anther_length_continent_letters[2])
#kable(anther_length_stats_continent, row.names = F, caption = "Descriptive stats anther length")

spp_anther_length <- pcs_anther_length_no_NA_continent[1] %>% unique

anther_length_stats <- describeBy(pcs_anther_length_no_NA[c(6,2)],group="pollinator_referenced",mat=T) 
anther_length_stats <- anther_length_stats[c(8:14),]
anther_length_stats <- anther_length_stats[c(2,4:6)]
anther_length_stats$mean <- round(anther_length_stats$mean,2)
anther_length_stats$sd <- round(anther_length_stats$sd,2)
anther_length_stats_pollinator <- cbind(anther_length_stats,anther_length_pollinator_referenced_letters[2])
anther_length_stats_pollinator$group1 <- gsub("insect","bee", anther_length_stats_pollinator$group1)
anther_length_stats_pollinator <- anther_length_stats_pollinator[order(anther_length_stats_pollinator$group1),]
#kable(anther_length_stats_pollinator, row.names = F, caption = "Descriptive stats anther length")
```

```{r, label="descriptive stats together", echo=FALSE, cache=FALSE, message=FALSE, warning=FALSE,fig.height=9, fig.width=6, fig.align='center'}
corolla_length_stats_continent$structure <- "corolla"
corolla_length_stats_continent$variable <- "continent"

corolla_length_stats_pollinator$structure <- "corolla"
corolla_length_stats_pollinator$variable <- "pollinator"

anther_length_stats_continent$structure <- "anther"
anther_length_stats_continent$variable <- "continent"

anther_length_stats_pollinator$structure <- "anther"
anther_length_stats_pollinator$variable <- "pollinator"


stats_lengths <- rbind(corolla_length_stats_continent,corolla_length_stats_pollinator,
      anther_length_stats_continent,anther_length_stats_pollinator)
rownames(stats_lengths) <- NULL

stats_lengths <- stats_lengths[c(6:7,1:5)]
stats_lengths$group1 <- str_to_title(stats_lengths$group1) 
#write.csv(stats_lengths,"stats_lengths.csv",row.names = F)
kable(stats_lengths)
```

\pagebreak

```{r,label="morphospace Fig 2", fig.height=3, fig.width=8, fig.align='center',echo=FALSE, cache=TRUE, message=FALSE, warning=FALSE,eval=T}

par(mfrow=c(1,2))

plot_PCA(pca_efou_flowers, ~continent, morphospace=F, points=F,chull=F,
         zoom=0.85, center_origin = F,legend=F,axes=c(1,2),eigen=T,
    palette=colorRampPalette(c("red","orange","purple","blue","green",
                               "forestgreen"))) %>%
    layer_points(cex=0.2, transp=0.5) %>%
    layer_box(border="black",lwd=2) %>%
    layer_axesvar %>%
    layer_morphospace_PCA(size=0.4, nr = 5, nc = 5, pos="xy") %>%
  layer_chullfilled(0.9) %>% 
  layer_ellipses() 


plot_PCA(pca_efou_anthers, ~continent, morphospace=F, points=F,chull=F,
         zoom=0.85, center_origin = F,legend=F,axes=c(1,2),eigen=T,
         palette=colorRampPalette(c("red","orange","purple","blue","green",
                               "forestgreen"))) %>%
  layer_box(border="black",lwd=2) %>%
  layer_points(cex=0.2, transp=0.5) %>%
  layer_axesvar %>%
  layer_morphospace_PCA(size=0.45, nr = 5, nc = 5, pos="xy",rotate=1.6) %>%
  layer_chullfilled(0.9) %>% 
  layer_ellipses() 
```

```{r,label="morphospace Fig 3", fig.height=3, fig.width=8, fig.align='center',echo=FALSE, cache=TRUE, message=FALSE, warning=FALSE,eval=T}
par(mfrow=c(1,2))

plot_PCA(pca_efou_flowers, ~pollinator_referenced, morphospace=F, points=F,chull=F,
         zoom=0.85, center_origin = F,legend=F,axes=c(1,2),eigen=T,
    palette=colorRampPalette(c("gray","orange","magenta","red","blue","black","gold","green","aquamarine"))) %>%
    layer_points(cex=0.2, transp=0.5) %>%
    layer_box(border="black",lwd=2) %>%
    layer_axesvar %>%
    layer_morphospace_PCA(size=0.4, nr = 5, nc = 5, pos="xy") %>%
  layer_chullfilled(0.9) %>% 
  layer_ellipses() 

plot_PCA(pca_efou_anthers, ~pollinator_referenced, morphospace=F, points=F,chull=F,
         zoom=0.85, center_origin = F,legend=F,axes=c(1,2),eigen=T,
         palette=colorRampPalette(c("gray","orange","magenta","red","blue","black","gold","green","aquamarine"))) %>%
  layer_box(border="black",lwd=2) %>%
  layer_points(cex=0.2, transp=0.5) %>%
  layer_axesvar %>%
  layer_morphospace_PCA(size=0.45, nr = 5, nc = 5, pos="xy",rotate=1.6) %>%
  layer_chullfilled(0.9) %>% 
  layer_ellipses() 
```

\pagebreak

# Comparative methods

```{r, label="import Phylogeny", fig.height=110, fig.width=25,cache=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
tree <- read.tree("phylogeny/ericales.ultrametric_3part.tre") %>% ladderize(right=F)
tip <- tree$tip.label %>% data.frame() %>% setNames("tip")

Agapetes_scortechinii <- extract.clade(tree, getMRCA(tree,c("Agapetes_scortechinii","Vaccinium_crassifolium")))
#branching.times(Agapetes_scortechinii)

Agapetes_buxifolia <- extract.clade(tree, getMRCA(tree,c("Agapetes_buxifolia", "Agapetes_hosseana")))
#branching.times(Agapetes_buxifolia)
```

```{r, label="match phylogeny to corolla shape data", fig.height=110, fig.width=25,cache=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
# reduce to rows of corolla with some data
shape_data_corolla_noNA <- all_data[complete.cases(all_data$PC1_corolla),]

Overlap_corolla_noNA <- name.check(tree, shape_data_corolla_noNA) 
comptree_shape_corolla_noNA <- drop.tip(tree, Overlap_corolla_noNA$tree_not_data)

match_corolla_noNA <- match(comptree_shape_corolla_noNA$tip.label, rownames(shape_data_corolla_noNA))  
sortedData_shape_corolla_noNA <- shape_data_corolla_noNA[,][match_corolla_noNA,]
```

## ASR pollinator

```{r,label="ASR pollinator no pollinator missing", fig.height=15, fig.width=15, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
comptree_corolla_shape_noNA <- average_tr_tips(comptree_shape_corolla_noNA)
sortedData_shape_corolla_noNA$pollinator_referenced <- droplevels(sortedData_shape_corolla_noNA$pollinator_referenced)

### run without missing data
sortedData_shape_corolla_noNA_polli <- subset(sortedData_shape_corolla_noNA, 
                                              !pollinator_referenced=="-")
sortedData_shape_corolla_noNA_polli$pollinator_referenced <- droplevels(sortedData_shape_corolla_noNA_polli$pollinator_referenced)

rownames(sortedData_shape_corolla_noNA_polli) <- sortedData_shape_corolla_noNA_polli$species
Overlap_corolla_noNA_polli <- name.check(comptree_corolla_shape_noNA, sortedData_shape_corolla_noNA_polli) 
comptree_corolla_noNA_polli <- drop.tip(comptree_corolla_shape_noNA, Overlap_corolla_noNA_polli$tree_not_data)
match_corolla_noNA_polli <- match(comptree_corolla_noNA_polli$tip.label, 
                                  rownames(sortedData_shape_corolla_noNA_polli))  
sortedData_shape_corolla_noNA_polli <- sortedData_shape_corolla_noNA_polli[,][match_corolla_noNA_polli,]
comptree_corolla_noNA_polli <- average_tr_tips(comptree_corolla_noNA_polli)


# fitER_454<-fitMk(comptree_corolla_noNA_polli,as.matrix(sortedData_shape_corolla_noNA_polli)[,6],model="ER")
# fitARD_454<-fitMk(comptree_corolla_noNA_polli,as.matrix(sortedData_shape_corolla_noNA_polli)[,6],model="ARD")
# fitSYM_454<-fitMk(comptree_corolla_noNA_polli,as.matrix(sortedData_shape_corolla_noNA_polli)[,6],model="SYM")
# 
# saveRDS(fitER_454,"results/fitER_454.rds")
# saveRDS(fitARD_454,"results/fitARD_454.rds")
# saveRDS(fitSYM_454,"results/fitSYM_454.rds")

# fitER_454<-readRDS("results/fitER_454.rds")
# fitARD_454<-readRDS("results/fitARD_454.rds") # These give errors
# fitSYM_454<-readRDS("results/fitSYM_454.rds") # These give errors

# aic<-as.matrix(sapply(list(ER=fitER_454,ARD=fitARD_454,SYM=fitSYM_454),AIC))
# aic
# aic.w(aic)

###

# recon_yang_454 <- rayDISC(comptree_corolla_noNA_polli,sortedData_shape_corolla_noNA_polli, model="ARD",node.states="marginal",charnum=5, root.p='yang')
# 
# saveRDS(recon_yang_454, "results/recon_yang_454_pollinator_ARD.rds")
recon_yang_454 <- readRDS( "results/recon_yang_454_pollinator_ARD.rds")

# make tip labels
colors_subfamily <- character(length(sortedData_shape_corolla_noNA_polli$subfamily)) 
colors_subfamily[sortedData_shape_corolla_noNA_polli$subfamily == "Arbutoideae"] <- "gold"
colors_subfamily[sortedData_shape_corolla_noNA_polli$subfamily == "Cassiopoideae"] <- "black"
colors_subfamily[sortedData_shape_corolla_noNA_polli$subfamily == "Enkianthoideae"] <- "pink"
colors_subfamily[sortedData_shape_corolla_noNA_polli$subfamily == "Ericoideae"] <- "green"
colors_subfamily[sortedData_shape_corolla_noNA_polli$subfamily == "Harrimanelloideae"] <- "aquamarine"
colors_subfamily[sortedData_shape_corolla_noNA_polli$subfamily == "Monotropoideae"] <- "orange"
colors_subfamily[sortedData_shape_corolla_noNA_polli$subfamily == "Pyroloideae"] <- "brown"
colors_subfamily[sortedData_shape_corolla_noNA_polli$subfamily == "Styphelioideae"] <- "blue"
colors_subfamily[sortedData_shape_corolla_noNA_polli$subfamily == "Vaccinioideae"] <- "red"
colors_subfamily[sortedData_shape_corolla_noNA_polli$subfamily == "outgroup"] <- "black"

# tip labels for pollinators references

cols_pollinator <- character(length(sortedData_shape_corolla_noNA_polli$pollinator_referenced)) 
cols_pollinator[sortedData_shape_corolla_noNA_polli$pollinator_referenced == "-"] <- "white"
cols_pollinator[sortedData_shape_corolla_noNA_polli$pollinator_referenced == "honeyeater"] <- "orange"
cols_pollinator[sortedData_shape_corolla_noNA_polli$pollinator_referenced == "hummingbird"] <- "magenta"
cols_pollinator[sortedData_shape_corolla_noNA_polli$pollinator_referenced == "hummingbird_OW"] <- "red"
cols_pollinator[sortedData_shape_corolla_noNA_polli$pollinator_referenced == "insect"] <- "blue"
cols_pollinator[sortedData_shape_corolla_noNA_polli$pollinator_referenced == "lepidoptera"] <- "black"
cols_pollinator[sortedData_shape_corolla_noNA_polli$pollinator_referenced == "long_proboscid_fly"] <- "gold"
cols_pollinator[sortedData_shape_corolla_noNA_polli$pollinator_referenced == "sunbird"] <- "green"
cols_pollinator[sortedData_shape_corolla_noNA_polli$pollinator_referenced == "wind"] <- "aquamarine"


plot(comptree_corolla_noNA_polli, label.offset=3, show.tip.label=T,cex=0.2, x.lim=130, edge.width=0.25, no.margin=T)
par(lwd = 0.1) 
nodelabels(pie = recon_yang_454$states, piecol = c("orange","magenta","red","blue","black","gold","green","aquamarine"), cex = 0.25)

tiplabels(bg=cols_pollinator, pch=22, cex=0.25, adj=2, lwd=0, col=cols_pollinator)

tiplabels(bg=colors_subfamily, pch=22, cex=0.25, adj=2.75, lwd=0, col=colors_subfamily)

legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
  "Ericoideae","Harrimanelloideae","Monotropoideae","Pyroloideae","Styphelioideae",
  "Vaccinioideae"),title = "Subfamily",inset = 0, pch = 15,
  col = c("gold","black","pink","green","aquamarine","orange","brown","blue","red"),
  adj = 0, cex = 1, pt.cex = 1.5, bty="n", y.intersp = 1)


legend(-5, 375, legend = c("Honeyeater","Hummingbird","Hummingbird OW","Bee","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = 15,
  col = c("orange","magenta","red","blue","black","gold","green","aquamarine"),
  adj = 0,  cex = 1, pt.cex = 1.5, bty="n", y.intersp = 1)
axisPhylo(line=-1, cex.axis=0.75, mgp=c(2, -.1 , 0), tck=FALSE, lwd=0.5)
lines(x=c((branching.times(comptree_corolla_shape_noNA)[1] - 14.5),(branching.times(comptree_corolla_shape_noNA)[1] - 14.5)),y=c(1,900),lwd=1, col="dimgray", lty = "dashed")
```


```{r,label="counts changes no NA", fig.height=4, fig.width=5, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
# Count changes
# Get node states

recons_MCC <- recon_yang_454$states %>% data.frame()
#recons_MCC[recons_MCC >= 0.5] <- 1
#recons_MCC[recons_MCC < 0.5] <- 0
recons_MCC_zero_one <- t(apply(recons_MCC, 1, function(x) as.numeric(x == max(x))))
colnames(recons_MCC_zero_one) <- colnames(recons_MCC)
recons_MCC <- recons_MCC_zero_one %>% data.frame()

recons_MCC$node <- seq(455,907, 1) 

state <- sortedData_shape_corolla_noNA_polli[6]
state$honeyeater <- state$pollinator_referenced
state$hummingbird <- state$pollinator_referenced
state$hummingbird_OW <- state$pollinator_referenced
state$insect <- state$pollinator_referenced
state$lepidoptera <- state$pollinator_referenced
state$long_proboscid_fly <- state$pollinator_referenced
state$sunbird <- state$pollinator_referenced
state$wind <- state$pollinator_referenced

state <- state[c(2:9)]

state$honeyeater <- gsub("honeyeater","1",state$honeyeater)
state$honeyeater <- gsub("hummingbird|hummingbird_OW|insect|lepidoptera|sunbird|long_proboscid_fly|wind",
                         "0", state$honeyeater)

state$hummingbird <- gsub("hummingbird","1",state$hummingbird)
state$hummingbird <- gsub("honeyeater|hummingbird_OW|insect|lepidoptera|sunbird|long_proboscid_fly|wind",
                          "0",state$hummingbird)

state$hummingbird_OW <- gsub("hummingbird_OW","1",state$hummingbird_OW)
state$hummingbird_OW <- gsub("honeyeater|hummingbird|insect|lepidoptera|sunbird|long_proboscid_fly|wind",
                          "0",state$hummingbird_OW)

state$insect <- gsub("insect","1",state$insect)
state$insect <- gsub("honeyeater|hummingbird|hummingbird_OW|lepidoptera|sunbird|long_proboscid_fly|wind",
                             "0",state$insect)

state$lepidoptera <- gsub("lepidoptera","1",state$lepidoptera)
state$lepidoptera <- gsub("honeyeater|hummingbird|hummingbird_OW|insect|sunbird|long_proboscid_fly|wind",
                     "0",state$lepidoptera)

state$long_proboscid_fly <- gsub("long_proboscid_fly","1",state$long_proboscid_fly)
state$long_proboscid_fly <- gsub("honeyeater|hummingbird|hummingbird_OW|insect|lepidoptera|sunbird|wind",
                          "0",state$long_proboscid_fly)

state$sunbird <- gsub("sunbird","1",state$sunbird)
state$sunbird <- gsub("honeyeater|hummingbird|hummingbird_OW|insect|lepidoptera|long_proboscid_fly|wind",
                                 "0",state$sunbird)

state$wind <- gsub("wind","1",state$wind)
state$wind <- gsub("honeyeater|hummingbird|hummingbird_OW|insect|lepidoptera|long_proboscid_fly|sunbird",
                      "0",state$wind)

state$node <- seq(1,454, 1)

recons_MCC <- rbind(state,recons_MCC)

pollinator_prt_MCC <- prt(comptree_corolla_noNA_polli, printflag=F)
pollinator_prt_MCC <- left_join(recons_MCC,pollinator_prt_MCC, "node")

pollinator_anc <- pollinator_prt_MCC[c(1:9,15)]
anc <- pollinator_anc[10]
colnames(anc) <- "node"
pollinator_anc <- left_join(anc,pollinator_anc)

colnames(pollinator_anc)[2:9] <- c("honeyeater_anc","hummingbird_anc","hummingbird_OW_anc",
                                   "insect_anc","lepidoptera_anc","long_proboscid_fly_anc",
                                   "sunbird_anc","wind_anc")
pollinator_prt_MCC <- cbind(pollinator_prt_MCC,pollinator_anc[2:9])

pollinator_prt_MCC$honeyeater_at_node <- paste0(pollinator_prt_MCC$honeyeater,"_",
                                                pollinator_prt_MCC$honeyeater_anc)

changes_honeyeater <- subset(pollinator_prt_MCC, pollinator_prt_MCC$honeyeater_at_node=="1_0")
changes_from_honeyeater <- subset(pollinator_prt_MCC, pollinator_prt_MCC$honeyeater_at_node=="0_1")
all_honeyeater_MCC <- cbind("honeyeater",dim(changes_honeyeater)[1],dim(changes_from_honeyeater)[1]) %>% 
  data.frame() %>% setNames(c("pollinator","to","from"))
#all_honeyeater_MCC

pollinator_prt_MCC$hummingbird_at_node <- paste0(pollinator_prt_MCC$hummingbird,"_",
                                                 pollinator_prt_MCC$hummingbird_anc)
changes_hummingbird <- subset(pollinator_prt_MCC, pollinator_prt_MCC$hummingbird_at_node=="1_0")
changes_from_hummingbird <- subset(pollinator_prt_MCC, pollinator_prt_MCC$hummingbird_at_node=="0_1")
all_hummingbird_MCC <- cbind("hummingbird",dim(changes_hummingbird)[1],dim(changes_from_hummingbird)[1]) %>% data.frame() %>% setNames(c("pollinator","to","from"))
#all_hummingbird_MCC

pollinator_prt_MCC$hummingbird_OW_at_node <- paste0(pollinator_prt_MCC$hummingbird_OW,"_",
                                                    pollinator_prt_MCC$hummingbird_OW_anc)
changes_hummingbird_OW <- subset(pollinator_prt_MCC, pollinator_prt_MCC$hummingbird_OW_at_node=="1_0")
changes_from_hummingbird_OW <- subset(pollinator_prt_MCC, pollinator_prt_MCC$hummingbird_OW_at_node=="0_1")
all_hummingbird_OW_MCC <- cbind("hummingbird_OW",dim(changes_hummingbird_OW)[1],dim(changes_from_hummingbird_OW)[1]) %>% data.frame() %>% setNames(c("pollinator","to","from"))
#all_hummingbird_OW_MCC

pollinator_prt_MCC$insect_at_node <- paste0(pollinator_prt_MCC$insect,"_",
                                            pollinator_prt_MCC$insect_anc)
changes_insect <- subset(pollinator_prt_MCC, pollinator_prt_MCC$insect_at_node=="1_0")
changes_from_insect <- subset(pollinator_prt_MCC, pollinator_prt_MCC$insect_at_node=="0_1")
all_insect_MCC <- cbind("insect",dim(changes_insect)[1],dim(changes_from_insect)[1]) %>% data.frame() %>% setNames(c("pollinator","to","from"))
#all_insect_MCC

pollinator_prt_MCC$lepidoptera_at_node <- paste0(pollinator_prt_MCC$lepidoptera,"_",
                                                 pollinator_prt_MCC$lepidoptera_anc)
changes_lepidoptera <- subset(pollinator_prt_MCC, pollinator_prt_MCC$lepidoptera_at_node=="1_0")
changes_from_lepidoptera <- subset(pollinator_prt_MCC, pollinator_prt_MCC$lepidoptera_at_node=="0_1")
all_lepidoptera_MCC <- cbind("lepidoptera",dim(changes_lepidoptera)[1],dim(changes_from_lepidoptera)[1]) %>% data.frame() %>% setNames(c("pollinator","to","from"))
#all_lepidoptera_MCC

pollinator_prt_MCC$long_proboscid_fly_at_node <- paste0(pollinator_prt_MCC$long_proboscid_fly,"_",
                                                        pollinator_prt_MCC$long_proboscid_fly_anc)
changes_long_proboscid_fly <- subset(pollinator_prt_MCC, pollinator_prt_MCC$long_proboscid_fly_at_node=="1_0")
changes_from_long_proboscid_fly <- subset(pollinator_prt_MCC, pollinator_prt_MCC$long_proboscid_fly_at_node=="0_1")
all_long_proboscid_fly_MCC <- cbind("long_proboscid_fly",dim(changes_long_proboscid_fly)[1],dim(changes_from_long_proboscid_fly)[1]) %>% data.frame() %>% setNames(c("pollinator","to","from"))
#all_long_proboscid_fly_MCC

pollinator_prt_MCC$sunbird_at_node <- paste0(pollinator_prt_MCC$sunbird,"_",
                                             pollinator_prt_MCC$sunbird_anc)
changes_sunbird <- subset(pollinator_prt_MCC, pollinator_prt_MCC$sunbird_at_node=="1_0")
changes_from_sunbird <- subset(pollinator_prt_MCC, pollinator_prt_MCC$sunbird_at_node=="0_1")
all_sunbird_MCC <- cbind("sunbird",dim(changes_sunbird)[1],dim(changes_from_sunbird)[1]) %>% data.frame() %>% setNames(c("pollinator","to","from"))
#all_sunbird_MCC

pollinator_prt_MCC$wind_at_node <- paste0(pollinator_prt_MCC$wind,"_",
                                          pollinator_prt_MCC$wind_anc)
changes_wind <- subset(pollinator_prt_MCC, pollinator_prt_MCC$wind_at_node=="1_0")
changes_from_wind <- subset(pollinator_prt_MCC, pollinator_prt_MCC$wind_at_node=="0_1")
all_wind_MCC <- cbind("wind",dim(changes_wind)[1],dim(changes_from_wind)[1]) %>% data.frame() %>% setNames(c("pollinator","to","from"))
#all_wind_MCC

###
changes_noNA_polli <- rbind(all_honeyeater_MCC,all_hummingbird_MCC,all_hummingbird_OW_MCC,
      all_insect_MCC,all_lepidoptera_MCC,all_long_proboscid_fly_MCC,all_sunbird_MCC,all_wind_MCC) 
```

```{r,label="ASR pollinator", fig.height=8, fig.width=7, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}

# There is missing data as "-" so the model fitting will not make sense. Initially I didn't realize this.
# fitER<-fitMk(comptree_corolla_shape_noNA,as.matrix(sortedData_shape_corolla_noNA)[,6],model="ER")
# fitARD<-fitMk(comptree_corolla_shape_noNA,as.matrix(sortedData_shape_corolla_noNA)[,6],model="ARD")
# fitSYM<-fitMk(comptree_corolla_shape_noNA,as.matrix(sortedData_shape_corolla_noNA)[,6],model="SYM")

# saveRDS(fitER,"results/fitER.rds")
# saveRDS(fitARD,"results/fitARD.rds")
# saveRDS(fitSYM,"results/fitSYM.rds")

# fitER<-readRDS("results/fitER.rds")
# fitARD<-readRDS("results/fitARD.rds") # These give errors
# fitSYM<-readRDS("results/fitSYM.rds") # These give errors
# 
# aic<-as.matrix(sapply(list(ER=fitER,ARD=fitARD,SYM=fitSYM),AIC))
# aic
###

sortedData_shape_corolla_w_questionmarks <- sortedData_shape_corolla_noNA

# sortedData_shape_corolla_w_questionmarks$pollinator_referenced <- gsub("-","?",sortedData_shape_corolla_w_questionmarks$pollinator_referenced)

# recon_yang <- rayDISC(comptree_corolla_shape_noNA,sortedData_shape_corolla_w_questionmarks, model="ER",node.states="marginal",charnum=5, root.p='yang')

 #saveRDS(recon_yang, "results/recon_yang_672_pollinator_ER.rds")

recon_yang_672 <- readRDS( "results/recon_yang_672_pollinator_ER.rds")

colors_subfamily <- character(length(sortedData_shape_corolla_noNA$subfamily)) 
colors_subfamily[sortedData_shape_corolla_noNA$subfamily == "Arbutoideae"] <- "gold"
colors_subfamily[sortedData_shape_corolla_noNA$subfamily == "Cassiopoideae"] <- "black"
colors_subfamily[sortedData_shape_corolla_noNA$subfamily == "Enkianthoideae"] <- "pink"
colors_subfamily[sortedData_shape_corolla_noNA$subfamily == "Ericoideae"] <- "green"
colors_subfamily[sortedData_shape_corolla_noNA$subfamily == "Harrimanelloideae"] <- "aquamarine"
colors_subfamily[sortedData_shape_corolla_noNA$subfamily == "Monotropoideae"] <- "orange"
colors_subfamily[sortedData_shape_corolla_noNA$subfamily == "Pyroloideae"] <- "brown"
colors_subfamily[sortedData_shape_corolla_noNA$subfamily == "Styphelioideae"] <- "blue"
colors_subfamily[sortedData_shape_corolla_noNA$subfamily == "Vaccinioideae"] <- "red"
colors_subfamily[sortedData_shape_corolla_noNA$subfamily == "outgroup"] <- "black"

# tip labels for pollinators references

cols_pollinator <- character(length(sortedData_shape_corolla_noNA$pollinator_referenced)) 
cols_pollinator[sortedData_shape_corolla_noNA$pollinator_referenced == "-"] <- "white"
cols_pollinator[sortedData_shape_corolla_noNA$pollinator_referenced == "honeyeater"] <- "orange"
cols_pollinator[sortedData_shape_corolla_noNA$pollinator_referenced == "hummingbird"] <- "magenta"
cols_pollinator[sortedData_shape_corolla_noNA$pollinator_referenced == "hummingbird_OW"] <- "red"
cols_pollinator[sortedData_shape_corolla_noNA$pollinator_referenced == "insect"] <- "blue"
cols_pollinator[sortedData_shape_corolla_noNA$pollinator_referenced == "lepidoptera"] <- "black"
cols_pollinator[sortedData_shape_corolla_noNA$pollinator_referenced == "long_proboscid_fly"] <- "gold"
cols_pollinator[sortedData_shape_corolla_noNA$pollinator_referenced == "sunbird"] <- "green"
cols_pollinator[sortedData_shape_corolla_noNA$pollinator_referenced == "wind"] <- "aquamarine"

# shifts with l1ou

#corolla_shapePC1_shifts_noNA <- adjust_data(comptree_corolla_shape_noNA, sortedData_shape_corolla_noNA[,3]) 
#shifts_corolla_shapePC1_shifts_noNA <- estimate_shift_configuration(corolla_shapePC1_shifts_noNA$tree, corolla_shapePC1_shifts_noNA$Y, max.nShifts=50, root.model="OUrandomRoot",  criterion="pBIC")  
#saveRDS(shifts_corolla_shapePC1_shifts_noNA,"results/shifts_corolla_noNA_PC1.rds")
shifts_corolla_shapePC1_noNA <-readRDS("results/shifts_corolla_noNA_PC1.rds")

#plot(shifts_corolla_shapePC1_noNA,edge.width=0.5, show.tip.label=F,cex=0.25,edge.shift.ann=F)

### estimate convergent shifts

#conv_shifts_corolla_shapePC1_noNA <- estimate_convergent_regimes(shifts_corolla_shapePC1_noNA, criterion =  "pBIC",method = "backward",fixed.alpha = FALSE, nCores = 4)
#saveRDS(conv_shifts_corolla_shapePC1_noNA,"results/conv_shifts_corolla_noNA_PC1.rds")
conv_shifts_corolla_shapePC1_noNA <- readRDS("results/conv_shifts_corolla_noNA_PC1.rds")

##
plot(comptree_corolla_shape_noNA, show.tip.label=F, x.lim=130, edge.width=0.25)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=1.95, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.1, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.25, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.4, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.55, lwd=0, col=cols_pollinator)

tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.65, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.8, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.95, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=4.1, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=4.25, lwd=0, col=colors_subfamily)


par(lwd = 0.1)
nodelabels(pie = recon_yang_672$states, piecol = c("orange","magenta","red","blue","black","gold","green","aquamarine"), cex = 0.3)

#nodelabels(frame="n",col="green",cex=0.2)

legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
  "Ericoideae","Harrimanelloideae","Monotropoideae","Pyroloideae","Styphelioideae",
  "Vaccinioideae"),title = "Subfamily",inset = 0, pch = 15,
  col = c("gold","black","pink","green","aquamarine","orange","brown","blue","red"),
  adj = 0, cex = 0.6, pt.cex = 0.8, bty="n", y.intersp = 1)


legend(18,695, legend = c("Honeyeater","Hummingbird","Hummingbird OW","Bee","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = 15,
  col = c("orange","magenta","red","blue","black","gold","green","aquamarine"),
  adj = 0,  cex = 0.6, pt.cex = 0.8, bty="n", y.intersp = 1)
axisPhylo(line=-0.4, cex.axis=0.5, mgp=c(3, -.3 , 0), tck=-0.01, lwd=0.5)
lines(x=c((branching.times(comptree_corolla_shape_noNA)[1] - 14.5),(branching.times(comptree_corolla_shape_noNA)[1] - 14.5)),y=c(1,900),lwd=1, col="dimgray", lty = "dashed")

```

```{r,label="counts changes all taxa", fig.height=4, fig.width=5, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
# Count changes
# Get node states
recons_MCC <- recon_yang_672$states %>%
  data.frame()
# recons_MCC[recons_MCC >= 0.5] <- 1
# recons_MCC[recons_MCC < 0.5] <- 0

recons_MCC_zero_one <- t(apply(recons_MCC, 1, function(x) as.numeric(x == max(x))))
colnames(recons_MCC_zero_one) <- colnames(recons_MCC)
recons_MCC <- recons_MCC_zero_one %>% data.frame()


recons_MCC$node <- seq(673,1343, 1) 

state <- sortedData_shape_corolla_noNA[6]
state$honeyeater <- state$pollinator_referenced
state$hummingbird <- state$pollinator_referenced
state$hummingbird_OW <- state$pollinator_referenced
state$insect <- state$pollinator_referenced
state$lepidoptera <- state$pollinator_referenced
state$long_proboscid_fly <- state$pollinator_referenced
state$sunbird <- state$pollinator_referenced
state$wind <- state$pollinator_referenced

state <- state[c(2:9)]

state$honeyeater <- gsub("honeyeater","1",state$honeyeater)
state$honeyeater <- gsub("hummingbird|hummingbird_OW|insect|lepidoptera|sunbird|long_proboscid_fly|wind",
                         "0", state$honeyeater)

state$hummingbird <- gsub("hummingbird","1",state$hummingbird)
state$hummingbird <- gsub("honeyeater|hummingbird_OW|insect|lepidoptera|sunbird|long_proboscid_fly|wind",
                          "0",state$hummingbird)

state$hummingbird_OW <- gsub("hummingbird_OW","1",state$hummingbird_OW)
state$hummingbird_OW <- gsub("honeyeater|hummingbird|insect|lepidoptera|sunbird|long_proboscid_fly|wind",
                          "0",state$hummingbird_OW)

state$insect <- gsub("insect","1",state$insect)
state$insect <- gsub("honeyeater|hummingbird|hummingbird_OW|lepidoptera|sunbird|long_proboscid_fly|wind",
                             "0",state$insect)

state$lepidoptera <- gsub("lepidoptera","1",state$lepidoptera)
state$lepidoptera <- gsub("honeyeater|hummingbird|hummingbird_OW|insect|sunbird|long_proboscid_fly|wind",
                     "0",state$lepidoptera)

state$long_proboscid_fly <- gsub("long_proboscid_fly","1",state$long_proboscid_fly)
state$long_proboscid_fly <- gsub("honeyeater|hummingbird|hummingbird_OW|insect|lepidoptera|sunbird|wind",
                          "0",state$long_proboscid_fly)

state$sunbird <- gsub("sunbird","1",state$sunbird)
state$sunbird <- gsub("honeyeater|hummingbird|hummingbird_OW|insect|lepidoptera|long_proboscid_fly|wind",
                                 "0",state$sunbird)

state$wind <- gsub("wind","1",state$wind)
state$wind <- gsub("honeyeater|hummingbird|hummingbird_OW|insect|lepidoptera|long_proboscid_fly|sunbird",
                      "0",state$wind)

state$node <- seq(1,672, 1)

recons_MCC <- rbind(state,recons_MCC)

pollinator_prt_MCC <- prt(comptree_corolla_shape_noNA, printflag=F)
pollinator_prt_MCC <- left_join(recons_MCC,pollinator_prt_MCC, "node")

pollinator_anc <- pollinator_prt_MCC[c(1:9,15)]
anc <- pollinator_anc[10]
colnames(anc) <- "node"
pollinator_anc <- left_join(anc,pollinator_anc)

colnames(pollinator_anc)[2:9] <- c("honeyeater_anc","hummingbird_anc","hummingbird_OW_anc",
                                   "insect_anc","lepidoptera_anc","long_proboscid_fly_anc",
                                   "sunbird_anc","wind_anc")
pollinator_prt_MCC <- cbind(pollinator_prt_MCC,pollinator_anc[2:9])

pollinator_prt_MCC$honeyeater_at_node <- paste0(pollinator_prt_MCC$honeyeater,"_",
                                                pollinator_prt_MCC$honeyeater_anc)

changes_honeyeater <- subset(pollinator_prt_MCC, pollinator_prt_MCC$honeyeater_at_node=="1_0")
changes_from_honeyeater <- subset(pollinator_prt_MCC, pollinator_prt_MCC$honeyeater_at_node=="0_1")
all_honeyeater_MCC <- cbind("honeyeater",dim(changes_honeyeater)[1],dim(changes_from_honeyeater)[1]) %>% 
  data.frame() %>% setNames(c("pollinator","to","from"))
#all_honeyeater_MCC

pollinator_prt_MCC$hummingbird_at_node <- paste0(pollinator_prt_MCC$hummingbird,"_",
                                                 pollinator_prt_MCC$hummingbird_anc)
changes_hummingbird <- subset(pollinator_prt_MCC, pollinator_prt_MCC$hummingbird_at_node=="1_0")
changes_from_hummingbird <- subset(pollinator_prt_MCC, pollinator_prt_MCC$hummingbird_at_node=="0_1")
all_hummingbird_MCC <- cbind("hummingbird",dim(changes_hummingbird)[1],dim(changes_from_hummingbird)[1]) %>% data.frame() %>% setNames(c("pollinator","to","from"))
#all_hummingbird_MCC

pollinator_prt_MCC$hummingbird_OW_at_node <- paste0(pollinator_prt_MCC$hummingbird_OW,"_",
                                                    pollinator_prt_MCC$hummingbird_OW_anc)
changes_hummingbird_OW <- subset(pollinator_prt_MCC, pollinator_prt_MCC$hummingbird_OW_at_node=="1_0")
changes_from_hummingbird_OW <- subset(pollinator_prt_MCC, pollinator_prt_MCC$hummingbird_OW_at_node=="0_1")
all_hummingbird_OW_MCC <- cbind("hummingbird_OW",dim(changes_hummingbird_OW)[1],dim(changes_from_hummingbird_OW)[1]) %>% data.frame() %>% setNames(c("pollinator","to","from"))
#all_hummingbird_OW_MCC

pollinator_prt_MCC$insect_at_node <- paste0(pollinator_prt_MCC$insect,"_",
                                            pollinator_prt_MCC$insect_anc)
changes_insect <- subset(pollinator_prt_MCC, pollinator_prt_MCC$insect_at_node=="1_0")
changes_from_insect <- subset(pollinator_prt_MCC, pollinator_prt_MCC$insect_at_node=="0_1")
all_insect_MCC <- cbind("insect",dim(changes_insect)[1],dim(changes_from_insect)[1]) %>% data.frame() %>% setNames(c("pollinator","to","from"))
#all_insect_MCC

pollinator_prt_MCC$lepidoptera_at_node <- paste0(pollinator_prt_MCC$lepidoptera,"_",
                                                 pollinator_prt_MCC$lepidoptera_anc)
changes_lepidoptera <- subset(pollinator_prt_MCC, pollinator_prt_MCC$lepidoptera_at_node=="1_0")
changes_from_lepidoptera <- subset(pollinator_prt_MCC, pollinator_prt_MCC$lepidoptera_at_node=="0_1")
all_lepidoptera_MCC <- cbind("lepidoptera",dim(changes_lepidoptera)[1],dim(changes_from_lepidoptera)[1]) %>% data.frame() %>% setNames(c("pollinator","to","from"))
#all_lepidoptera_MCC

pollinator_prt_MCC$long_proboscid_fly_at_node <- paste0(pollinator_prt_MCC$long_proboscid_fly,"_",
                                                        pollinator_prt_MCC$long_proboscid_fly_anc)
changes_long_proboscid_fly <- subset(pollinator_prt_MCC, pollinator_prt_MCC$long_proboscid_fly_at_node=="1_0")
changes_from_long_proboscid_fly <- subset(pollinator_prt_MCC, pollinator_prt_MCC$long_proboscid_fly_at_node=="0_1")
all_long_proboscid_fly_MCC <- cbind("long_proboscid_fly",dim(changes_long_proboscid_fly)[1],dim(changes_from_long_proboscid_fly)[1]) %>% data.frame() %>% setNames(c("pollinator","to","from"))
#all_long_proboscid_fly_MCC

pollinator_prt_MCC$sunbird_at_node <- paste0(pollinator_prt_MCC$sunbird,"_",
                                             pollinator_prt_MCC$sunbird_anc)
changes_sunbird <- subset(pollinator_prt_MCC, pollinator_prt_MCC$sunbird_at_node=="1_0")
changes_from_sunbird <- subset(pollinator_prt_MCC, pollinator_prt_MCC$sunbird_at_node=="0_1")
all_sunbird_MCC <- cbind("sunbird",dim(changes_sunbird)[1],dim(changes_from_sunbird)[1]) %>% data.frame() %>% setNames(c("pollinator","to","from"))
#all_sunbird_MCC

pollinator_prt_MCC$wind_at_node <- paste0(pollinator_prt_MCC$wind,"_",
                                          pollinator_prt_MCC$wind_anc)
changes_wind <- subset(pollinator_prt_MCC, pollinator_prt_MCC$wind_at_node=="1_0")
changes_from_wind <- subset(pollinator_prt_MCC, pollinator_prt_MCC$wind_at_node=="0_1")
all_wind_MCC <- cbind("wind",dim(changes_wind)[1],dim(changes_from_wind)[1]) %>% data.frame() %>% setNames(c("pollinator","to","from"))
#all_wind_MCC

###
changes_withNA_polli <- rbind(all_honeyeater_MCC,all_hummingbird_MCC,all_hummingbird_OW_MCC,
      all_insect_MCC,all_lepidoptera_MCC,all_long_proboscid_fly_MCC,all_sunbird_MCC,all_wind_MCC) 
```

```{r,label="changes together", fig.height=4, fig.width=5, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}

changes_noNA_polli$species <- "454"
changes_withNA_polli$species <- "672"

changes <- cbind(changes_noNA_polli, changes_withNA_polli[2:4])
changes <- changes[c(1,4,2:3,7,5:6)]
changes %>% kable()
```

## Shift detection
### Corolla

#### Shape

```{r,label="shifts corolla PC1PC2 PhyloEm", fig.height=6, fig.width=6.5, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
####### Now PhylogeneticEM
#PC1PC2_EM_ready <- t(sortedData_shape_corolla_noNA[3:4])
#colnames(PC1PC2_EM_ready) <- sortedData_shape_corolla_noNA$species
#PhyloEM_PC1PC2 <- PhyloEM(phylo = comptree_corolla_shape_noNA,
#                       Y_data = PC1PC2_EM_ready,
#                       process = "scOU",          ## scalar OU model
#                       random.root = TRUE,        ## Root is stationary
#                       stationary.root = TRUE,    ## On a grid of alpha
#                       K_max = 50,      
#                       nbr_alpha = 4, 
#                       parallel_alpha = TRUE,     ## This can be set to TRUE for
#                       Ncores = 4)   

#saveRDS(PhyloEM_PC1PC2,"results/PhyloEM_PC1PC2.rds")
PhyloEM_PC1PC2 <- readRDS("results/PhyloEM_PC1PC2.rds")
PhyloEM_PC1PC2_params <- params_process(PhyloEM_PC1PC2)
#PhyloEM_PC1PC2_params$shifts$edges %>% data.frame() %>% dim()

cols_edges_corolla_shape_noNA <- character(length(comptree_corolla_shape_noNA$edge)) 
cols_edges_corolla_shape_noNA[1:2684] <- "gray"
cols_edges_corolla_shape_noNA[13:113] <- "orange"
cols_edges_corolla_shape_noNA[126:276] <- "magenta"
cols_edges_corolla_shape_noNA[277:695] <- "aquamarine"
cols_edges_corolla_shape_noNA[551:695] <- "purple"
cols_edges_corolla_shape_noNA[710:724] <- "blue"
cols_edges_corolla_shape_noNA[728:730] <- "forestgreen"
cols_edges_corolla_shape_noNA[1069:1069] <- "gold"
cols_edges_corolla_shape_noNA[1074:1342] <- "green"
cols_edges_corolla_shape_noNA[1153:1211] <- "brown"
cols_edges_corolla_shape_noNA[1221:1271] <- "skyblue"
cols_edges_corolla_shape_noNA[1303:1305] <- "red"

cols_tips_corolla_shape_noNA <- character(length(comptree_corolla_shape_noNA$tip.label)) 
cols_tips_corolla_shape_noNA[1:672] <- "gray"
cols_tips_corolla_shape_noNA[1:51] <- "orange"
cols_tips_corolla_shape_noNA[55:130] <- "magenta"
cols_tips_corolla_shape_noNA[131:340] <- "aquamarine"
cols_tips_corolla_shape_noNA[201:273] <- "purple"
cols_tips_corolla_shape_noNA[349:356] <- "blue"
cols_tips_corolla_shape_noNA[363:364] <- "forestgreen"
cols_tips_corolla_shape_noNA[486:486] <- "gold"
cols_tips_corolla_shape_noNA[532:666] <- "green"
cols_tips_corolla_shape_noNA[634:663] <- "brown"
cols_tips_corolla_shape_noNA[561:586] <- "skyblue"
cols_tips_corolla_shape_noNA[610:611] <- "red"

# plot(PhyloEM_PC1PC2,automatic_colors=F,color_edges=cols_edges_corolla_shape_noNA,
#      color_characters=cols_tips_corolla_shape_noNA,root.edge=F, show.tip.label=F, label_cex=0.1, shifts_cex=0.25)
# 
# tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=1.95, lwd=0, col=cols_pollinator)
# tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.1, lwd=0, col=cols_pollinator)
# tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.25, lwd=0, col=cols_pollinator)
# tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.4, lwd=0, col=cols_pollinator)
# tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.55, lwd=0, col=cols_pollinator)
# 
# tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.65, lwd=0, col=colors_subfamily)
# tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.8, lwd=0, col=colors_subfamily)
# tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.95, lwd=0, col=colors_subfamily)
# tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=4.1, lwd=0, col=colors_subfamily)
# tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=4.25, lwd=0, col=colors_subfamily)
# 
# #par(lwd = 0.1)
# #nodelabels(pie = recon_yang_672_pollinator_referenced$states, piecol = c("orange","magenta","blue","green"), cex = 0.2)
# legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
#   "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
#   "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
#   col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
#   adj = 0, cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
# 
# legend(18,750, legend = c("Honeyeater","Hummingbird","Hummingbird OW","Bee","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
#   col = c("orange","magenta","red","blue","black","gold","green","aquamarine"),
#   adj = 0,  cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
# 
# axisPhylo(line=-2, cex.axis=0.5, mgp=c(3, -.3 , 0), tck=-0.01, lwd=0.5)
# lines(x=c((branching.times(comptree_corolla_shape_noNA)[1] - 14.5),(branching.times(comptree_corolla_shape_noNA)[1] - 14.5)),y=c(1,900),lwd=1, col="dimgray", lty = "dashed")
```

- PhylogeneticEM

```{r,label="shifts corolla PC1PC2 PhyloEm with ASR", fig.height=8, fig.width=8.5, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
plot(PhyloEM_PC1PC2,automatic_colors=F,color_edges=cols_edges_corolla_shape_noNA,
     color_characters=cols_tips_corolla_shape_noNA,root.edge=F, show.tip.label=F, label_cex=0.1, shifts_cex=0.25)


tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=1.95, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=2.1, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=2.25, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=2.4, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=2.55, lwd=0, col=colors_subfamily)

tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=3.65, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=3.8, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=3.95, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=4.1, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=4.25, lwd=0, col=cols_pollinator)


par(lwd = 0.1)
nodelabels(pie = recon_yang_672$states, piecol = c("orange","magenta","red","blue","black","gold","green","aquamarine"), cex = 0.2)

legend(1,760,  legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
  "Ericoideae","Harrimanelloideae","Monotropoideae","Pyroloideae","Styphelioideae",
  "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
  col = c("gold","black","pink","green","aquamarine","orange","brown","blue","red"),
  adj = 0, cex = 0.4, pt.cex = 0.55, y.intersp = 1)

legend(20,760, legend = c("Bee","Honeyeater","Hummingbird","Hummingbird OW","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
  col = c("blue","orange","magenta","red","black","gold","green","aquamarine"),
  adj = 0,  cex = 0.4, pt.cex = 0.55,  y.intersp = 1)

axisPhylo(line=-2, cex.axis=0.5, mgp=c(3, -.3 , 0), tck=-0.01, lwd=0.5)

lines(x=c((branching.times(comptree_corolla_shape_noNA)[1] - 14.5),(branching.times(comptree_corolla_shape_noNA)[1] - 14.5)),y=c(1,900),lwd=1, col="dimgray", lty = "dashed")

```


```{r,label="shifts corolla PC1PC2 PhyloEM with tips", fig.height=45, fig.width=15,fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE, eval=T}
plot(PhyloEM_PC1PC2, show.tip.label=T, cex=0.075,edge.width=2)
edgelabels(frame="n",cex=0.2)
tiplabels(bg=colors_subfamily, pch=22, cex=0.3, adj=2.5, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.3, adj=2.8, lwd=0, col=colors_subfamily)

legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
  "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
  "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
  col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
  adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)
```

\pagebreak

- l1ou

```{r,label="shifts corolla PC1PC2 l1ou", fig.height=8, fig.width=8.5, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
### estimate shifts
#corolla_shape_shifts_noNA <- adjust_data(comptree_corolla_shape_noNA, sortedData_shape_corolla_noNA[,c(3:4)]) 
#shifts_corolla_shape_shifts_noNA <- estimate_shift_configuration(corolla_shape_shifts_noNA$tree, corolla_shape_shifts_noNA$Y, max.nShifts=50, root.model="OUrandomRoot",  criterion="pBIC")  
#saveRDS(shifts_corolla_shape_shifts_noNA,"results/corolla_shifts_noNA_2shapevars.rds")
corolla_shape_shifts_noNA <- readRDS("results/corolla_shifts_noNA_2shapevars.rds")
### estimate convergent shifts
#conv_corolla_shape_shifts_noNA <- estimate_convergent_regimes(corolla_shape_shifts_noNA, criterion =  "pBIC",method = "backward",fixed.alpha = FALSE, nCores = 4)
#saveRDS(conv_corolla_shape_shifts_noNA,"results/conv_corolla_shifts_noNA_2shapevars.rds")
conv_corolla_shape_shifts_noNA <- readRDS("results/conv_corolla_shifts_noNA_2shapevars.rds")
###
plot(corolla_shape_shifts_noNA, show.tip.label=F, cex=0.2,edge.shift.ann=F,edge.ann.cex=0.5)

tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.51, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.512, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.513, lwd=0, col=cols_pollinator)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.52, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.522, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.523, lwd=0, col=colors_subfamily)
par(lwd = 0.1)
nodelabels(pie = recon_yang_672$states, piecol = c("orange","magenta","red","blue","black","gold","green","aquamarine"), cex = 0.3)
legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
  "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
  "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
  col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
  adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)

legend(0.3,700, legend = c("Bee","Honeyeater","Hummingbird","Hummingbird OW","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
  col = c("blue","orange","magenta","red","black","gold","green","aquamarine"),
  adj = 0,  cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)
```

```{r,label="shifts corolla PC1PC2 l1ou with tips", fig.height=45, fig.width=25,fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE, eval=T}
 plot(corolla_shape_shifts_noNA, show.tip.label=T, cex=0.4,edge.shift.ann=F)
 tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.52, lwd=0, col=colors_subfamily)
 tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.54, lwd=0, col=cols_pollinator)
 par(lwd = 0.1)
 nodelabels(pie = recon_yang_672$states, piecol = c("orange","magenta","blue","green"), cex = 0.3)
 
 legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
   "Ericoideae","Harrimanelloideae","Monotropoideae","Pyroloideae","Styphelioideae",
   "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
  col = c("gold","black","pink","green","aquamarine","orange","brown","blue","red"),
   adj = 0, cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)


 legend(0.4,675, legend = c("Honeyeater","Hummingbird","Hummingbird OW","Bee","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
   col = c("orange","magenta","red","blue","black","gold","green","aquamarine"),
   adj = 0, text.font = 2, cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
```

\pagebreak

#### Size
 
```{r, label="match phylogeny to corolla length no NA", fig.height=4, fig.width=5, cache=FALSE,fig.align='center', echo=FALSE, message=FALSE, warning=FALSE} 
# reduce to rows of corolla with some data
corolla_length_noNA <- all_data[complete.cases(all_data$corolla_tube_length),]
Overlap_corolla_noNA <- name.check(tree, corolla_length_noNA) 
comptree_corolla_noNA <- drop.tip(tree, Overlap_corolla_noNA$tree_not_data)
match_corolla_noNA <- match(comptree_corolla_noNA$tip.label, rownames(corolla_length_noNA))  
sortedData_corolla_noNA <- corolla_length_noNA[,][match_corolla_noNA,]
comptree_corolla_noNA <- average_tr_tips(comptree_corolla_noNA)

sortedData_corolla_noNA$pollinator_referenced[is.na(sortedData_corolla_noNA$pollinator_referenced)] <- "-"

#sortedData_corolla_noNA$pollinator_referenced <- #droplevels(sortedData_corolla_noNA$pollinator_referenced)

### ASR

sortedData_corolla_noNA_w_questionmarks <- sortedData_corolla_noNA

sortedData_corolla_noNA_w_questionmarks$pollinator_referenced <- gsub("-","?",sortedData_corolla_noNA_w_questionmarks$pollinator_referenced)

# recon_yang_corolla_length <- rayDISC(comptree_corolla_noNA,sortedData_corolla_noNA_w_questionmarks,model="ER",node.states="marginal",charnum = 5, root.p='yang')
# saveRDS(recon_yang_corolla_length, "results/recon_yang_1021_pollinator_ER.rds")
recon_yang_size <- readRDS( "results/recon_yang_1021_pollinator_ER.rds")

### tiplabels
colors_subfamily <- character(length(sortedData_corolla_noNA$subfamily)) 
colors_subfamily[sortedData_corolla_noNA$subfamily == "Arbutoideae"] <- "gold"
colors_subfamily[sortedData_corolla_noNA$subfamily == "Cassiopoideae"] <- "black"
colors_subfamily[sortedData_corolla_noNA$subfamily == "Enkianthoideae"] <- "pink"
colors_subfamily[sortedData_corolla_noNA$subfamily == "Ericoideae"] <- "green"
colors_subfamily[sortedData_corolla_noNA$subfamily == "Harrimanelloideae"] <- "aquamarine"
colors_subfamily[sortedData_corolla_noNA$subfamily == "Monotropoideae"] <- "orange"
colors_subfamily[sortedData_corolla_noNA$subfamily == "Pyroloideae"] <- "brown"
colors_subfamily[sortedData_corolla_noNA$subfamily == "Styphelioideae"] <- "blue"
colors_subfamily[sortedData_corolla_noNA$subfamily == "Vaccinioideae"] <- "red"
colors_subfamily[sortedData_corolla_noNA$subfamily == "outgroup"] <- "black"
# tip labels for pollinators references
cols_pollinator <- character(length(sortedData_corolla_noNA$pollinator_referenced)) 
cols_pollinator[sortedData_corolla_noNA$pollinator_referenced == "-"] <- "white"
cols_pollinator[sortedData_corolla_noNA$pollinator_referenced == "honeyeater"] <- "orange"
cols_pollinator[sortedData_corolla_noNA$pollinator_referenced == "hummingbird"] <- "magenta"
cols_pollinator[sortedData_corolla_noNA$pollinator_referenced == "hummingbird_OW"] <- "red"
cols_pollinator[sortedData_corolla_noNA$pollinator_referenced == "insect"] <- "blue"
cols_pollinator[sortedData_corolla_noNA$pollinator_referenced == "lepidoptera"] <- "black"
cols_pollinator[sortedData_corolla_noNA$pollinator_referenced == "long_proboscid_fly"] <- "gold"
cols_pollinator[sortedData_corolla_noNA$pollinator_referenced == "sunbird"] <- "green"
cols_pollinator[sortedData_corolla_noNA$pollinator_referenced == "wind"] <- "aquamarine"
```

- PhylogeneticEM

```{r, label="shifts corolla length no NA PhyloEM", fig.height=9, fig.width=9,cache=FALSE,fig.align='center', echo=FALSE, message=FALSE, warning=FALSE}

sortedData_corolla_noNA$log_corolla_tube_length <- log(sortedData_corolla_noNA$corolla_tube_length+1)

# corolla_length_EM_ready <- t(sortedData_corolla_noNA[13])
# colnames(corolla_length_EM_ready) <- sortedData_corolla_noNA$species
# PhyloEM_corolla_length <- PhyloEM(phylo = comptree_corolla_noNA,
#                       Y_data = corolla_length_EM_ready,
#                       process = "scOU",
#                       random.root = TRUE,
#                       stationary.root = TRUE,
#                       K_max = 10,
#                       nbr_alpha = 4,
#                       parallel_alpha = TRUE,
#                       Ncores = 3)

#saveRDS(PhyloEM_corolla_length,"results/PhyloEM_corolla_length_log1.rds")
PhyloEM_corolla_length <- readRDS("results/PhyloEM_corolla_length_log1.rds")
PhyloEM_corolla_length_params <- params_process(PhyloEM_corolla_length)
# 
# cols_edges_corolla_length_noNA <- character(length(comptree_corolla_noNA$edge)) 
# cols_edges_corolla_length_noNA[1:4080] <- "gray"
# cols_edges_corolla_length_noNA[699:935] <- "magenta"
# cols_edges_corolla_length_noNA[780:822] <- "aquamarine"
# cols_edges_corolla_length_noNA[1263:1385] <- "purple"
# cols_edges_corolla_length_noNA[1385:1385] <- "gold"
# cols_edges_corolla_length_noNA[1396:2040] <- "forestgreen"
# cols_edges_corolla_length_noNA[1579:1807] <- "orange"
# cols_edges_corolla_length_noNA[1765:1765] <- "red"
# cols_edges_corolla_length_noNA[1837:1939] <- "skyblue"
# cols_edges_corolla_length_noNA[1765:1765] <- "brown"
# cols_edges_corolla_length_noNA[2017:2023] <- "pink"
# 
# cols_tips_corolla_length_noNA <- character(length(comptree_corolla_noNA$tip.label)) 
# cols_tips_corolla_length_noNA[1:1021] <- "gray"
# cols_tips_corolla_length_noNA[234:355] <- "magenta"
# cols_tips_corolla_length_noNA[324:345] <- "aquamarine"
# cols_tips_corolla_length_noNA[594:654] <- "purple"
# cols_tips_corolla_length_noNA[614:614] <- "gold"
# cols_tips_corolla_length_noNA[673:995] <- "forestgreen"
# cols_tips_corolla_length_noNA[878:992] <- "orange"
# cols_tips_corolla_length_noNA[919:919] <- "red"
# cols_tips_corolla_length_noNA[757:809] <- "skyblue"
# cols_tips_corolla_length_noNA[787:787] <- "brown"
# cols_tips_corolla_length_noNA[824:827] <- "pink"

###

#plot(PhyloEM_corolla_length,automatic_colors=F,color_edges=cols_edges_corolla_length_noNA,
#     color_characters=cols_tips_corolla_length_noNA,root.edge=F, show.tip.label=F, label_cex=0.1)

plot(PhyloEM_corolla_length,automatic_colors=T,root.edge=F, show.tip.label=F, label_cex=0.1)

axisPhylo(line=-1.5, cex.axis=0.75, mgp=c(3, .5, 0))

tiplabels(bg=colors_subfamily, pch=22, cex=0.3, adj=2.5, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.3, adj=2.8, lwd=0, col=colors_subfamily)

tiplabels(bg=cols_pollinator, pch=22, cex=0.3, adj=4.2, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.3, adj=4.5, lwd=0, col=cols_pollinator)

par(lwd = 0.1)

nodelabels(pie = recon_yang_size$states, piecol = c("orange","magenta","red","blue","black","gold","green","aquamarine"), cex = 0.25)

legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
  "Ericoideae","Harrimanelloideae","Monotropoideae","Pyroloideae","Styphelioideae",
  "Vaccinioideae"),title = "Subfamily (tips= 1021)",inset = 0, pch = c(15),
  col = c("gold","black","pink","green","aquamarine","orange","brown","blue","red"),
  adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)
#axisPhylo(cex = 0.3)

legend(29,1175, legend = c("Bee","Honeyeater","Hummingbird","Hummingbird OW","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
       col = c("blue","orange","magenta","red","black","gold","green","aquamarine"),
       adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)
```

```{r,label="shifts corolla length PhyloEM with tips", fig.height=65, fig.width=15, eval=T,fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE, eval=T}
plot(PhyloEM_corolla_length, show.tip.label=T, cex=0.075,edge.width=2)
edgelabels(frame="n",col="red",cex=0.2)
tiplabels(bg=colors_subfamily, pch=22, cex=0.3, adj=2.5, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.3, adj=2.8, lwd=0, col=colors_subfamily)

legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
 "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
 "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
 col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
 adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)

#axisPhylo(cex = 0.3)
```

\pagebreak

- l1ou

```{r, label="shifts corolla length no NA l1ou", fig.height=8, fig.width=9,cache=FALSE,fig.align='center', echo=FALSE, message=FALSE, warning=FALSE}
# corolla_length_shifts_noNA <- adjust_data(comptree_corolla_noNA, sortedData_corolla_noNA[,13]) 
# shifts_corolla_length_shifts_noNA <- estimate_shift_configuration(corolla_length_shifts_noNA$tree, corolla_length_shifts_noNA$Y, max.nShifts=50, root.model="OUrandomRoot",  criterion="pBIC")  

#saveRDS(shifts_corolla_length_shifts_noNA,"results/l1ou_corolla_length_log1.rds")
#shifts_corolla_length_shifts_noNA <-readRDS("results/l1ou_corolla_length_log1.rds")

### estimate convergent shifts

# conv_shifts_corolla_length_noNA <- estimate_convergent_regimes(shifts_corolla_length_shifts_noNA, criterion =  "pBIC",method = "backward",fixed.alpha = FALSE, nCores = 4)
# 
# saveRDS(conv_shifts_corolla_length_noNA,"results/conv_shifts_corolla_noNA_length_log1.rds")
conv_shifts_corolla_length_noNA <- readRDS("results/conv_shifts_corolla_noNA_length_log1.rds")

plot(conv_shifts_corolla_length_noNA, show.tip.label=F,cex=0.25,edge.shift.ann=F)
par(lwd = 0.1)
nodelabels(pie = recon_yang_size$states, piecol = c("orange","magenta","red","blue","black","gold","green","aquamarine"), cex = 0.25)

tiplabels(bg=colors_subfamily, pch=22, cex=0.3, adj=0.51, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.3, adj=0.515, lwd=0, col=colors_subfamily)

tiplabels(bg=cols_pollinator, pch=22, cex=0.3, adj=0.52, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.3, adj=0.525, lwd=0, col=cols_pollinator)


legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
  "Ericoideae","Harrimanelloideae","Monotropoideae","Pyroloideae","Styphelioideae",
  "Vaccinioideae"),title = "Subfamily (tips= 1021)",inset = 0, pch = c(15),
  col = c("gold","black","pink","green","aquamarine","orange","brown","blue","red"),
  adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)
#axisPhylo(cex = 0.3)

legend(0.35,1060, legend = c("Bee","Honeyeater","Hummingbird","Hummingbird OW","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
       col = c("blue","orange","magenta","red","black","gold","green","aquamarine"),
       adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)

```

```{r,label="shifts corolla length no NA l1ou with tips", fig.height=65, fig.width=25, eval=T,fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE, eval=T}

conv_shifts_corolla_length_noNA <- readRDS("results/conv_shifts_corolla_noNA_length_log1.rds")

plot(conv_shifts_corolla_length_noNA, show.tip.label=T,cex=0.4,edge.shift.ann=F)
par(lwd = 0.1)
nodelabels(pie = recon_yang_size$states, piecol = c("orange","magenta","red","blue","black","gold","green","aquamarine"), cex = 0.25)

tiplabels(bg=colors_subfamily, pch=22, cex=0.3, adj=0.51, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.3, adj=0.515, lwd=0, col=colors_subfamily)

tiplabels(bg=cols_pollinator, pch=22, cex=0.3, adj=0.52, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.3, adj=0.525, lwd=0, col=cols_pollinator)


legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
  "Ericoideae","Harrimanelloideae","Monotropoideae","Pyroloideae","Styphelioideae",
  "Vaccinioideae"),title = "Subfamily (tips= 1021)",inset = 0, pch = c(15),
  col = c("gold","black","pink","green","aquamarine","orange","brown","blue","red"),
  adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)
#axisPhylo(cex = 0.3)

legend(0.35,1060, legend = c("Bee","Honeyeater","Hummingbird","Hummingbird OW","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
       col = c("blue","orange","magenta","red","black","gold","green","aquamarine"),
       adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)

```


PGLS corolla

\pagebreak

```{r, label="match phylogeny to corolla data for pgls", fig.height=4, fig.width=6, cache=FALSE,fig.align='center', echo=FALSE, message=FALSE, warning=FALSE} 
sortedData_shape_corolla_noNA_pgls <- subset(all_data,!pollinator_referenced=="-")
sortedData_shape_corolla_noNA_pgls <- sortedData_shape_corolla_noNA_pgls[complete.cases(sortedData_shape_corolla_noNA_pgls$PC1_corolla),]
sortedData_shape_corolla_noNA_pgls$pollinator_referenced <- droplevels(sortedData_shape_corolla_noNA_pgls$pollinator_referenced)

Overlap_corolla_noNA_pgls <- name.check(tree, sortedData_shape_corolla_noNA_pgls) 
comptree_shape_corolla_noNA_pgls <- drop.tip(tree, Overlap_corolla_noNA_pgls$tree_not_data)
match_corolla_noNA_pgls <- match(comptree_shape_corolla_noNA_pgls$tip.label, rownames(sortedData_shape_corolla_noNA_pgls))  
sortedData_shape_corolla_noNA_pgls <- sortedData_shape_corolla_noNA_pgls[,][match_corolla_noNA_pgls,]
sortedData_shape_corolla_noNA_pgls$pollinator_referenced <- as.factor(sortedData_shape_corolla_noNA_pgls$pollinator_referenced)


### PGLS pollinator_referenced-corolla length
sortedData_length_corolla_noNA_pgls <- all_data[complete.cases(all_data$corolla_tube_length),]
sortedData_length_corolla_noNA_pgls <- subset(sortedData_length_corolla_noNA_pgls,!sortedData_length_corolla_noNA_pgls$pollinator_referenced=="-")

Overlap_length_corolla_noNA_pgls <- name.check(tree, sortedData_length_corolla_noNA_pgls) 
comptree_length_corolla_noNA_pgls <- drop.tip(tree, Overlap_length_corolla_noNA_pgls$tree_not_data)
match_length_corolla_noNA_pgls <- match(comptree_length_corolla_noNA_pgls$tip.label, rownames(sortedData_length_corolla_noNA_pgls))  
sortedData_length_corolla_noNA_pgls <- sortedData_length_corolla_noNA_pgls[,][match_length_corolla_noNA_pgls,]
sortedData_length_corolla_noNA_pgls$pollinator_referenced <- as.factor(sortedData_length_corolla_noNA_pgls$pollinator_referenced)
sortedData_length_corolla_noNA_pgls$pollinator_referenced <- droplevels(sortedData_length_corolla_noNA_pgls$pollinator_referenced)

sortedData_length_corolla_noNA_pgls$log_corolla_tube_length <- log(sortedData_length_corolla_noNA_pgls$corolla_tube_length+1)

```

```{r, label="pgls corolla continent",eval=T, fig.height=8, fig.width=8, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
### PGLS continent-PC1
sortedData_shape_corolla_noNA_pgls$continent = relevel(as.factor(sortedData_shape_corolla_noNA_pgls$continent), "South_America")
sortedData_shape_corolla_noNA_pgls$continent <- droplevels(sortedData_shape_corolla_noNA_pgls$continent)
pglsModel <- gls(PC1_corolla~ continent,correlation = corBrownian(phy=comptree_shape_corolla_noNA_pgls),  data = sortedData_shape_corolla_noNA_pgls)
pglsModel_lambda <- gls(PC1_corolla ~ continent,  correlation = corPagel(1,phy=comptree_shape_corolla_noNA_pgls), data = sortedData_shape_corolla_noNA_pgls)
#pglsModel_OU <- gls(PC1_corolla ~ continent,  correlation = corMartins(1,phy=comptree_shape_corolla_noNA_pgls), data = sortedData_shape_corolla_noNA_pgls)
#anova(pglsModel,pglsModel_lambda,pglsModel_OU)   
#anova(pglsModel_lambda)
#kable(summary(pglsModel_lambda)$tTable, digits = 3, caption="PGLS corolla shape PC1 and continent")    
pgls_res_geography_corolla_PC1 <- summary(pglsModel_lambda)$tTable 
pgls_res_geography_corolla_PC1 <- cbind(data.frame(c("corolla PC1"),c("Intercept: South America","Africa","Asia","Australia","Europe ","North America")),pgls_res_geography_corolla_PC1)
colnames(pgls_res_geography_corolla_PC1)[c(1:2)] <- c("trait","group") 
rownames(pgls_res_geography_corolla_PC1) <- NULL
pgls_res_geography_corolla_PC1$`p-value` <- p.adjust(pgls_res_geography_corolla_PC1$`p-value`)
r2 <- R2(pglsModel_lambda)[2]
pgls_res_geography_corolla_PC1 <- cbind(pgls_res_geography_corolla_PC1,r2)
pgls_res_geography_corolla_PC1$N <- sortedData_shape_corolla_noNA_pgls$continent %>% table() 
pgls_res_geography_corolla_PC1 <- pgls_res_geography_corolla_PC1[c(1:2,8,3:7)]

### PGLS continent-PC2
pglsModel <- gls(PC2_corolla~ continent,correlation = corBrownian(phy=comptree_shape_corolla_noNA_pgls),  data = sortedData_shape_corolla_noNA_pgls)
pglsModel_lambda <- gls(PC2_corolla ~ continent,  correlation = corPagel(1,phy=comptree_shape_corolla_noNA_pgls), data = sortedData_shape_corolla_noNA_pgls)
#pglsModel_OU <- gls(PC2_corolla ~ continent,  correlation = corMartins(1,phy=comptree_shape_corolla_noNA_pgls), data = sortedData_shape_corolla_noNA_pgls)
#anova(pglsModel,pglsModel_lambda,pglsModel_OU)   
#anova(pglsModel_lambda)
#kable(summary(pglsModel_lambda)$tTable, digits = 3, caption="PGLS corolla shape PC2 and continent")    
pgls_res_geography_corolla_PC2 <- summary(pglsModel_lambda)$tTable 
pgls_res_geography_corolla_PC2 <- cbind(data.frame(c("corolla PC2"),c("Intercept: South America","Africa","Asia","Australia","Europe ","North America")),pgls_res_geography_corolla_PC2)
colnames(pgls_res_geography_corolla_PC2)[c(1:2)] <- c("trait","group") 
rownames(pgls_res_geography_corolla_PC2) <- NULL
pgls_res_geography_corolla_PC2$`p-value` <- p.adjust(pgls_res_geography_corolla_PC2$`p-value`)
r2 <- R2(pglsModel_lambda)[2]
pgls_res_geography_corolla_PC2 <- cbind(pgls_res_geography_corolla_PC2,r2)
pgls_res_geography_corolla_PC2$N <- sortedData_shape_corolla_noNA_pgls$continent %>% table() 
pgls_res_geography_corolla_PC2 <- pgls_res_geography_corolla_PC2[c(1:2,8,3:7)]

### PGLS continent-corolla length

sortedData_length_corolla_noNA_pgls$continent = relevel(as.factor(sortedData_length_corolla_noNA_pgls$continent), "South_America")
sortedData_length_corolla_noNA_pgls$continent <- droplevels(sortedData_length_corolla_noNA_pgls$continent)

### PGLS continent-log corolla length

pglsModel <- gls(log_corolla_tube_length~ continent,correlation = corBrownian(phy=comptree_length_corolla_noNA_pgls),  data = sortedData_length_corolla_noNA_pgls)
pglsModel_lambda <- gls(log_corolla_tube_length ~ continent,  correlation = corPagel(1,phy=comptree_length_corolla_noNA_pgls), data = sortedData_length_corolla_noNA_pgls)
#pglsModel_OU <- gls(log_corolla_tube_length ~ continent,  correlation = corMartins(1,phy=comptree_length_corolla_noNA_pgls), data = sortedData_length_corolla_noNA_pgls)
#anova(pglsModel,pglsModel_lambda,pglsModel_OU)   
#anova(pglsModel_lambda)
#kable(summary(pglsModel_lambda)$tTable, digits = 3, caption="PGLS corolla length and continent")    
pgls_res_continent_length_corolla_log <- summary(pglsModel_lambda)$tTable
pgls_res_continent_length_corolla_log <- cbind(data.frame(c("log corolla length"),c("Intercept: South America","Africa","Asia","Australia","Europe ","North America")),pgls_res_continent_length_corolla_log)
colnames(pgls_res_continent_length_corolla_log)[c(1:2)] <- c("trait","group") 
rownames(pgls_res_continent_length_corolla_log) <- NULL
pgls_res_continent_length_corolla_log$`p-value` <- p.adjust(pgls_res_continent_length_corolla_log$`p-value`)
r2 <- R2(pglsModel_lambda)[2]
pgls_res_continent_length_corolla_log <- cbind(pgls_res_continent_length_corolla_log,r2)
pgls_res_continent_length_corolla_log$N <- sortedData_length_corolla_noNA_pgls$continent %>% table() 
pgls_res_continent_length_corolla_log <- pgls_res_continent_length_corolla_log[c(1:2,8,3:7)]
```

```{r,label="make boxplots of corolla by geography", fig.height=4, fig.width=10, fig.align='center',echo=FALSE, cache=F, message=FALSE, warning=FALSE,eval=T}
# Corolla
# 
# sortedData_shape_corolla_noNA_pgls$continent <- factor(sortedData_shape_corolla_noNA_pgls$continent, 
#            levels=c("Africa","Asia","Australia","Europe","North_America","South_America"))
# 
# boxplot_corolla_PC1_geography <-ggplot(sortedData_shape_corolla_noNA_pgls,aes(x=continent,y=PC1_corolla, fill=continent,color=continent)) 
# boxplot_corolla_PC1_geography <- boxplot_corolla_PC1_geography + geom_boxplot(alpha=0.5,outlier.shape=NA)   
# boxplot_corolla_PC1_geography <- boxplot_corolla_PC1_geography + 
#   scale_fill_manual(values=c("red","orange","purple","blue","green","forestgreen"),guide="none") + scale_color_manual(values=c("red","orange","purple","blue","green",                                "forestgreen"),guide="none") 
# 
# boxplot_corolla_PC1_geography <- boxplot_corolla_PC1_geography + guides(fill=FALSE) + theme_bw() +
#   geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25)  
# 
# 
# boxplot_corolla_PC1_geography <- boxplot_corolla_PC1_geography  + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text(size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("Africa"="Africa","Asia"="Asia","Australia" ="Australia", "Europe" = "Europe","North_America"="North America","South_America"="South America")) + ylab("Corolla PC1")
# 
# #boxplot_corolla_PC1_geography
# 
# 
# boxplot_corolla_PC2_geography <-ggplot(sortedData_shape_corolla_noNA_pgls,aes(x=continent,y=PC2_corolla, fill=continent,color=continent)) 
# boxplot_corolla_PC2_geography <- boxplot_corolla_PC2_geography + geom_boxplot(alpha=0.5,outlier.shape=NA)   
# boxplot_corolla_PC2_geography <- boxplot_corolla_PC2_geography + 
#   scale_fill_manual(values=c("red","orange","purple","blue","green","forestgreen"),guide="none") + scale_color_manual(values=c("red","orange","purple","blue","green",                                "forestgreen"),guide="none") 
# 
# boxplot_corolla_PC2_geography <- boxplot_corolla_PC2_geography + guides(fill=FALSE) + theme_bw() +
#   geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 
# 
# boxplot_corolla_PC2_geography <- boxplot_corolla_PC2_geography  + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("Africa"="Africa","Asia"="Asia","Australia" ="Australia", "Europe" = "Europe","North_America"="North America","South_America"="South America")) + ylab("Corolla PC2")
# 
# #boxplot_corolla_PC2_geography
# 
# #
# sortedData_length_corolla_noNA_pgls$continent <- factor(sortedData_length_corolla_noNA_pgls$continent, 
#            levels=c("Africa","Asia","Australia","Europe","North_America","South_America"))
# 
# boxplot_corolla_length_geography <-ggplot(sortedData_length_corolla_noNA_pgls,aes(x=continent,y=corolla_tube_length, fill=continent,color=continent)) 
# boxplot_corolla_length_geography <- boxplot_corolla_length_geography + geom_boxplot(alpha=0.5,outlier.shape=NA)   
# boxplot_corolla_length_geography <- boxplot_corolla_length_geography + 
#   scale_fill_manual(values=c("red","orange","purple","blue","green","forestgreen"),guide="none") + scale_color_manual(values=c("red","orange","purple","blue","green",                                "forestgreen"),guide="none") 
# 
# boxplot_corolla_length_geography <- boxplot_corolla_length_geography + guides(fill=FALSE) + theme_bw() +
#   geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 
# 
# boxplot_corolla_length_geography <- boxplot_corolla_length_geography  + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("Africa"="Africa","Asia"="Asia","Australia" ="Australia", "Europe" = "Europe","North_America"="North America","South_America"="South America")) + ylab("Corolla tube length (mm)")
# 
# #boxplot_corolla_length_geography
# 
# # log corolla length
# boxplot_log_corolla_length_geography <-ggplot(sortedData_length_corolla_noNA_pgls,aes(x=continent,y=log_corolla_tube_length, fill=continent,color=continent)) 
# boxplot_log_corolla_length_geography <- boxplot_log_corolla_length_geography + geom_boxplot(alpha=0.5,outlier.shape=NA)   
# boxplot_log_corolla_length_geography <- boxplot_log_corolla_length_geography + 
#   scale_fill_manual(values=c("red","orange","purple","blue","green","forestgreen"),guide="none") + scale_color_manual(values=c("red","orange","purple","blue","green",                                "forestgreen"),guide="none") 
# 
# boxplot_log_corolla_length_geography <- boxplot_log_corolla_length_geography + guides(fill=FALSE) + theme_bw() +
#   geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 
# 
# boxplot_log_corolla_length_geography <- boxplot_log_corolla_length_geography  + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("Africa"="Africa","Asia"="Asia","Australia" ="Australia", "Europe" = "Europe","North_America"="North America","South_America"="South America")) + ylab("Corolla tube length (log+1)")

#boxplot_log_corolla_length_geography

```

```{r,label="make boxplots of corolla by geography all data", fig.height=4, fig.width=10, fig.align='center',echo=FALSE, cache=F, message=FALSE, warning=FALSE,eval=T}
# Corolla

pcs_corolla$continent <- factor(pcs_corolla$continent, 
                                                       levels=c("Africa","Asia","Australia","Europe","North_America","South_America"))

boxplot_corolla_PC1_geography <-ggplot(pcs_corolla,aes(x=continent,y=PC1, fill=continent,color=continent)) 
boxplot_corolla_PC1_geography <- boxplot_corolla_PC1_geography + geom_boxplot(alpha=0.5,outlier.shape=NA)   
boxplot_corolla_PC1_geography <- boxplot_corolla_PC1_geography + 
  scale_fill_manual(values=c("red","orange","purple","blue","green","forestgreen"),guide="none") + scale_color_manual(values=c("red","orange","purple","blue","green",                                "forestgreen"),guide="none") 

boxplot_corolla_PC1_geography <- boxplot_corolla_PC1_geography + guides(fill=FALSE) + theme_bw() +
  geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25)  


boxplot_corolla_PC1_geography <- boxplot_corolla_PC1_geography  + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text(size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("Africa"="Africa","Asia"="Asia","Australia" ="Australia", "Europe" = "Europe","North_America"="North America","South_America"="South America")) + ylab("Corolla PC1")

#boxplot_corolla_PC1_geography

boxplot_corolla_PC2_geography <-ggplot(pcs_corolla,aes(x=continent,y=PC2, fill=continent,color=continent)) 
boxplot_corolla_PC2_geography <- boxplot_corolla_PC2_geography + geom_boxplot(alpha=0.5,outlier.shape=NA)   
boxplot_corolla_PC2_geography <- boxplot_corolla_PC2_geography + 
  scale_fill_manual(values=c("red","orange","purple","blue","green","forestgreen"),guide="none") + scale_color_manual(values=c("red","orange","purple","blue","green",                                "forestgreen"),guide="none") 

boxplot_corolla_PC2_geography <- boxplot_corolla_PC2_geography + guides(fill=FALSE) + theme_bw() +
  geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 

boxplot_corolla_PC2_geography <- boxplot_corolla_PC2_geography  + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("Africa"="Africa","Asia"="Asia","Australia" ="Australia", "Europe" = "Europe","North_America"="North America","South_America"="South America")) + ylab("Corolla PC2")

#boxplot_corolla_PC2_geography

#
pcs_corolla_length_no_NA_continent$log_corolla_tube_length <- log(pcs_corolla_length_no_NA_continent$corolla_tube_length+1)


pcs_corolla_length_no_NA_continent$continent <- factor(pcs_corolla_length_no_NA_continent$continent, 
                                                        levels=c("Africa","Asia","Australia","Europe","North_America","South_America"))

boxplot_corolla_length_geography <-ggplot(pcs_corolla_length_no_NA_continent,aes(x=continent,y=corolla_tube_length, fill=continent,color=continent)) 
boxplot_corolla_length_geography <- boxplot_corolla_length_geography + geom_boxplot(alpha=0.5,outlier.shape=NA)   
boxplot_corolla_length_geography <- boxplot_corolla_length_geography + 
  scale_fill_manual(values=c("red","orange","purple","blue","green","forestgreen"),guide="none") + scale_color_manual(values=c("red","orange","purple","blue","green",                                "forestgreen"),guide="none") 

boxplot_corolla_length_geography <- boxplot_corolla_length_geography + guides(fill=FALSE) + theme_bw() +
  geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 

boxplot_corolla_length_geography <- boxplot_corolla_length_geography  + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("Africa"="Africa","Asia"="Asia","Australia" ="Australia", "Europe" = "Europe","North_America"="North America","South_America"="South America")) + ylab("Corolla tube length (mm)")

#boxplot_corolla_length_geography

# log corolla length
boxplot_log_corolla_length_geography <-ggplot(pcs_corolla_length_no_NA_continent,aes(x=continent,y=log_corolla_tube_length, fill=continent,color=continent)) 
boxplot_log_corolla_length_geography <- boxplot_log_corolla_length_geography + geom_boxplot(alpha=0.5,outlier.shape=NA)   
boxplot_log_corolla_length_geography <- boxplot_log_corolla_length_geography + 
  scale_fill_manual(values=c("red","orange","purple","blue","green","forestgreen"),guide="none") + scale_color_manual(values=c("red","orange","purple","blue","green",                                "forestgreen"),guide="none") 

boxplot_log_corolla_length_geography <- boxplot_log_corolla_length_geography + guides(fill=FALSE) + theme_bw() +
  geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 

boxplot_log_corolla_length_geography <- boxplot_log_corolla_length_geography  + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("Africa"="Africa","Asia"="Asia","Australia" ="Australia", "Europe" = "Europe","North_America"="North America","South_America"="South America")) + ylab("Corolla tube length (log+1)")

#boxplot_log_corolla_length_geography
```

```{r, label="pgls corolla pollinator_referenced",eval=T, fig.height=8, fig.width=8, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
### PGLS pollinator_referenced-PC1

#sortedData_shape_corolla_noNA_pgls$pollinator_referenced = relevel(as.factor(sortedData_shape_corolla_noNA_pgls$pollinator_referenced), "hummingbird")

sortedData_shape_corolla_noNA_pgls$pollinator_referenced <- factor(sortedData_shape_corolla_noNA_pgls$pollinator_referenced,levels=c( "hummingbird","insect","honeyeater", "hummingbird_OW","lepidoptera","long_proboscid_fly","sunbird","wind"))

pglsModel <- gls(PC1_corolla~ pollinator_referenced,correlation = corBrownian(phy=comptree_shape_corolla_noNA_pgls),  data = sortedData_shape_corolla_noNA_pgls)
pglsModel_lambda <- gls(PC1_corolla ~ pollinator_referenced,  correlation = corPagel(1,phy=comptree_shape_corolla_noNA_pgls), data = sortedData_shape_corolla_noNA_pgls)
pglsModel_OU <- gls(PC1_corolla ~ pollinator_referenced,  correlation = corMartins(1,phy=comptree_shape_corolla_noNA_pgls), data = sortedData_shape_corolla_noNA_pgls)
#anova(pglsModel,pglsModel_lambda,pglsModel_OU)   
#anova(pglsModel_lambda)
#kable(summary(pglsModel_OU)$tTable, digits = 3, caption="PGLS corolla shape PC1 and pollinator_referenced")    
pgls_res_pollinator_corolla_PC1 <- summary(pglsModel_lambda)$tTable 
pgls_res_pollinator_corolla_PC1 <- cbind(data.frame(c("corolla PC1"),c("Intercept: Hummingbird","Bee","Honeyeater","Hummingbird OW","Lepidoptera","Long proboscid fly","Sunbird","Wind")),pgls_res_pollinator_corolla_PC1)
colnames(pgls_res_pollinator_corolla_PC1)[c(1:2)] <- c("trait","group") 
rownames(pgls_res_pollinator_corolla_PC1) <- NULL
pgls_res_pollinator_corolla_PC1$`p-value` <- p.adjust(pgls_res_pollinator_corolla_PC1$`p-value`)
r2 <- R2(pglsModel_lambda)[2]
pgls_res_pollinator_corolla_PC1 <- cbind(pgls_res_pollinator_corolla_PC1,r2)
pgls_res_pollinator_corolla_PC1$N <- sortedData_shape_corolla_noNA_pgls$pollinator_referenced %>% table() 
pgls_res_pollinator_referenced_corolla_PC1 <- pgls_res_pollinator_corolla_PC1[c(1:2,8,3:7)]


### PGLS pollinator_referenced-PC2
pglsModel <- gls(PC2_corolla~ pollinator_referenced,correlation = corBrownian(phy=comptree_shape_corolla_noNA_pgls),  data = sortedData_shape_corolla_noNA_pgls)
pglsModel_lambda <- gls(PC2_corolla ~ pollinator_referenced,  correlation = corPagel(1,phy=comptree_shape_corolla_noNA_pgls), data = sortedData_shape_corolla_noNA_pgls)
pglsModel_OU <- gls(PC2_corolla ~ pollinator_referenced,  correlation = corMartins(1,phy=comptree_shape_corolla_noNA_pgls), data = sortedData_shape_corolla_noNA_pgls)
#anova(pglsModel,pglsModel_lambda,pglsModel_OU)   
#anova(pglsModel_OU)
#kable(summary(pglsModel_OU)$tTable, digits = 3, caption="PGLS corolla shape PC2 and pollinator_referenced")    
pgls_res_pollinator_corolla_PC2 <- summary(pglsModel_lambda)$tTable 
pgls_res_pollinator_corolla_PC2 <- cbind(data.frame(c("corolla PC2"),c("Intercept: Hummingbird","Bee","Honeyeater","Hummingbird OW","Lepidoptera","Long proboscid fly","Sunbird","Wind")),pgls_res_pollinator_corolla_PC2)
colnames(pgls_res_pollinator_corolla_PC2)[c(1:2)] <- c("trait","group") 
rownames(pgls_res_pollinator_corolla_PC2) <- NULL
pgls_res_pollinator_corolla_PC2$`p-value` <- p.adjust(pgls_res_pollinator_corolla_PC2$`p-value`)
r2 <- R2(pglsModel_lambda)[2]
pgls_res_pollinator_corolla_PC2 <- cbind(pgls_res_pollinator_corolla_PC2,r2)
pgls_res_pollinator_corolla_PC2$N <- sortedData_shape_corolla_noNA_pgls$pollinator_referenced %>% table() 
pgls_res_pollinator_referenced_corolla_PC2 <- pgls_res_pollinator_corolla_PC2[c(1:2,8,3:7)]

###

#sortedData_length_corolla_noNA_pgls$pollinator_referenced = relevel(as.factor(sortedData_length_corolla_noNA_pgls$pollinator_referenced), "hummingbird")

sortedData_length_corolla_noNA_pgls$pollinator_referenced <- factor(sortedData_length_corolla_noNA_pgls$pollinator_referenced,levels=c( "hummingbird","insect","honeyeater", "hummingbird_OW","lepidoptera","long_proboscid_fly","sunbird","wind"))

# log corolla length

pglsModel <- gls(log_corolla_tube_length~ pollinator_referenced,correlation = corBrownian(phy=comptree_length_corolla_noNA_pgls),  data = sortedData_length_corolla_noNA_pgls)
pglsModel_lambda <- gls(log_corolla_tube_length ~ pollinator_referenced,  correlation = corPagel(1,phy=comptree_length_corolla_noNA_pgls), data = sortedData_length_corolla_noNA_pgls)
tempTree <- comptree_length_corolla_noNA_pgls
tempTree$edge.length <- tempTree$edge.length * 1000
pglsModel_OU <- gls(log_corolla_tube_length ~ pollinator_referenced,  correlation = corMartins(1,phy=tempTree), data = sortedData_length_corolla_noNA_pgls)
#anova(pglsModel,pglsModel_lambda,pglsModel_OU)   
#anova(pglsModel_lambda)
#kable(summary(pglsModel_OU)$tTable, digits = 3, caption="PGLS corolla length and pollinator_referenced")   
pgls_res_length_corolla_log <- summary(pglsModel_lambda)$tTable
pgls_res_length_corolla_log <- cbind(data.frame(c("log corolla length"),c("Intercept: Hummingbird","Bee","Honeyeater","Hummingbird OW","Lepidoptera","Long proboscid fly","Sunbird","Wind")),pgls_res_length_corolla_log)
colnames(pgls_res_length_corolla_log)[c(1:2)] <- c("trait","group") 
rownames(pgls_res_length_corolla_log) <- NULL
pgls_res_length_corolla_log$`p-value` <- p.adjust(pgls_res_length_corolla_log$`p-value`)
r2 <- R2(pglsModel_lambda)[2]
pgls_res_pollinator_referenced_length_corolla_log <- cbind(pgls_res_length_corolla_log,r2)
pgls_res_pollinator_referenced_length_corolla_log$N <- sortedData_length_corolla_noNA_pgls$pollinator_referenced %>% table() 
pgls_res_pollinator_referenced_length_corolla_log <- pgls_res_pollinator_referenced_length_corolla_log[c(1:2,8,3:7)]
```

```{r,label="make boxplots of corolla shape pollinator_referenced", fig.height=4, fig.width=10, fig.align='center',echo=FALSE, cache=F, message=FALSE, warning=FALSE,eval=T}
# sortedData_shape_corolla_noNA_pgls$pollinator_referenced <- factor(sortedData_shape_corolla_noNA_pgls$pollinator_referenced, 
#        levels=c("honeyeater", "hummingbird", "hummingbird_OW","sunbird",
#                   "insect","lepidoptera","long_proboscid_fly","wind"))
# 
# # Corolla
# 
# boxplot_corolla_PC1_pollinators_referenced <-ggplot(sortedData_shape_corolla_noNA_pgls,aes(x=pollinator_referenced,y=PC1_corolla, fill=pollinator_referenced,color=pollinator_referenced)) 
# boxplot_corolla_PC1_pollinators_referenced <- boxplot_corolla_PC1_pollinators_referenced + geom_boxplot(alpha=0.5,outlier.shape=NA)   
# boxplot_corolla_PC1_pollinators_referenced <- boxplot_corolla_PC1_pollinators_referenced + 
#   scale_fill_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") + scale_color_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") 
# 
# boxplot_corolla_PC1_pollinators_referenced <- boxplot_corolla_PC1_pollinators_referenced + guides(fill=FALSE) + theme_bw() +
#   geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 
# 
# boxplot_corolla_PC1_pollinators_referenced <- boxplot_corolla_PC1_pollinators_referenced  + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text(size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("honeyeater" = "Honeyeater", "hummingbird" = "Hummingbird","hummingbird_OW" = "Hummingbird OW", "insect" = "Bee","lepidoptera"="Lepidoptera","long_proboscid_fly"="Long proboscid fly", "sunbird"="Sunbird","wind"="Wind")) + ylab("Corolla PC1")
# 
# #boxplot_corolla_PC1_pollinators_referenced
# 
# #
# 
# boxplot_corolla_PC2_pollinators_referenced <-ggplot(sortedData_shape_corolla_noNA_pgls,aes(x=pollinator_referenced,y=PC2_corolla, fill=pollinator_referenced,color=pollinator_referenced)) 
# boxplot_corolla_PC2_pollinators_referenced <- boxplot_corolla_PC2_pollinators_referenced + geom_boxplot(alpha=0.5,outlier.shape=NA)   
# boxplot_corolla_PC2_pollinators_referenced <- boxplot_corolla_PC2_pollinators_referenced + 
#   scale_fill_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") + scale_color_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") 
# 
# boxplot_corolla_PC2_pollinators_referenced <- boxplot_corolla_PC2_pollinators_referenced + guides(fill=FALSE) + theme_bw() +
#   geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 
# 
# boxplot_corolla_PC2_pollinators_referenced <- boxplot_corolla_PC2_pollinators_referenced  + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("honeyeater" = "Honeyeater", "hummingbird" = "Hummingbird",
#                             "hummingbird_OW" = "Hummingbird OW", "insect" = "Bee",
#                             "lepidoptera"="Lepidoptera","long_proboscid_fly"="Long proboscid fly", 
#                             "sunbird"="Sunbird","wind"="Wind")) + ylab("Corolla PC2")
# 
# 
# #boxplot_corolla_PC2_pollinators_referenced
# 
# #
# 
# #sortedData_length_corolla_noNA_pgls$pollinator_referenced = #relevel(as.factor(sortedData_length_corolla_noNA_pgls$pollinator_referenced), "honeyeater")
# 
# sortedData_length_corolla_noNA_pgls$pollinator_referenced <- factor(sortedData_length_corolla_noNA_pgls$pollinator_referenced, 
#        levels=c("honeyeater", "hummingbird", "hummingbird_OW","sunbird",
#                   "insect","lepidoptera","long_proboscid_fly","wind"))
# 
# boxplot_corolla_length_pollinators_referenced <-ggplot(sortedData_length_corolla_noNA_pgls,aes(x=pollinator_referenced,y=corolla_tube_length, fill=pollinator_referenced,color=pollinator_referenced)) 
# boxplot_corolla_length_pollinators_referenced <- boxplot_corolla_length_pollinators_referenced + geom_boxplot(alpha=0.5,outlier.shape=NA)   
# boxplot_corolla_length_pollinators_referenced <- boxplot_corolla_length_pollinators_referenced + 
#   scale_fill_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") + scale_color_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") 
# 
# boxplot_corolla_length_pollinators_referenced <- boxplot_corolla_length_pollinators_referenced + guides(fill=FALSE) + theme_bw() +
#   geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 
# 
# boxplot_corolla_length_pollinators_referenced <- boxplot_corolla_length_pollinators_referenced  + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("honeyeater" = "Honeyeater", "hummingbird" = "Hummingbird",
#                             "hummingbird_OW" = "Hummingbird OW", "insect" = "Bee",
#                             "lepidoptera"="Lepidoptera","long_proboscid_fly"="Long proboscid fly", 
#                             "sunbird"="Sunbird","wind"="Wind")) + ylab("Corolla tube length (mm)")
# 
# #boxplot_corolla_length_pollinators_referenced
# 
# boxplot_log_corolla_length_pollinators_referenced <-ggplot(sortedData_length_corolla_noNA_pgls,aes(x=pollinator_referenced,y=log_corolla_tube_length, fill=pollinator_referenced,color=pollinator_referenced)) 
# boxplot_log_corolla_length_pollinators_referenced <- boxplot_log_corolla_length_pollinators_referenced + geom_boxplot(alpha=0.5,outlier.shape=NA)   
# boxplot_log_corolla_length_pollinators_referenced <- boxplot_log_corolla_length_pollinators_referenced + 
#   scale_fill_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") + scale_color_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") 
# 
# boxplot_log_corolla_length_pollinators_referenced <- boxplot_log_corolla_length_pollinators_referenced + guides(fill=FALSE) + theme_bw() +
#   geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 
# 
# boxplot_log_corolla_length_pollinators_referenced <- boxplot_log_corolla_length_pollinators_referenced  + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("honeyeater" = "Honeyeater", "hummingbird" = "Hummingbird",
#   "hummingbird_OW" = "Hummingbird OW", "insect" = "Bee","lepidoptera"="Lepidoptera","long_proboscid_fly"="Long proboscid fly", "sunbird"="Sunbird","wind"="Wind")) + ylab("Corolla tube length (log+1)")

#boxplot_log_corolla_length_pollinators_referenced

```

```{r,label="make boxplots of corolla shape pollinator_referenced all data", fig.height=4, fig.width=10, fig.align='center',echo=FALSE, cache=F, message=FALSE, warning=FALSE,eval=T}

pcs_corolla_no_NA$pollinator_referenced <- factor(pcs_corolla_no_NA$pollinator_referenced, 
                                 levels=c("honeyeater", "hummingbird", "hummingbird_OW","sunbird",
                                                  "insect","lepidoptera","long_proboscid_fly","wind"))

# Corolla

boxplot_corolla_PC1_pollinators_referenced <-ggplot(pcs_corolla_no_NA,aes(x=pollinator_referenced,y=PC1, fill=pollinator_referenced,color=pollinator_referenced)) 
boxplot_corolla_PC1_pollinators_referenced <- boxplot_corolla_PC1_pollinators_referenced + geom_boxplot(alpha=0.5,outlier.shape=NA)   
boxplot_corolla_PC1_pollinators_referenced <- boxplot_corolla_PC1_pollinators_referenced + 
  scale_fill_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") + scale_color_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") 

boxplot_corolla_PC1_pollinators_referenced <- boxplot_corolla_PC1_pollinators_referenced + guides(fill=FALSE) + theme_bw() +
  geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 

boxplot_corolla_PC1_pollinators_referenced <- boxplot_corolla_PC1_pollinators_referenced  + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text(size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("honeyeater" = "Honeyeater", "hummingbird" = "Hummingbird","hummingbird_OW" = "Hummingbird OW", "insect" = "Bee","lepidoptera"="Lepidoptera","long_proboscid_fly"="Long proboscid fly", "sunbird"="Sunbird","wind"="Wind")) + ylab("Corolla PC1")

#boxplot_corolla_PC1_pollinators_referenced

#

boxplot_corolla_PC2_pollinators_referenced <-ggplot(pcs_corolla_no_NA,aes(x=pollinator_referenced,y=PC2, fill=pollinator_referenced,color=pollinator_referenced)) 
boxplot_corolla_PC2_pollinators_referenced <- boxplot_corolla_PC2_pollinators_referenced + geom_boxplot(alpha=0.5,outlier.shape=NA)   
boxplot_corolla_PC2_pollinators_referenced <- boxplot_corolla_PC2_pollinators_referenced + 
  scale_fill_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") + scale_color_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") 

boxplot_corolla_PC2_pollinators_referenced <- boxplot_corolla_PC2_pollinators_referenced + guides(fill=FALSE) + theme_bw() +
  geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 

boxplot_corolla_PC2_pollinators_referenced <- boxplot_corolla_PC2_pollinators_referenced  + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("honeyeater" = "Honeyeater", "hummingbird" = "Hummingbird",
                                                                                                                                                                                                                                     "hummingbird_OW" = "Hummingbird OW", "insect" = "Bee",
                                                                                                                                                                                                                                     "lepidoptera"="Lepidoptera","long_proboscid_fly"="Long proboscid fly", 
                                                                                                                                                                                                                                     "sunbird"="Sunbird","wind"="Wind")) + ylab("Corolla PC2")


#boxplot_corolla_PC2_pollinators_referenced

#

#sortedData_length_corolla_noNA_pgls$pollinator_referenced = #relevel(as.factor(sortedData_length_corolla_noNA_pgls$pollinator_referenced), "honeyeater")

pcs_corolla_length_no_NA$log_corolla_tube_length <- log(pcs_corolla_length_no_NA$corolla_tube_length+1)


pcs_corolla_length_no_NA$pollinator_referenced <- factor(pcs_corolla_length_no_NA$pollinator_referenced, 
                                                                    levels=c("honeyeater", "hummingbird", "hummingbird_OW","sunbird",
                                                                             "insect","lepidoptera","long_proboscid_fly","wind"))

boxplot_corolla_length_pollinators_referenced <-ggplot(pcs_corolla_length_no_NA,aes(x=pollinator_referenced,y=corolla_tube_length, fill=pollinator_referenced,color=pollinator_referenced)) 
boxplot_corolla_length_pollinators_referenced <- boxplot_corolla_length_pollinators_referenced + geom_boxplot(alpha=0.5,outlier.shape=NA)   
boxplot_corolla_length_pollinators_referenced <- boxplot_corolla_length_pollinators_referenced + 
  scale_fill_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") + scale_color_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") 

boxplot_corolla_length_pollinators_referenced <- boxplot_corolla_length_pollinators_referenced + guides(fill=FALSE) + theme_bw() +
  geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 

boxplot_corolla_length_pollinators_referenced <- boxplot_corolla_length_pollinators_referenced  + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("honeyeater" = "Honeyeater", "hummingbird" = "Hummingbird",
                                                                                                                                                                                                                                     "hummingbird_OW" = "Hummingbird OW", "insect" = "Bee",
                                                                                                                                                                                                                                     "lepidoptera"="Lepidoptera","long_proboscid_fly"="Long proboscid fly", 
                                                                                                                                                                                                                                     "sunbird"="Sunbird","wind"="Wind")) + ylab("Corolla tube length (mm)")

#boxplot_corolla_length_pollinators_referenced

boxplot_log_corolla_length_pollinators_referenced <-ggplot(pcs_corolla_length_no_NA,aes(x=pollinator_referenced,y=log_corolla_tube_length, fill=pollinator_referenced,color=pollinator_referenced)) 
boxplot_log_corolla_length_pollinators_referenced <- boxplot_log_corolla_length_pollinators_referenced + geom_boxplot(alpha=0.5,outlier.shape=NA)   
boxplot_log_corolla_length_pollinators_referenced <- boxplot_log_corolla_length_pollinators_referenced + 
  scale_fill_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") + scale_color_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") 

boxplot_log_corolla_length_pollinators_referenced <- boxplot_log_corolla_length_pollinators_referenced + guides(fill=FALSE) + theme_bw() +
  geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 

boxplot_log_corolla_length_pollinators_referenced <- boxplot_log_corolla_length_pollinators_referenced  + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("honeyeater" = "Honeyeater", "hummingbird" = "Hummingbird",
                                                                                                                                                                                                                                     "hummingbird_OW" = "Hummingbird OW", "insect" = "Bee","lepidoptera"="Lepidoptera","long_proboscid_fly"="Long proboscid fly", "sunbird"="Sunbird","wind"="Wind")) + ylab("Corolla tube length (log+1)")

#boxplot_log_corolla_length_pollinators_referenced

```

```{r, label="pgls corolla pollinator_referenced hummingbird_OW_as_ref",eval=T, fig.height=8, fig.width=8, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
### PGLS pollinator_referenced-PC1
sortedData_shape_corolla_noNA_pgls_hummingbird_OW_as_ref <- sortedData_shape_corolla_noNA_pgls

sortedData_shape_corolla_noNA_pgls_hummingbird_OW_as_ref$pollinator_referenced <- factor(sortedData_shape_corolla_noNA_pgls_hummingbird_OW_as_ref$pollinator_referenced,levels=c( "hummingbird_OW","insect","honeyeater", "hummingbird","lepidoptera","long_proboscid_fly","sunbird","wind"))

pglsModel <- gls(PC1_corolla~ pollinator_referenced,correlation = corBrownian(phy=comptree_shape_corolla_noNA_pgls),  data = sortedData_shape_corolla_noNA_pgls_hummingbird_OW_as_ref)
pglsModel_lambda <- gls(PC1_corolla ~ pollinator_referenced,  correlation = corPagel(1,phy=comptree_shape_corolla_noNA_pgls), data = sortedData_shape_corolla_noNA_pgls_hummingbird_OW_as_ref)
pglsModel_OU <- gls(PC1_corolla ~ pollinator_referenced,  correlation = corMartins(1,phy=comptree_shape_corolla_noNA_pgls), data = sortedData_shape_corolla_noNA_pgls_hummingbird_OW_as_ref)
#anova(pglsModel,pglsModel_lambda,pglsModel_OU)   
#anova(pglsModel_lambda)
#kable(summary(pglsModel_OU)$tTable, digits = 3, caption="PGLS corolla shape PC1 and pollinator_referenced")    
pgls_res_pollinator_corolla_PC1_hummingbird_OW_as_ref <- summary(pglsModel_lambda)$tTable 
pgls_res_pollinator_corolla_PC1_hummingbird_OW_as_ref <- cbind(data.frame(c("corolla PC1"),c("Intercept: Hummingbird OW","Bee","Honeyeater","Hummingbird","Lepidoptera","Long proboscid fly","Sunbird","Wind")),pgls_res_pollinator_corolla_PC1_hummingbird_OW_as_ref)
colnames(pgls_res_pollinator_corolla_PC1_hummingbird_OW_as_ref)[c(1:2)] <- c("trait","group") 
rownames(pgls_res_pollinator_corolla_PC1_hummingbird_OW_as_ref) <- NULL
pgls_res_pollinator_corolla_PC1_hummingbird_OW_as_ref$`p-value` <- p.adjust(pgls_res_pollinator_corolla_PC1_hummingbird_OW_as_ref$`p-value`)
r2 <- R2(pglsModel_lambda)[2]
pgls_res_pollinator_corolla_PC1_hummingbird_OW_as_ref <- cbind(pgls_res_pollinator_corolla_PC1_hummingbird_OW_as_ref,r2)
pgls_res_pollinator_corolla_PC1_hummingbird_OW_as_ref$N <- sortedData_shape_corolla_noNA_pgls_hummingbird_OW_as_ref$pollinator_referenced %>% table() 
pgls_res_pollinator_referenced_corolla_PC1_hummingbird_OW_as_ref <- pgls_res_pollinator_corolla_PC1_hummingbird_OW_as_ref[c(1:2,8,3:7)]

### PGLS pollinator_referenced-PC2
pglsModel <- gls(PC2_corolla~ pollinator_referenced,correlation = corBrownian(phy=comptree_shape_corolla_noNA_pgls),  data = sortedData_shape_corolla_noNA_pgls_hummingbird_OW_as_ref)
pglsModel_lambda <- gls(PC2_corolla ~ pollinator_referenced,  correlation = corPagel(1,phy=comptree_shape_corolla_noNA_pgls), data = sortedData_shape_corolla_noNA_pgls_hummingbird_OW_as_ref)
pglsModel_OU <- gls(PC2_corolla ~ pollinator_referenced,  correlation = corMartins(1,phy=comptree_shape_corolla_noNA_pgls), data = sortedData_shape_corolla_noNA_pgls_hummingbird_OW_as_ref)
#anova(pglsModel,pglsModel_lambda,pglsModel_OU)   
#anova(pglsModel_OU)
#kable(summary(pglsModel_OU)$tTable, digits = 3, caption="PGLS corolla shape PC2 and pollinator_referenced")    
pgls_res_pollinator_corolla_PC2_hummingbird_OW_as_ref <- summary(pglsModel_lambda)$tTable 
pgls_res_pollinator_corolla_PC2_hummingbird_OW_as_ref <- cbind(data.frame(c("corolla PC2"),c("Intercept: Hummingbird OW","Bee","Honeyeater","Hummingbird","Lepidoptera","Long proboscid fly","Sunbird","Wind")),pgls_res_pollinator_corolla_PC2_hummingbird_OW_as_ref)
colnames(pgls_res_pollinator_corolla_PC2_hummingbird_OW_as_ref)[c(1:2)] <- c("trait","group") 
rownames(pgls_res_pollinator_corolla_PC2_hummingbird_OW_as_ref) <- NULL
pgls_res_pollinator_corolla_PC2_hummingbird_OW_as_ref$`p-value` <- p.adjust(pgls_res_pollinator_corolla_PC2_hummingbird_OW_as_ref$`p-value`)
r2 <- R2(pglsModel_lambda)[2]
pgls_res_pollinator_corolla_PC2_hummingbird_OW_as_ref <- cbind(pgls_res_pollinator_corolla_PC2_hummingbird_OW_as_ref,r2)
pgls_res_pollinator_corolla_PC2_hummingbird_OW_as_ref$N <- sortedData_shape_corolla_noNA_pgls_hummingbird_OW_as_ref$pollinator_referenced %>% table() 
pgls_res_pollinator_referenced_corolla_PC2_hummingbird_OW_as_ref <- pgls_res_pollinator_corolla_PC2_hummingbird_OW_as_ref[c(1:2,8,3:7)]

# log corolla length

sortedData_length_corolla_noNA_pgls_hummingbird_OW_as_ref <- sortedData_length_corolla_noNA_pgls
sortedData_length_corolla_noNA_pgls_hummingbird_OW_as_ref$pollinator_referenced <- factor(sortedData_length_corolla_noNA_pgls_hummingbird_OW_as_ref$pollinator_referenced,levels=c( "hummingbird_OW","insect","honeyeater", "hummingbird","lepidoptera","long_proboscid_fly","sunbird","wind"))

pglsModel <- gls(log_corolla_tube_length~ pollinator_referenced,correlation = corBrownian(phy=comptree_length_corolla_noNA_pgls),  data = sortedData_length_corolla_noNA_pgls_hummingbird_OW_as_ref)
pglsModel_lambda <- gls(log_corolla_tube_length ~ pollinator_referenced,  correlation = corPagel(1,phy=comptree_length_corolla_noNA_pgls), data = sortedData_length_corolla_noNA_pgls_hummingbird_OW_as_ref)
tempTree <- comptree_length_corolla_noNA_pgls
tempTree$edge.length <- tempTree$edge.length * 1000
pglsModel_OU <- gls(log_corolla_tube_length ~ pollinator_referenced,  correlation = corMartins(1,phy=tempTree), data = sortedData_length_corolla_noNA_pgls_hummingbird_OW_as_ref)
#anova(pglsModel,pglsModel_lambda,pglsModel_OU)   
#anova(pglsModel_lambda)
#kable(summary(pglsModel_OU)$tTable, digits = 3, caption="PGLS corolla length and pollinator_referenced")    
pgls_res_length_corolla_log_hummingbird_OW_as_ref <- summary(pglsModel_lambda)$tTable
pgls_res_length_corolla_log_hummingbird_OW_as_ref <- cbind(data.frame(c("log corolla length"),c("Intercept: Hummingbird OW","Bee","Honeyeater","Hummingbird","Lepidoptera","Long proboscid fly","Sunbird","Wind")),pgls_res_length_corolla_log_hummingbird_OW_as_ref)
colnames(pgls_res_length_corolla_log_hummingbird_OW_as_ref)[c(1:2)] <- c("trait","group") 
rownames(pgls_res_length_corolla_log_hummingbird_OW_as_ref) <- NULL
pgls_res_length_corolla_log_hummingbird_OW_as_ref$`p-value` <- p.adjust(pgls_res_length_corolla_log_hummingbird_OW_as_ref$`p-value`)
r2 <- R2(pglsModel_lambda)[2]
pgls_res_length_corolla_log_hummingbird_OW_as_ref <- cbind(pgls_res_length_corolla_log_hummingbird_OW_as_ref,r2)
pgls_res_length_corolla_log_hummingbird_OW_as_ref$N <- sortedData_length_corolla_noNA_pgls_hummingbird_OW_as_ref$pollinator_referenced %>% table() 
pgls_res_pollinator_referenced_length_corolla_log_hummingbird_OW_as_ref <- pgls_res_length_corolla_log_hummingbird_OW_as_ref[c(1:2,8,3:7)]
``` 


### Anther

```{r, label="match phylogeny to anther data leaving no shape NA", fig.height=110, fig.width=25,cache=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
# reduce to rows of anther with some data
data_anther_noNA <- all_data_anthers[complete.cases(all_data_anthers$PC1_anther),]
Overlap_anther <- name.check(tree, data_anther_noNA) 
comptree_anther_noNA <- drop.tip(tree, Overlap_anther$tree_not_data)
match_anther <- match(comptree_anther_noNA$tip.label, rownames(data_anther_noNA))  
sortedData_anther_noNA <- data_anther_noNA[,][match_anther,]

sortedData_anther_noNA$pollinator_referenced <- droplevels(sortedData_anther_noNA$pollinator_referenced)

comptree_anther_shape_noNA <- average_tr_tips(comptree_anther_noNA)

colors_subfamily <- character(length(sortedData_anther_noNA$subfamily)) 
colors_subfamily[sortedData_anther_noNA$subfamily == "Arbutoideae"] <- "gold"
colors_subfamily[sortedData_anther_noNA$subfamily == "Cassiopoideae"] <- "black"
colors_subfamily[sortedData_anther_noNA$subfamily == "Enkianthoideae"] <- "pink"
colors_subfamily[sortedData_anther_noNA$subfamily == "Ericoideae"] <- "green"
colors_subfamily[sortedData_anther_noNA$subfamily == "Harrimanelloideae"] <- "aquamarine"
colors_subfamily[sortedData_anther_noNA$subfamily == "Monotropoideae"] <- "orange"
colors_subfamily[sortedData_anther_noNA$subfamily == "Pyroloideae"] <- "brown"
colors_subfamily[sortedData_anther_noNA$subfamily == "Styphelioideae"] <- "blue"
colors_subfamily[sortedData_anther_noNA$subfamily == "Vaccinioideae"] <- "red"
colors_subfamily[sortedData_anther_noNA$subfamily == "outgroup"] <- "black"

cols_pollinator <- character(length(sortedData_anther_noNA$pollinator_referenced)) 
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "-"] <- "white"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "honeyeater"] <- "orange"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "hummingbird"] <- "magenta"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "hummingbird_OW"] <- "red"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "insect"] <- "blue"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "lepidoptera"] <- "black"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "long_proboscid_fly"] <- "gold"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "sunbird"] <- "green"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "wind"] <- "aquamarine"

sortedData_anther_noNA_w_questionmarks <- sortedData_anther_noNA

sortedData_anther_noNA_w_questionmarks$pollinator_referenced <- gsub("-","?",sortedData_anther_noNA_w_questionmarks$pollinator_referenced)

# recon_yang_anthers <- rayDISC(comptree_anther_shape_noNA,sortedData_anther_noNA_w_questionmarks,model="ER",node.states="marginal",charnum = 5, root.p='yang')
# saveRDS(recon_yang_anthers, "results/recon_yang_445_anthers_pollinator_ER.rds")

recon_yang_anthers <- readRDS("results/recon_yang_445_anthers_pollinator_ER.rds")
```

#### Shape
 
```{r,label="shifts anther shape data PhyloEm", fig.height=8, fig.width=8.5, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
####### Now PhylogeneticEM
#PC1PC2anther_EM_ready <- t(sortedData_anther_noNA[3:4])
#colnames(PC1PC2anther_EM_ready) <- sortedData_anther_noNA$species
#PhyloEM_PC1PC2anther <- PhyloEM(phylo = comptree_anther_shape_noNA,
#                       Y_data = PC1PC2anther_EM_ready,
#                       process = "scOU",          
#                       random.root = TRUE,        
#                       stationary.root = TRUE,                      
#                       K_max = 20,      
#                       nbr_alpha = 4, 
#                       parallel_alpha = TRUE,     
#                       Ncores = 4)   

#saveRDS(PhyloEM_PC1PC2anther,"results/PhyloEM_PC1PC2anther.rds")
PhyloEM_PC1PC2anther <- readRDS("results/PhyloEM_PC1PC2anther.rds")
PhyloEM_PC1PC2anther_params <- params_process(PhyloEM_PC1PC2anther)
#PhyloEM_PC1PC2anther_params$shifts$edges %>% data.frame() %>% dim()

cols_edges_anther_shape_noNA <- character(length(comptree_anther_shape_noNA$edge)) 
cols_edges_anther_shape_noNA[1:2684] <- "gray"
cols_edges_anther_shape_noNA[54:888] <- "forestgreen"
cols_edges_anther_shape_noNA[158:160] <- "red"
cols_edges_anther_shape_noNA[301:457] <- "purple"

cols_tips_anther_shape_noNA <- character(length(comptree_anther_shape_noNA$tip.label)) 
cols_tips_anther_shape_noNA[1:445] <- "gray"
cols_tips_anther_shape_noNA[22:439] <- "forestgreen"
cols_tips_anther_shape_noNA[50:51] <- "red"
cols_tips_anther_shape_noNA[113:191] <- "purple"

# plot(PhyloEM_PC1PC2anther,automatic_colors=F,color_edges=cols_edges_anther_shape_noNA,
#      color_characters=cols_tips_anther_shape_noNA,root.edge=F, show.tip.label=F, shifts_cex=0.25)
# 
# tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=1.95, lwd=0, col=cols_pollinator)
# tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.1, lwd=0, col=cols_pollinator)
# tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.25, lwd=0, col=cols_pollinator)
# tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.4, lwd=0, col=cols_pollinator)
# tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.55, lwd=0, col=cols_pollinator)
# 
# tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.65, lwd=0, col=colors_subfamily)
# tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.8, lwd=0, col=colors_subfamily)
# tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.95, lwd=0, col=colors_subfamily)
# tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=4.1, lwd=0, col=colors_subfamily)
# tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=4.25, lwd=0, col=colors_subfamily)
# 
# legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
#   "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
#   "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
#   col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
#   adj = 0, cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
# legend(20,510, legend = c("Honeyeater","Hummingbird","Hummingbird OW","Bee","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
#   col = c("orange","magenta","red","blue","black","gold","green","aquamarine"),
#   adj = 0,  cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
# axisPhylo(line=-2, cex.axis=0.5, mgp=c(3, -.3 , 0), tck=-0.01, lwd=0.5)
# lines(x=c((branching.times(comptree_anther_shape_noNA)[1] - 14.5),(branching.times(comptree_anther_shape_noNA)[1] - 14.5)),y=c(1,900),lwd=1, col="dimgray", lty = "dashed")
```

- PhylogeneticEM

```{r,label="shifts anther shape data PhyloEm with ASR", fig.height=8, fig.width=8.5, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
plot(PhyloEM_PC1PC2anther,automatic_colors=F,color_edges=cols_edges_anther_shape_noNA,
     color_characters=cols_tips_anther_shape_noNA,root.edge=F, show.tip.label=F, shifts_cex=0.25)

tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=1.95, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=2.1, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=2.25, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=2.4, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=2.55, lwd=0, col=colors_subfamily)

tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=3.65, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=3.8, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=3.95, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=4.1, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=4.25, lwd=0, col=cols_pollinator)

par(lwd = 0.1)
nodelabels(pie = recon_yang_anthers$states, piecol = c("orange","magenta","red","blue","black","gold","green","aquamarine"), cex = 0.2)

legend(1,510, legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
  "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
  "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
  col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
  adj = 0, cex = 0.4, pt.cex = 0.55,  y.intersp = 1)
legend(20,510, legend = c("Bee","Honeyeater","Hummingbird","Hummingbird OW","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
  col = c("blue","orange","magenta","red","black","gold","green","aquamarine"),
  adj = 0,  cex = 0.4, pt.cex = 0.55, y.intersp = 1)
axisPhylo(line=-2, cex.axis=0.5, mgp=c(3, -.3 , 0), tck=-0.01, lwd=0.5)
lines(x=c((branching.times(comptree_anther_shape_noNA)[1] - 14.5),(branching.times(comptree_anther_shape_noNA)[1] - 14.5)),y=c(1,900),lwd=1, col="dimgray", lty = "dashed")
```

```{r,label="shifts anther shape PC1 and PC2 data PhyloEM with tips", fig.height=45, fig.width=15,fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE, eval=T}
plot(PhyloEM_PC1PC2anther, show.tip.label=T, cex=0.075,edge.width=2)
edgelabels(frame="n",col="red",cex=0.5)
tiplabels(bg=colors_subfamily, pch=22, cex=0.3, adj=2.5, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.3, adj=2.8, lwd=0, col=colors_subfamily)
 
legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
   "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
   "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
   col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
   adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)
 
# axisPhylo(cex = 0.3)
```

\pagebreak

- l1ou

```{r,label="shifts anther shape data l1ou", fig.height=8, fig.width=8.5, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
comptree_anther_shape_noNA <- average_tr_tips(comptree_anther_noNA)
### estimate shifts
#anther_shape_shifts_noNA <- adjust_data(comptree_anther_shape_noNA, sortedData_anther_noNA[,c(3:4)]) 
#shifts_anther_shape_shifts_noNA <- estimate_shift_configuration(anther_shape_shifts_noNA$tree, anther_shape_shifts_noNA$Y, max.nShifts=50, root.model="OUrandomRoot",  criterion="pBIC", nCores = 4)  
#saveRDS(shifts_anther_shape_shifts_noNA,"results/anther_shifts_noNA_2shapevars.rds")
shifts_anther_shape_shifts_noNA <- readRDS("results/anther_shifts_noNA_2shapevars.rds")

### estimate convergent shifts
#conv_anther_shape_shifts_noNA <- estimate_convergent_regimes(shifts_anther_shape_shifts_noNA, criterion =  "pBIC",method = "backward",fixed.alpha = FALSE, nCores = 4)
#saveRDS(conv_anther_shape_shifts_noNA,"results/conv_anther_shifts_noNA_2shapevars.rds")
conv_anther_shape_shifts_noNA <- readRDS("results/conv_anther_shifts_noNA_2shapevars.rds")

plot(shifts_anther_shape_shifts_noNA, show.tip.label=F,cex=0.25,edge.shift.ann=F,edge.ann.cex=0.5)

par(lwd = 0.1)
nodelabels(pie = recon_yang_anthers$states, piecol = c("orange","magenta","red","blue","black","gold","green","aquamarine"), cex = 0.2)

tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.51, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.512, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.513, lwd=0, col=cols_pollinator)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.52, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.522, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.523, lwd=0, col=colors_subfamily)

legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
  "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
  "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
  col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
  adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)


legend(0.175,462, legend = c("Bee","Honeyeater","Hummingbird","Hummingbird OW","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
  col = c("blue","orange","magenta","red","black","gold","green","aquamarine"),
  adj = 0,  cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)

```

```{r,label="shifts anther shape data l1ou with tips", fig.height=45, fig.width=25,fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE, eval=T}

plot(shifts_anther_shape_shifts_noNA, show.tip.label=T,cex=0.4,edge.shift.ann=F,edge.ann.cex=0.5)

par(lwd = 0.1)
nodelabels(pie = recon_yang_anthers$states, piecol = c("orange","magenta","red","blue","black","gold","green","aquamarine"), cex = 0.2)

tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.51, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.512, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.513, lwd=0, col=cols_pollinator)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.52, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.522, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.523, lwd=0, col=colors_subfamily)

legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
  "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
  "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
  col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
  adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)


legend(0.175,462, legend = c("Bee","Honeyeater","Hummingbird","Hummingbird OW","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
  col = c("blue","orange","magenta","red","black","gold","green","aquamarine"),
  adj = 0,  cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)

```

\pagebreak

#### Size

```{r, label="shifts anther length no NA", fig.height=9, fig.width=9,cache=FALSE,fig.align='center', echo=FALSE, message=FALSE, warning=FALSE}
# reduce to rows of anther with some data

anther_length_noNA <- all_data_anthers[complete.cases(all_data_anthers$total_large_anther_length),]

Overlap_anther_noNA <- name.check(tree, anther_length_noNA) 
comptree_anther_noNA <- drop.tip(tree, Overlap_anther_noNA$tree_not_data)

match_anther_noNA <- match(comptree_anther_noNA$tip.label, rownames(anther_length_noNA))  
sortedData_anther_noNA <- anther_length_noNA[,][match_anther_noNA,]

comptree_anther_noNA <- average_tr_tips(comptree_anther_noNA)

### ASR

sortedData_anther_noNA$pollinator_referenced[is.na(sortedData_anther_noNA$pollinator_referenced)] <- "-"
sortedData_anther_noNA$pollinator_referenced <- droplevels(sortedData_anther_noNA$pollinator_referenced)


sortedData_anther_noNA_w_questionmarks <- sortedData_anther_noNA
sortedData_anther_noNA_w_questionmarks$pollinator_referenced <- gsub("-","?",sortedData_anther_noNA_w_questionmarks$pollinator_referenced)

# recon_yang_anther_size <- rayDISC(comptree_anther_noNA,sortedData_anther_noNA_w_questionmarks,model="ER",node.states="marginal",charnum = 5, root.p='yang')
# 
# saveRDS(recon_yang_anther_size, "results/recon_yang_anther_size_ER.rds")
recon_yang_anther_size <- readRDS( "results/recon_yang_anther_size_ER.rds")

### tiplabels

colors_subfamily <- character(length(sortedData_anther_noNA$subfamily)) 
colors_subfamily[sortedData_anther_noNA$subfamily == "Arbutoideae"] <- "gold"
colors_subfamily[sortedData_anther_noNA$subfamily == "Cassiopoideae"] <- "black"
colors_subfamily[sortedData_anther_noNA$subfamily == "Enkianthoideae"] <- "pink"
colors_subfamily[sortedData_anther_noNA$subfamily == "Ericoideae"] <- "green"
colors_subfamily[sortedData_anther_noNA$subfamily == "Harrimanelloideae"] <- "aquamarine"
colors_subfamily[sortedData_anther_noNA$subfamily == "Monotropoideae"] <- "orange"
colors_subfamily[sortedData_anther_noNA$subfamily == "Pyroloideae"] <- "brown"
colors_subfamily[sortedData_anther_noNA$subfamily == "Styphelioideae"] <- "blue"
colors_subfamily[sortedData_anther_noNA$subfamily == "Vaccinioideae"] <- "red"
colors_subfamily[sortedData_anther_noNA$subfamily == "outgroup"] <- "black"

cols_pollinator <- character(length(sortedData_anther_noNA$pollinator_referenced)) 
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "-"] <- "white"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "honeyeater"] <- "orange"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "hummingbird"] <- "magenta"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "hummingbird_OW"] <- "red"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "insect"] <- "blue"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "lepidoptera"] <- "black"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "long_proboscid_fly"] <- "gold"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "sunbird"] <- "green"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "wind"] <- "aquamarine"
```

- PhylogeneticEM

```{r, label="shifts anther length phyloEM no NA ", fig.height=9, fig.width=9,cache=FALSE,fig.align='center', echo=FALSE, message=FALSE, warning=FALSE}

sortedData_anther_noNA$log_total_large_anther_length <- log(sortedData_anther_noNA$total_large_anther_length)

# anther_length_EM_ready <- t(sortedData_anther_noNA[11])
# colnames(anther_length_EM_ready) <- sortedData_anther_noNA$species
# PhyloEM_anther_length <- PhyloEM(phylo = comptree_anther_noNA,
#                       Y_data = anther_length_EM_ready,
#                       process = "scOU",
#                       random.root = TRUE,
#                       stationary.root = TRUE,
#                       K_max = 20,
#                       nbr_alpha = 4,
#                       parallel_alpha = TRUE,
#                       Ncores = 3)
# 
# saveRDS(PhyloEM_anther_length,"results/PhyloEM_anther_length_log.rds")
PhyloEM_anther_length <- readRDS("results/PhyloEM_anther_length_log.rds")

PhyloEM_anther_length_params <- params_process(PhyloEM_anther_length)
# 
# cols_edges_anther_shape_noNA <- character(length(comptree_anther_noNA$edge)) 
# cols_edges_anther_shape_noNA[1:2684] <- "gray"
# cols_edges_anther_shape_noNA[359:659] <- "forestgreen"
# cols_edges_anther_shape_noNA[374:422] <- "magenta"
# cols_edges_anther_shape_noNA[411:413] <- "skyblue"
# cols_edges_anther_shape_noNA[444:444] <- "red"
# cols_edges_anther_shape_noNA[452:452] <- "purple"
# cols_edges_anther_shape_noNA[459:459] <- "brown"
# cols_edges_anther_shape_noNA[473:475] <- "orange"
# cols_edges_anther_shape_noNA[495:497] <- "green"
# cols_edges_anther_shape_noNA[512:552] <- "blue"
# cols_edges_anther_shape_noNA[558:558] <- "black"
# cols_edges_anther_shape_noNA[567:567] <- "pink"
# cols_edges_anther_shape_noNA[568:570] <- "aquamarine"
# cols_edges_anther_shape_noNA[607:607] <- "gold"
# cols_edges_anther_shape_noNA[619:619] <- "dimgray"
# cols_edges_anther_shape_noNA[627:629] <- "darkolivegreen3"
# cols_edges_anther_shape_noNA[635:635] <- "darksalmon"
# cols_edges_anther_shape_noNA[644:646] <- "moccasin"
# cols_edges_anther_shape_noNA[647:659] <- "maroon3"
# cols_edges_anther_shape_noNA[854:1026] <- "dodgerblue3"
# cols_edges_anther_shape_noNA[1012:1026] <- "firebrick3"
# 
# 
# cols_tips_anther_shape_noNA <- character(length(comptree_anther_noNA$tip.label)) 
# cols_tips_anther_shape_noNA[1:514] <- "gray"
# cols_tips_anther_shape_noNA[158:308] <- "forestgreen"
# cols_tips_anther_shape_noNA[284:308] <- "magenta"
# cols_tips_anther_shape_noNA[294:295] <- "skyblue"
# cols_tips_anther_shape_noNA[166:166] <- "red"
# cols_tips_anther_shape_noNA[169:169] <- "purple"
# cols_tips_anther_shape_noNA[174:174] <- "brown"
# cols_tips_anther_shape_noNA[175:176] <- "orange"
# cols_tips_anther_shape_noNA[275:276] <- "green"
# cols_tips_anther_shape_noNA[247:267] <- "blue"
# cols_tips_anther_shape_noNA[246:246] <- "black"
# cols_tips_anther_shape_noNA[240:240] <- "pink"
# cols_tips_anther_shape_noNA[241:242] <- "aquamarine"
# cols_tips_anther_shape_noNA[201:201] <- "gold"
# cols_tips_anther_shape_noNA[224:224] <- "dimgray"
# cols_tips_anther_shape_noNA[205:206] <- "darkolivegreen3"
# cols_tips_anther_shape_noNA[209:209] <- "darksalmon"
# cols_tips_anther_shape_noNA[212:213] <- "moccasin"
# cols_tips_anther_shape_noNA[214:220] <- "maroon3"
# cols_tips_anther_shape_noNA[416:503] <- "dodgerblue3"
# cols_tips_anther_shape_noNA[473:480] <- "firebrick3"
# 

#plot(PhyloEM_anther_length,automatic_colors=F,color_edges=cols_edges_anther_shape_noNA,
#     color_characters=cols_tips_anther_shape_noNA,root.edge=F, show.tip.label=F)

plot(PhyloEM_anther_length,automatic_colors=T,root.edge=F, show.tip.label=F)

tiplabels(bg=colors_subfamily, pch=22, cex=0.3, adj=2.5, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.3, adj=2.8, lwd=0, col=colors_subfamily)

par(lwd = 0.1)

nodelabels(pie = recon_yang_anther_size$states, piecol = c("orange","magenta","red","blue","black","gold","green","aquamarine"), cex = 0.25)

legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
  "Ericoideae","Harrimanelloideae","Monotropoideae","Pyroloideae","Styphelioideae",
  "Vaccinioideae"),title = "Subfamily (tips= 514)",inset = 0, pch = c(15),
  col = c("gold","black","pink","green","aquamarine","orange","brown","blue","red"),
  adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)

legend(29,590, legend = c("Bee","Honeyeater","Hummingbird","Hummingbird OW","Lepidoptera","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),col = c("blue","orange","magenta","red","black","green","aquamarine"),
        adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)

axisPhylo(cex = 0.3)

###

# plot(PhyloEM_anther_length, show.tip.label=F,edge.width=2)
# 
# tiplabels(bg=colors_subfamily, pch=22, cex=0.3, adj=2.5, lwd=0, col=colors_subfamily)
# tiplabels(bg=colors_subfamily, pch=22, cex=0.3, adj=2.8, lwd=0, col=colors_subfamily)
# 
# tiplabels(bg=cols_pollinator, pch=22, cex=0.3, adj=4.2, lwd=0, col=cols_pollinator)
# tiplabels(bg=cols_pollinator, pch=22, cex=0.3, adj=4.5, lwd=0, col=cols_pollinator)
# 
# par(lwd = 0.1)
# 
# nodelabels(pie = recon_yang_anther_size$states, piecol = c("orange","magenta","red","blue","black","gold","green","aquamarine"), cex = 0.25)
# 
# legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
#   "Ericoideae","Harrimanelloideae","Monotropoideae","Pyroloideae","Styphelioideae",
#   "Vaccinioideae"),title = "Subfamily (tips= 514)",inset = 0, pch = c(15),
#   col = c("gold","black","pink","green","aquamarine","orange","brown","blue","red"),
#   adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)
# #axisPhylo(cex = 0.3)
# 
# axisPhylo(cex = 0.3)
# 
# legend(29,550, legend = c("Honeyeater","Hummingbird","Hummingbird OW","Bee","Lepidoptera","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),col = c("orange","magenta","red","blue","black","gold","green","aquamarine"),
#        adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)

```


```{r,label="shifts anther length data no NA PhyloEM with tips", fig.height=45, fig.width=25, eval=T,fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
 plot(PhyloEM_anther_length, show.tip.label=T, cex=0.25,edge.width=2)
 edgelabels(frame="n",col="red",cex=0.5)
 tiplabels(bg=colors_subfamily, pch=22, cex=0.3, adj=2.5, lwd=0, col=colors_subfamily)
 tiplabels(bg=colors_subfamily, pch=22, cex=0.3, adj=2.8, lwd=0, col=colors_subfamily)
 
# legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
#   "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
#   "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
#   col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
#   adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)
# 
# axisPhylo(cex = 0.3)
```
 
\pagebreak

- l1ou

```{r, label="shifts anther length l1ou no NA ", fig.height=9, fig.width=9,cache=FALSE,fig.align='center', echo=FALSE, message=FALSE, warning=FALSE}
### shifts

#anther_length_shifts_noNA <- adjust_data(comptree_anther_noNA, sortedData_anther_noNA[,11]) 
#shifts_anther_length_shifts_noNA <- estimate_shift_configuration(anther_length_shifts_noNA$tree, anther_length_shifts_noNA$Y, max.nShifts=50, root.model="OUrandomRoot",  criterion="pBIC")  

#saveRDS(shifts_anther_length_shifts_noNA,"results/shifts_anther_noNA_length_log.rds")
#shifts_anther_length_noNA <-readRDS("results/shifts_anther_noNA_length_log.rds")

### estimate convergent shifts
#conv_shifts_anther_length_noNA <- estimate_convergent_regimes(shifts_anther_length_noNA, criterion =  "pBIC",method = "backward",fixed.alpha = FALSE, nCores = 4)
#saveRDS(conv_shifts_anther_length_noNA,"results/conv_shifts_anther_noNA_length_log.rds")
conv_shifts_anther_length_noNA <- readRDS("results/conv_shifts_anther_noNA_length_log.rds")

plot(conv_shifts_anther_length_noNA, show.tip.label=F,cex=0.25,edge.shift.ann=F)
nodelabels(pie = recon_yang_anther_size$states, piecol = c("orange","magenta","red","blue","black","green","aquamarine"), cex = 0.35)
tiplabels(bg=colors_subfamily, pch=22, cex=2, adj=0.55, lwd=0.1, col=colors_subfamily)
```

```{r,label="shifts anther length l1ou no NA with tips", fig.height=45, fig.width=25, eval=T,fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
 
plot(conv_shifts_anther_length_noNA, show.tip.label=T,cex=0.4,edge.shift.ann=F)
nodelabels(pie = recon_yang_anther_size$states, piecol = c("orange","magenta","red","blue","black","green","aquamarine"), cex = 0.35)
tiplabels(bg=colors_subfamily, pch=22, cex=2, adj=0.55, lwd=0.1, col=colors_subfamily)

```
 
\pagebreak

PGLS anther

```{r, label="match phylogeny to anther data for pgls", fig.height=4, fig.width=6, cache=FALSE,fig.align='center', echo=FALSE, message=FALSE, warning=FALSE} 
sortedData_shape_anther_noNA_pgls <- subset(all_data_anthers,!all_data_anthers$pollinator_referenced=="-")
sortedData_shape_anther_noNA_pgls <- sortedData_shape_anther_noNA_pgls[complete.cases(sortedData_shape_anther_noNA_pgls$PC1_anthers),]
sortedData_shape_anther_noNA_pgls$pollinator_referenced <- droplevels(sortedData_shape_anther_noNA_pgls$pollinator_referenced)

Overlap_anther_noNA_pgls <- name.check(tree, sortedData_shape_anther_noNA_pgls) 
comptree_shape_anther_noNA_pgls <- drop.tip(tree, Overlap_anther_noNA_pgls$tree_not_data)
match_anther_noNA_pgls <- match(comptree_shape_anther_noNA_pgls$tip.label, rownames(sortedData_shape_anther_noNA_pgls))  
sortedData_shape_anther_noNA_pgls <- sortedData_shape_anther_noNA_pgls[,][match_anther_noNA_pgls,]
sortedData_shape_anther_noNA_pgls$pollinator_referenced <- as.factor(sortedData_shape_anther_noNA_pgls$pollinator_referenced)

###

sortedData_length_anther_noNA_pgls <- all_data_anthers[complete.cases(all_data_anthers$total_large_anther_length),]
sortedData_length_anther_noNA_pgls <- subset(sortedData_length_anther_noNA_pgls,!sortedData_length_anther_noNA_pgls$pollinator_referenced=="-")


Overlap_length_anther_noNA_pgls <- name.check(tree, sortedData_length_anther_noNA_pgls) 
comptree_length_anther_noNA_pgls <- drop.tip(tree, Overlap_length_anther_noNA_pgls$tree_not_data)
match_length_anther_noNA_pgls <- match(comptree_length_anther_noNA_pgls$tip.label, rownames(sortedData_length_anther_noNA_pgls))  
sortedData_length_anther_noNA_pgls <- sortedData_length_anther_noNA_pgls[,][match_length_anther_noNA_pgls,]
sortedData_length_anther_noNA_pgls$pollinator_referenced <- as.factor(sortedData_length_anther_noNA_pgls$pollinator_referenced)
sortedData_length_anther_noNA_pgls$pollinator_referenced <- droplevels(sortedData_length_anther_noNA_pgls$pollinator_referenced)

sortedData_length_anther_noNA_pgls$log_total_large_anther_length <- log(sortedData_length_anther_noNA_pgls$total_large_anther_length)

```

```{r, label="pgls anther continent",eval=T, fig.height=8, fig.width=8, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
### PGLS continent-PC1
sortedData_shape_anther_noNA_pgls$continent = relevel(as.factor(sortedData_shape_anther_noNA_pgls$continent), "South_America")
sortedData_shape_anther_noNA_pgls$continent <- droplevels(sortedData_shape_anther_noNA_pgls$continent)
pglsModel <- gls(PC1_anthers~ continent,correlation = corBrownian(phy=comptree_shape_anther_noNA_pgls),  data = sortedData_shape_anther_noNA_pgls)
pglsModel_lambda <- gls(PC1_anthers ~ continent,  correlation = corPagel(1,phy=comptree_shape_anther_noNA_pgls), data = sortedData_shape_anther_noNA_pgls)
pglsModel_OU <- gls(PC1_anthers ~ continent,  correlation = corMartins(1,phy=comptree_shape_anther_noNA_pgls), data = sortedData_shape_anther_noNA_pgls)
#anova(pglsModel,pglsModel_lambda,pglsModel_OU)   
#anova(pglsModel_lambda)
#kable(summary(pglsModel_lambda)$tTable, digits = 3, caption="PGLS anther shape PC1 and continent")    
pgls_res_continent_anther_PC1 <- summary(pglsModel_lambda)$tTable 
pgls_res_continent_anther_PC1 <- cbind(data.frame(c("anther PC1"),c("Intercept: South America","Africa","Asia","Australia","Europe ","North America")),pgls_res_continent_anther_PC1)
colnames(pgls_res_continent_anther_PC1)[c(1:2)] <- c("trait","group") 
rownames(pgls_res_continent_anther_PC1) <- NULL
pgls_res_continent_anther_PC1$`p-value` <- p.adjust(pgls_res_continent_anther_PC1$`p-value`)
r2 <- R2(pglsModel_lambda)[2]
pgls_res_continent_anther_PC1 <- cbind(pgls_res_continent_anther_PC1,r2)
pgls_res_continent_anther_PC1$N <- sortedData_shape_anther_noNA_pgls$continent %>% table() 
pgls_res_continent_anther_PC1 <- pgls_res_continent_anther_PC1[c(1:2,8,3:7)]

### PGLS continent-PC2
pglsModel <- gls(PC2_anthers~ continent,correlation = corBrownian(phy=comptree_shape_anther_noNA_pgls),  data = sortedData_shape_anther_noNA_pgls)
pglsModel_lambda <- gls(PC2_anthers ~ continent,  correlation = corPagel(1,phy=comptree_shape_anther_noNA_pgls), data = sortedData_shape_anther_noNA_pgls)
pglsModel_OU <- gls(PC2_anthers ~ continent,  correlation = corMartins(1,phy=comptree_shape_anther_noNA_pgls), data = sortedData_shape_anther_noNA_pgls)
#anova(pglsModel,pglsModel_lambda,pglsModel_OU)   
#anova(pglsModel_lambda)
#kable(summary(pglsModel_lambda)$tTable, digits = 3, caption="PGLS anther shape PC2 and continent")    
pgls_res_continent_anther_PC2 <- summary(pglsModel_lambda)$tTable 
pgls_res_continent_anther_PC2 <- cbind(data.frame(c("anther PC2"),c("Intercept: South America","Africa","Asia","Australia","Europe ","North America")),pgls_res_continent_anther_PC2)
colnames(pgls_res_continent_anther_PC2)[c(1:2)] <- c("trait","group") 
rownames(pgls_res_continent_anther_PC2) <- NULL
pgls_res_continent_anther_PC2$`p-value` <- p.adjust(pgls_res_continent_anther_PC2$`p-value`)
r2 <- R2(pglsModel_lambda)[2]
pgls_res_continent_anther_PC2 <- cbind(pgls_res_continent_anther_PC2,r2)
pgls_res_continent_anther_PC2$N <- sortedData_shape_anther_noNA_pgls$continent %>% table() 
pgls_res_continent_anther_PC2 <- pgls_res_continent_anther_PC2[c(1:2,8,3:7)]

### PGLS continent-anther length

sortedData_length_anther_noNA_pgls$continent = relevel(as.factor(sortedData_length_anther_noNA_pgls$continent), "South_America")
sortedData_length_anther_noNA_pgls$continent <- droplevels(sortedData_length_anther_noNA_pgls$continent)

pglsModel <- gls(log_total_large_anther_length~ continent,correlation = corBrownian(phy=comptree_length_anther_noNA_pgls),  data = sortedData_length_anther_noNA_pgls)
pglsModel_lambda <- gls(log_total_large_anther_length ~ continent,  correlation = corPagel(1,phy=comptree_length_anther_noNA_pgls), data = sortedData_length_anther_noNA_pgls)
#pglsModel_OU <- gls(log_total_large_anther_length ~ continent,  correlation = corMartins(1,phy=comptree_length_anther_noNA_pgls), data = sortedData_length_anther_noNA_pgls)
#anova(pglsModel,pglsModel_lambda,pglsModel_OU)   
#anova(pglsModel_lambda)
#kable(summary(pglsModel_lambda)$tTable, digits = 3, caption="PGLS anther length and continent")    
pgls_res_length_anther <- summary(pglsModel_lambda)$tTable
pgls_res_length_anther <- cbind(data.frame(c("log anther length"),c("Intercept: South America","Africa","Asia","Australia","Europe ","North America")),pgls_res_length_anther)
colnames(pgls_res_length_anther)[c(1:2)] <- c("trait","group") 
rownames(pgls_res_length_anther) <- NULL
pgls_res_length_anther$`p-value` <- p.adjust(pgls_res_length_anther$`p-value`)
r2 <- R2(pglsModel_lambda)[2]
pgls_res_length_anther <- cbind(pgls_res_length_anther,r2)
pgls_res_length_anther$N <- sortedData_length_anther_noNA_pgls$continent %>% table() 
pgls_res_continent_length_anther_log <- pgls_res_length_anther[c(1:2,8,3:7)]
```

```{r,label="make boxplots of anther by geography", fig.height=4, fig.width=10, fig.align='center',echo=FALSE, cache=F, message=FALSE, warning=FALSE,eval=T}
# Anther
# sortedData_shape_anther_noNA_pgls$continent <- factor(sortedData_shape_anther_noNA_pgls$continent, 
#            levels=c("Africa","Asia","Australia","Europe","North_America","South_America"))
# 
# boxplot_anther_PC1_geography <-ggplot(sortedData_shape_anther_noNA_pgls,aes(x=continent,y=PC1_anthers, fill=continent,color=continent)) 
# boxplot_anther_PC1_geography <- boxplot_anther_PC1_geography + geom_boxplot(alpha=0.5,outlier.shape=NA)   
# boxplot_anther_PC1_geography <- boxplot_anther_PC1_geography + 
#   scale_fill_manual(values=c("red","orange","purple","blue","green","forestgreen"),guide="none") + scale_color_manual(values=c("red","orange","purple","blue","green",                                "forestgreen"),guide="none") 
# 
# boxplot_anther_PC1_geography <- boxplot_anther_PC1_geography + guides(fill=FALSE) + theme_bw() +
#   geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 
# 
# boxplot_anther_PC1_geography <- boxplot_anther_PC1_geography  + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text(size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("Africa"="Africa","Asia"="Asia","Australia" ="Australia", "Europe" = "Europe","North_America"="North America","South_America"="South America")) + ylab("Anther PC1")
# 
# #boxplot_anther_PC1_geography
# 
# #
# 
# boxplot_anther_PC2_geography <-ggplot(sortedData_shape_anther_noNA_pgls,aes(x=continent,y=PC2_anthers, fill=continent,color=continent)) 
# boxplot_anther_PC2_geography <- boxplot_anther_PC2_geography + geom_boxplot(alpha=0.5,outlier.shape=NA)   
# boxplot_anther_PC2_geography <- boxplot_anther_PC2_geography + 
#   scale_fill_manual(values=c("red","orange","purple","blue","green","forestgreen"),guide="none") + scale_color_manual(values=c("red","orange","purple","blue","green",                                "forestgreen"),guide="none") 
# 
# boxplot_anther_PC2_geography <- boxplot_anther_PC2_geography + guides(fill=FALSE) + theme_bw() +
#   geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 
# 
# boxplot_anther_PC2_geography <- boxplot_anther_PC2_geography  + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("Africa"="Africa","Asia"="Asia","Australia" ="Australia", "Europe" = "Europe","North_America"="North America","South_America"="South America")) + ylab("Anther PC2")
# 
# #boxplot_anther_PC2_geography
# 
# # 
# sortedData_length_anther_noNA_pgls$continent <- factor(sortedData_length_anther_noNA_pgls$continent, 
#            levels=c("Africa","Asia","Australia","Europe","North_America","South_America"))
# 
# boxplot_anther_length_geography <-ggplot(sortedData_length_anther_noNA_pgls,aes(x=continent,y=total_large_anther_length, fill=continent,color=continent)) 
# boxplot_anther_length_geography <- boxplot_anther_length_geography + geom_boxplot(alpha=0.5,outlier.shape=NA)   
# boxplot_anther_length_geography <- boxplot_anther_length_geography + 
#   scale_fill_manual(values=c("red","orange","purple","blue","green","forestgreen"),guide="none") + scale_color_manual(values=c("red","orange","purple","blue","green",                                "forestgreen"),guide="none") 
# 
# boxplot_anther_length_geography <- boxplot_anther_length_geography + guides(fill=FALSE) + theme_bw() +
#   geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 
# 
# boxplot_anther_length_geography <- boxplot_anther_length_geography  + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("Africa"="Africa","Asia"="Asia","Australia" ="Australia", "Europe" = "Europe","North_America"="North America","South_America"="South America")) + ylab("Anther length (mm)")
# 
# 
# #boxplot_anther_length_geography
# 
# # 
# 
# boxplot_log_anther_length_geography <-ggplot(sortedData_length_anther_noNA_pgls,aes(x=continent,y=log_total_large_anther_length, fill=continent,color=continent)) 
# boxplot_log_anther_length_geography <- boxplot_log_anther_length_geography + geom_boxplot(alpha=0.5,outlier.shape=NA)   
# boxplot_log_anther_length_geography <- boxplot_log_anther_length_geography + 
#   scale_fill_manual(values=c("red","orange","purple","blue","green","forestgreen"),guide="none") + scale_color_manual(values=c("red","orange","purple","blue","green", "forestgreen"),guide="none") 
# 
# boxplot_log_anther_length_geography <- boxplot_log_anther_length_geography + guides(fill=FALSE) + theme_bw() +
#   geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 
# 
# boxplot_log_anther_length_geography <- boxplot_log_anther_length_geography  + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("Africa"="Africa","Asia"="Asia","Australia" ="Australia", "Europe" = "Europe","North_America"="North America","South_America"="South America")) + ylab("Anther length (log)")
# 

#boxplot_log_anther_length_geography
```

```{r,label="make boxplots of anther by geography all data", fig.height=4, fig.width=10, fig.align='center',echo=FALSE, cache=F, message=FALSE, warning=FALSE,eval=T}
# Anther
pcs_anther$continent <- factor(pcs_anther$continent, 
                                                      levels=c("Africa","Asia","Australia","Europe","North_America","South_America"))

boxplot_anther_PC1_geography <-ggplot(pcs_anther,aes(x=continent,y=PC1, fill=continent,color=continent)) 
boxplot_anther_PC1_geography <- boxplot_anther_PC1_geography + geom_boxplot(alpha=0.5,outlier.shape=NA)   
boxplot_anther_PC1_geography <- boxplot_anther_PC1_geography + 
  scale_fill_manual(values=c("red","orange","purple","blue","green","forestgreen"),guide="none") + scale_color_manual(values=c("red","orange","purple","blue","green",                                "forestgreen"),guide="none") 

boxplot_anther_PC1_geography <- boxplot_anther_PC1_geography + guides(fill=FALSE) + theme_bw() +
  geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 

boxplot_anther_PC1_geography <- boxplot_anther_PC1_geography  + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text(size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("Africa"="Africa","Asia"="Asia","Australia" ="Australia", "Europe" = "Europe","North_America"="North America","South_America"="South America")) + ylab("Anther PC1")

#boxplot_anther_PC1_geography

#

boxplot_anther_PC2_geography <-ggplot(pcs_anther,aes(x=continent,y=PC2, fill=continent,color=continent)) 
boxplot_anther_PC2_geography <- boxplot_anther_PC2_geography + geom_boxplot(alpha=0.5,outlier.shape=NA)   
boxplot_anther_PC2_geography <- boxplot_anther_PC2_geography + 
  scale_fill_manual(values=c("red","orange","purple","blue","green","forestgreen"),guide="none") + scale_color_manual(values=c("red","orange","purple","blue","green",                                "forestgreen"),guide="none") 

boxplot_anther_PC2_geography <- boxplot_anther_PC2_geography + guides(fill=FALSE) + theme_bw() +
  geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 

boxplot_anther_PC2_geography <- boxplot_anther_PC2_geography  + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("Africa"="Africa","Asia"="Asia","Australia" ="Australia", "Europe" = "Europe","North_America"="North America","South_America"="South America")) + ylab("Anther PC2")

#boxplot_anther_PC2_geography

# 

pcs_anther_length_no_NA_continent$log_total_large_anther_length <- log(pcs_anther_length_no_NA_continent$total_large_anther_length)

pcs_anther_length_no_NA_continent$continent <- factor(pcs_anther_length_no_NA_continent$continent, 
                                                       levels=c("Africa","Asia","Australia","Europe","North_America","South_America"))


boxplot_anther_length_geography <-ggplot(pcs_anther_length_no_NA_continent,aes(x=continent,y=total_large_anther_length, fill=continent,color=continent)) 
boxplot_anther_length_geography <- boxplot_anther_length_geography + geom_boxplot(alpha=0.5,outlier.shape=NA)   
boxplot_anther_length_geography <- boxplot_anther_length_geography + 
  scale_fill_manual(values=c("red","orange","purple","blue","green","forestgreen"),guide="none") + scale_color_manual(values=c("red","orange","purple","blue","green",                                "forestgreen"),guide="none") 

boxplot_anther_length_geography <- boxplot_anther_length_geography + guides(fill=FALSE) + theme_bw() +
  geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 

boxplot_anther_length_geography <- boxplot_anther_length_geography  + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("Africa"="Africa","Asia"="Asia","Australia" ="Australia", "Europe" = "Europe","North_America"="North America","South_America"="South America")) + ylab("Anther length (mm)")


#boxplot_anther_length_geography

# 

boxplot_log_anther_length_geography <-ggplot(pcs_anther_length_no_NA_continent,aes(x=continent,y=log_total_large_anther_length, fill=continent,color=continent)) 
boxplot_log_anther_length_geography <- boxplot_log_anther_length_geography + geom_boxplot(alpha=0.5,outlier.shape=NA)   
boxplot_log_anther_length_geography <- boxplot_log_anther_length_geography + 
  scale_fill_manual(values=c("red","orange","purple","blue","green","forestgreen"),guide="none") + scale_color_manual(values=c("red","orange","purple","blue","green", "forestgreen"),guide="none") 

boxplot_log_anther_length_geography <- boxplot_log_anther_length_geography + guides(fill=FALSE) + theme_bw() +
  geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 

boxplot_log_anther_length_geography <- boxplot_log_anther_length_geography  + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("Africa"="Africa","Asia"="Asia","Australia" ="Australia", "Europe" = "Europe","North_America"="North America","South_America"="South America")) + ylab("Anther length (log)")


#boxplot_log_anther_length_geography
```

```{r,label="make boxplots of anther shape pollinator_referenced", fig.height=4, fig.width=10, fig.align='center',echo=FALSE, cache=TRUE, message=FALSE, warning=FALSE,eval=T}
#sortedData_shape_anther_noNA_pgls$pollinator_referenced = #relevel(as.factor(sortedData_shape_anther_noNA_pgls$pollinator_referenced), "honeyeater")
# 
# sortedData_shape_anther_noNA_pgls$pollinator_referenced <- factor(sortedData_shape_anther_noNA_pgls$pollinator_referenced, 
#        levels=c("honeyeater", "hummingbird", "hummingbird_OW","sunbird",
#                   "insect","lepidoptera","long_proboscid_fly","wind"))
# 
# # anther
# 
# boxplot_anther_PC1_pollinators_referenced <-ggplot(sortedData_shape_anther_noNA_pgls,aes(x=pollinator_referenced,y=PC1_anthers, fill=pollinator_referenced,color=pollinator_referenced)) 
# boxplot_anther_PC1_pollinators_referenced <- boxplot_anther_PC1_pollinators_referenced + geom_boxplot(alpha=0.5,outlier.shape=NA)   
# boxplot_anther_PC1_pollinators_referenced <- boxplot_anther_PC1_pollinators_referenced + 
#   scale_fill_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") + scale_color_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") 
# 
# boxplot_anther_PC1_pollinators_referenced <- boxplot_anther_PC1_pollinators_referenced + guides(fill=FALSE) + theme_bw() +
#   geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 
# 
# boxplot_anther_PC1_pollinators_referenced <- boxplot_anther_PC1_pollinators_referenced  + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("honeyeater" = "Honeyeater", "hummingbird" = "Hummingbird","hummingbird_OW" = "Hummingbird OW", "insect" = "Bee",
#                             "lepidoptera"="Lepidoptera","long_proboscid_fly"="Long proboscid fly", 
#                             "sunbird"="Sunbird","wind"="Wind")) + ylab("Anther PC1")
# 
# #boxplot_anther_PC1_pollinators_referenced
# 
# #
# 
# boxplot_anther_PC2_pollinators_referenced <-ggplot(sortedData_shape_anther_noNA_pgls,aes(x=pollinator_referenced,y=PC2_anthers, fill=pollinator_referenced,color=pollinator_referenced)) 
# boxplot_anther_PC2_pollinators_referenced <- boxplot_anther_PC2_pollinators_referenced + geom_boxplot(alpha=0.5,outlier.shape=NA)   
# boxplot_anther_PC2_pollinators_referenced <- boxplot_anther_PC2_pollinators_referenced + 
#   scale_fill_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") + scale_color_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") 
# 
# boxplot_anther_PC2_pollinators_referenced <- boxplot_anther_PC2_pollinators_referenced + guides(fill=FALSE) + theme_bw() +
#   geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 
# 
# boxplot_anther_PC2_pollinators_referenced <- boxplot_anther_PC2_pollinators_referenced  + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("honeyeater" = "Honeyeater", "hummingbird" = "Hummingbird","hummingbird_OW" = "Hummingbird OW", "insect" = "Bee",
#                             "lepidoptera"="Lepidoptera","long_proboscid_fly"="Long proboscid fly", 
#                             "sunbird"="Sunbird","wind"="Wind")) + ylab("Anther PC2")
# 
# #boxplot_anther_PC2_pollinators_referenced
# 
# #
# 
# #sortedData_length_anther_noNA_pgls$pollinator_referenced = #relevel(as.factor(sortedData_length_anther_noNA_pgls$pollinator_referenced), "honeyeater")
# 
# sortedData_length_anther_noNA_pgls$pollinator_referenced <- factor(sortedData_length_anther_noNA_pgls$pollinator_referenced, 
#        levels=c("honeyeater", "hummingbird", "hummingbird_OW","sunbird",
#                   "insect","lepidoptera","wind"))
# 
# boxplot_anther_length_pollinators_referenced <-ggplot(sortedData_length_anther_noNA_pgls,aes(x=pollinator_referenced,y=total_large_anther_length, fill=pollinator_referenced,color=pollinator_referenced)) 
# boxplot_anther_length_pollinators_referenced <- boxplot_anther_length_pollinators_referenced + geom_boxplot(alpha=0.5,outlier.shape=NA)   
# boxplot_anther_length_pollinators_referenced <- boxplot_anther_length_pollinators_referenced + 
#   scale_fill_manual(values=c("orange","magenta","red","green","blue","black","aquamarine"),guide="none") + scale_color_manual(values=c("orange","magenta","red","green","blue","black","aquamarine"),guide="none") 
# 
# boxplot_anther_length_pollinators_referenced <- boxplot_anther_length_pollinators_referenced + guides(fill=FALSE) + theme_bw() +
#   geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 
# 
# boxplot_anther_length_pollinators_referenced <- boxplot_anther_length_pollinators_referenced  + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("honeyeater" = "Honeyeater", "hummingbird" = "Hummingbird","hummingbird_OW" = "Hummingbird OW", "insect" = "Bee",
#                             "lepidoptera"="Lepidoptera", 
#                             "sunbird"="Sunbird","wind"="Wind")) + ylab("Anther length (mm)")
# 
# #boxplot_anther_length_pollinators_referenced
# 
# boxplot_log_anther_length_pollinators_referenced <-ggplot(sortedData_length_anther_noNA_pgls,aes(x=pollinator_referenced,y=log_total_large_anther_length, fill=pollinator_referenced,color=pollinator_referenced)) 
# boxplot_log_anther_length_pollinators_referenced <- boxplot_log_anther_length_pollinators_referenced + geom_boxplot(alpha=0.5,outlier.shape=NA)   
# boxplot_log_anther_length_pollinators_referenced <- boxplot_log_anther_length_pollinators_referenced + 
#   scale_fill_manual(values=c("orange","magenta","red","green","blue","black","aquamarine"),guide="none") + scale_color_manual(values=c("orange","magenta","red","green","blue","black","aquamarine"),guide="none") 
# 
# boxplot_log_anther_length_pollinators_referenced <- boxplot_log_anther_length_pollinators_referenced + guides(fill=FALSE) + theme_bw() +
#   geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 
# 
# boxplot_log_anther_length_pollinators_referenced <- boxplot_log_anther_length_pollinators_referenced  + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("honeyeater" = "Honeyeater", "hummingbird" = "Hummingbird","hummingbird_OW" = "Hummingbird OW", "insect" = "Bee","lepidoptera"="Lepidoptera","sunbird"="Sunbird","wind"="Wind")) + ylab("Anther length (log)")

#boxplot_log_anther_length_pollinators_referenced
```

```{r,label="make boxplots of anther shape pollinator_referenced all data", fig.height=4, fig.width=10, fig.align='center',echo=FALSE, cache=TRUE, message=FALSE, warning=FALSE,eval=T}
#pcs_anther_no_NA$pollinator_referenced = #relevel(as.factor(pcs_anther_no_NA$pollinator_referenced), "honeyeater")

pcs_anther_no_NA$pollinator_referenced <- factor(pcs_anther_no_NA$pollinator_referenced, 
                                                                  levels=c("honeyeater", "hummingbird", "hummingbird_OW","sunbird",
                                                                           "insect","lepidoptera","long_proboscid_fly","wind"))

# anther

boxplot_anther_PC1_pollinators_referenced <-ggplot(pcs_anther_no_NA, aes(x=pollinator_referenced,y=PC1, fill=pollinator_referenced,color=pollinator_referenced)) 
boxplot_anther_PC1_pollinators_referenced <- boxplot_anther_PC1_pollinators_referenced + geom_boxplot(alpha=0.5,outlier.shape=NA)   
boxplot_anther_PC1_pollinators_referenced <- boxplot_anther_PC1_pollinators_referenced + 
  scale_fill_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") + scale_color_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") 

boxplot_anther_PC1_pollinators_referenced <- boxplot_anther_PC1_pollinators_referenced + guides(fill=FALSE) + theme_bw() +
  geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 

boxplot_anther_PC1_pollinators_referenced <- boxplot_anther_PC1_pollinators_referenced  + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("honeyeater" = "Honeyeater", "hummingbird" = "Hummingbird","hummingbird_OW" = "Hummingbird OW", "insect" = "Bee",
                                                                                                                                                                                                                                     "lepidoptera"="Lepidoptera","long_proboscid_fly"="Long proboscid fly", 
                                                                                                                                                                                                                                     "sunbird"="Sunbird","wind"="Wind")) + ylab("Anther PC1")

#boxplot_anther_PC1_pollinators_referenced

#

boxplot_anther_PC2_pollinators_referenced <-ggplot(pcs_anther_no_NA, aes(x=pollinator_referenced,y=PC2, fill=pollinator_referenced,color=pollinator_referenced)) 
boxplot_anther_PC2_pollinators_referenced <- boxplot_anther_PC2_pollinators_referenced + geom_boxplot(alpha=0.5,outlier.shape=NA)   
boxplot_anther_PC2_pollinators_referenced <- boxplot_anther_PC2_pollinators_referenced + 
  scale_fill_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") + scale_color_manual(values=c("orange","magenta","red","green","blue","black","gold","aquamarine"),guide="none") 

boxplot_anther_PC2_pollinators_referenced <- boxplot_anther_PC2_pollinators_referenced + guides(fill=FALSE) + theme_bw() +
  geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 

boxplot_anther_PC2_pollinators_referenced <- boxplot_anther_PC2_pollinators_referenced  + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("honeyeater" = "Honeyeater", "hummingbird" = "Hummingbird","hummingbird_OW" = "Hummingbird OW", "insect" = "Bee",
                                                                                                                                                                                                                                     "lepidoptera"="Lepidoptera","long_proboscid_fly"="Long proboscid fly", 
                                                                                                                                                                                                                                     "sunbird"="Sunbird","wind"="Wind")) + ylab("Anther PC2")

#boxplot_anther_PC2_pollinators_referenced

#

#sortedData_length_anther_noNA_pgls$pollinator_referenced = #relevel(as.factor(sortedData_length_anther_noNA_pgls$pollinator_referenced), "honeyeater")

sortedData_length_anther_noNA_pgls$pollinator_referenced <- factor(sortedData_length_anther_noNA_pgls$pollinator_referenced, 
                                                                   levels=c("honeyeater", "hummingbird", "hummingbird_OW","sunbird",
                                                                            "insect","lepidoptera","wind"))

boxplot_anther_length_pollinators_referenced <-ggplot(sortedData_length_anther_noNA_pgls, aes(x=pollinator_referenced,y=total_large_anther_length, fill=pollinator_referenced,color=pollinator_referenced)) 
boxplot_anther_length_pollinators_referenced <- boxplot_anther_length_pollinators_referenced + geom_boxplot(alpha=0.5,outlier.shape=NA)   
boxplot_anther_length_pollinators_referenced <- boxplot_anther_length_pollinators_referenced + 
  scale_fill_manual(values=c("orange","magenta","red","green","blue","black","aquamarine"),guide="none") + scale_color_manual(values=c("orange","magenta","red","green","blue","black","aquamarine"),guide="none") 

boxplot_anther_length_pollinators_referenced <- boxplot_anther_length_pollinators_referenced + guides(fill=FALSE) + theme_bw() +
  geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 

boxplot_anther_length_pollinators_referenced <- boxplot_anther_length_pollinators_referenced  + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("honeyeater" = "Honeyeater", "hummingbird" = "Hummingbird","hummingbird_OW" = "Hummingbird OW", "insect" = "Bee",
                                                                                                                                                                                                                                     "lepidoptera"="Lepidoptera", 
                                                                                                                                                                                                                                     "sunbird"="Sunbird","wind"="Wind")) + ylab("Anther length (mm)")

#boxplot_anther_length_pollinators_referenced

boxplot_log_anther_length_pollinators_referenced <-ggplot(sortedData_length_anther_noNA_pgls,aes(x=pollinator_referenced,y=log_total_large_anther_length, fill=pollinator_referenced,color=pollinator_referenced)) 
boxplot_log_anther_length_pollinators_referenced <- boxplot_log_anther_length_pollinators_referenced + geom_boxplot(alpha=0.5,outlier.shape=NA)   
boxplot_log_anther_length_pollinators_referenced <- boxplot_log_anther_length_pollinators_referenced + 
  scale_fill_manual(values=c("orange","magenta","red","green","blue","black","aquamarine"),guide="none") + scale_color_manual(values=c("orange","magenta","red","green","blue","black","aquamarine"),guide="none") 

boxplot_log_anther_length_pollinators_referenced <- boxplot_log_anther_length_pollinators_referenced + guides(fill=FALSE) + theme_bw() +
  geom_point(size = 2, shape = 16, position = position_jitterdodge(), alpha=0.25) 

boxplot_log_anther_length_pollinators_referenced <- boxplot_log_anther_length_pollinators_referenced  + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size=10),axis.title.x=element_blank(),axis.title.y = element_text( size=10),axis.text.y = element_text(size = 7),axis.ticks.x=element_blank()) + scale_x_discrete(labels=c("honeyeater" = "Honeyeater", "hummingbird" = "Hummingbird","hummingbird_OW" = "Hummingbird OW", "insect" = "Bee","lepidoptera"="Lepidoptera","sunbird"="Sunbird","wind"="Wind")) + ylab("Anther length (log)")

#boxplot_log_anther_length_pollinators_referenced
```



```{r, label="pgls anther pollinator_referenced",eval=T, fig.height=8, fig.width=8, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
### PGLS pollinator_referenced-PC1

sortedData_shape_anther_noNA_pgls$pollinator_referenced <- factor(sortedData_shape_anther_noNA_pgls$pollinator_referenced,levels=c("hummingbird","insect","honeyeater","hummingbird_OW",
                              "lepidoptera","long_proboscid_fly","sunbird","wind"))


pglsModel <- gls(PC1_anthers~ pollinator_referenced,correlation = corBrownian(phy=comptree_shape_anther_noNA_pgls),  data = sortedData_shape_anther_noNA_pgls)
pglsModel_lambda <- gls(PC1_anthers ~ pollinator_referenced,  correlation = corPagel(1,phy=comptree_shape_anther_noNA_pgls), data = sortedData_shape_anther_noNA_pgls)
pglsModel_OU <- gls(PC1_anthers ~ pollinator_referenced,  correlation = corMartins(1,phy=comptree_shape_anther_noNA_pgls), data = sortedData_shape_anther_noNA_pgls)
#anova(pglsModel,pglsModel_lambda,pglsModel_OU)   
#anova(pglsModel_lambda)
#kable(summary(pglsModel_lambda)$tTable, digits = 3, caption="PGLS anther shape PC1 and pollinator_referenced")    
pgls_res_pollinator_anther_PC1 <- summary(pglsModel_lambda)$tTable 
pgls_res_pollinator_anther_PC1 <- cbind(data.frame(c("anther PC1"),c("Intercept: Hummingbird","Bee","Honeyeater","Hummingbird OW","Lepidoptera","Long proboscid fly","Sunbird","Wind")),pgls_res_pollinator_anther_PC1)
colnames(pgls_res_pollinator_anther_PC1)[c(1:2)] <- c("trait","group") 
rownames(pgls_res_pollinator_anther_PC1) <- NULL
pgls_res_pollinator_anther_PC1$`p-value` <- p.adjust(pgls_res_pollinator_anther_PC1$`p-value`)
r2 <- R2(pglsModel_lambda)[2]
pgls_res_pollinator_anther_PC1 <- cbind(pgls_res_pollinator_anther_PC1,r2)
pgls_res_pollinator_anther_PC1$N <- sortedData_shape_anther_noNA_pgls$pollinator_referenced %>% table() 
pgls_res_pollinator_referenced_anther_PC1 <- pgls_res_pollinator_anther_PC1[c(1:2,8,3:7)]

### PGLS pollinator_referenced-PC2

pglsModel <- gls(PC2_anthers~ pollinator_referenced,correlation = corBrownian(phy=comptree_shape_anther_noNA_pgls),  data = sortedData_shape_anther_noNA_pgls)
pglsModel_lambda <- gls(PC2_anthers ~ pollinator_referenced,  correlation = corPagel(1,phy=comptree_shape_anther_noNA_pgls), data = sortedData_shape_anther_noNA_pgls)
pglsModel_OU <- gls(PC2_anthers ~ pollinator_referenced,  correlation = corMartins(1,phy=comptree_shape_anther_noNA_pgls), data = sortedData_shape_anther_noNA_pgls)
#anova(pglsModel,pglsModel_lambda,pglsModel_OU)   
#anova(pglsModel_lambda)
#kable(summary(pglsModel_lambda)$tTable, digits = 3, caption="PGLS anther shape PC2 and pollinator_referenced")    
pgls_res_pollinator_anther_PC2 <- summary(pglsModel_lambda)$tTable 
pgls_res_pollinator_anther_PC2 <- cbind(data.frame(c("anther PC2"),c("Intercept: Hummingbird","Bee","Honeyeater","Hummingbird OW","Lepidoptera","Long proboscid fly","Sunbird","Wind")),pgls_res_pollinator_anther_PC2)
colnames(pgls_res_pollinator_anther_PC2)[c(1:2)] <- c("trait","group") 
rownames(pgls_res_pollinator_anther_PC2) <- NULL
pgls_res_pollinator_anther_PC2$`p-value` <- p.adjust(pgls_res_pollinator_anther_PC2$`p-value`)
r2 <- R2(pglsModel_lambda)[2]
pgls_res_pollinator_anther_PC2 <- cbind(pgls_res_pollinator_anther_PC2,r2)
pgls_res_pollinator_anther_PC2$N <- sortedData_shape_anther_noNA_pgls$pollinator_referenced %>% table() 
pgls_res_pollinator_referenced_anther_PC2 <- pgls_res_pollinator_anther_PC2[c(1:2,8,3:7)]

### PGLS pollinator_referenced-anther length
sortedData_length_anther_noNA_pgls$pollinator_referenced <- factor(sortedData_length_anther_noNA_pgls$pollinator_referenced,levels=c("hummingbird","insect","honeyeater","hummingbird_OW",
                              "lepidoptera","sunbird","wind"))

pglsModel <- gls(log_total_large_anther_length~ pollinator_referenced,correlation = corBrownian(phy=comptree_length_anther_noNA_pgls),  data = sortedData_length_anther_noNA_pgls)
pglsModel_lambda <- gls(log_total_large_anther_length ~ pollinator_referenced,  correlation = corPagel(1,phy=comptree_length_anther_noNA_pgls), data = sortedData_length_anther_noNA_pgls)
pglsModel_OU <- gls(log_total_large_anther_length ~ pollinator_referenced,  correlation = corMartins(1,phy=comptree_length_anther_noNA_pgls), data = sortedData_length_anther_noNA_pgls)

#anova(pglsModel,pglsModel_lambda,pglsModel_OU)   
#anova(pglsModel_lambda)
#kable(summary(pglsModel_lambda)$tTable, digits = 3, caption="PGLS anther length and pollinator_referenced")    
pgls_res_log_length_anther <- summary(pglsModel_lambda)$tTable
pgls_res_log_length_anther <- cbind(data.frame(c("log anther length"),c("Intercept: Hummingbird","Bee","Honeyeater","Hummingbird OW","Lepidoptera","Sunbird","Wind")),pgls_res_log_length_anther)
colnames(pgls_res_log_length_anther)[c(1:2)] <- c("trait","group") 
rownames(pgls_res_log_length_anther) <- NULL
pgls_res_log_length_anther$`p-value` <- p.adjust(pgls_res_log_length_anther$`p-value`)
r2 <- R2(pglsModel_lambda)[2]
pgls_res_log_length_anther <- cbind(pgls_res_log_length_anther,r2)
pgls_res_log_length_anther$N <- sortedData_length_anther_noNA_pgls$pollinator_referenced %>% table() 
pgls_res_pollinator_referenced_length_anther_log <- pgls_res_log_length_anther[c(1:2,8,3:7)]
```


```{r, label="pgls anther pollinator_referenced hummingbird OW as ref",eval=T, fig.height=8, fig.width=8, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
### PGLS pollinator_referenced-PC1
sortedData_shape_anther_noNA_pgls_hummingbird_OW_as_ref <- sortedData_shape_anther_noNA_pgls

sortedData_shape_anther_noNA_pgls_hummingbird_OW_as_ref$pollinator_referenced <- factor(sortedData_shape_anther_noNA_pgls_hummingbird_OW_as_ref$pollinator_referenced,levels=c( "hummingbird_OW","insect","honeyeater", "hummingbird","lepidoptera","long_proboscid_fly","sunbird","wind"))

pglsModel <- gls(PC1_anthers~ pollinator_referenced,correlation = corBrownian(phy=comptree_shape_anther_noNA_pgls),  data = sortedData_shape_anther_noNA_pgls_hummingbird_OW_as_ref)
pglsModel_lambda <- gls(PC1_anthers ~ pollinator_referenced,  correlation = corPagel(1,phy=comptree_shape_anther_noNA_pgls), data = sortedData_shape_anther_noNA_pgls_hummingbird_OW_as_ref)
pglsModel_OU <- gls(PC1_anthers ~ pollinator_referenced,  correlation = corMartins(1,phy=comptree_shape_anther_noNA_pgls), data = sortedData_shape_anther_noNA_pgls_hummingbird_OW_as_ref)
#anova(pglsModel,pglsModel_lambda,pglsModel_OU)   
#anova(pglsModel_lambda)
#kable(summary(pglsModel_lambda)$tTable, digits = 3, caption="PGLS anther shape PC1 and pollinator_referenced")    
pgls_res_pollinator_anther_PC1_hummingbird_OW_as_ref  <- summary(pglsModel_lambda)$tTable 
pgls_res_pollinator_anther_PC1_hummingbird_OW_as_ref <- cbind(data.frame(c("anther PC1"),c("Intercept: Hummingbird OW","Bee","Honeyeater","Hummingbird","Lepidoptera","Long proboscid fly","Sunbird","Wind")),pgls_res_pollinator_anther_PC1_hummingbird_OW_as_ref)
colnames(pgls_res_pollinator_anther_PC1_hummingbird_OW_as_ref)[c(1:2)] <- c("trait","group") 
rownames(pgls_res_pollinator_anther_PC1_hummingbird_OW_as_ref) <- NULL
pgls_res_pollinator_anther_PC1_hummingbird_OW_as_ref$`p-value` <- p.adjust(pgls_res_pollinator_anther_PC1_hummingbird_OW_as_ref$`p-value`)
r2 <- R2(pglsModel_lambda)[2]
pgls_res_pollinator_anther_PC1_hummingbird_OW_as_ref <- cbind(pgls_res_pollinator_anther_PC1_hummingbird_OW_as_ref,r2)
pgls_res_pollinator_anther_PC1_hummingbird_OW_as_ref$N <- sortedData_shape_anther_noNA_pgls_hummingbird_OW_as_ref$pollinator_referenced %>% table() 
pgls_res_pollinator_referenced_anther_PC1_hummingbird_OW_as_ref <- pgls_res_pollinator_anther_PC1_hummingbird_OW_as_ref[c(1:2,8,3:7)]

### PGLS pollinator_referenced-PC2
pglsModel <- gls(PC2_anthers~ pollinator_referenced,correlation = corBrownian(phy=comptree_shape_anther_noNA_pgls),  data = sortedData_shape_anther_noNA_pgls_hummingbird_OW_as_ref)
pglsModel_lambda <- gls(PC2_anthers ~ pollinator_referenced,  correlation = corPagel(1,phy=comptree_shape_anther_noNA_pgls), data = sortedData_shape_anther_noNA_pgls_hummingbird_OW_as_ref)
pglsModel_OU <- gls(PC2_anthers ~ pollinator_referenced,  correlation = corMartins(1,phy=comptree_shape_anther_noNA_pgls), data = sortedData_shape_anther_noNA_pgls_hummingbird_OW_as_ref)

#anova(pglsModel,pglsModel_lambda,pglsModel_OU)   
#anova(pglsModel_lambda)
#kable(summary(pglsModel_lambda)$tTable, digits = 3, caption="PGLS anther shape PC2 and pollinator_referenced")    
pgls_res_pollinator_anther_PC2_hummingbird_OW_as_ref <- summary(pglsModel_lambda)$tTable 
pgls_res_pollinator_anther_PC2_hummingbird_OW_as_ref <- cbind(data.frame(c("anther PC2"),c("Intercept: Hummingbird OW","Bee","Honeyeater","Hummingbird","Lepidoptera","Long proboscid fly","Sunbird","Wind")),pgls_res_pollinator_anther_PC2_hummingbird_OW_as_ref)
colnames(pgls_res_pollinator_anther_PC2_hummingbird_OW_as_ref)[c(1:2)] <- c("trait","group") 
rownames(pgls_res_pollinator_anther_PC2_hummingbird_OW_as_ref) <- NULL
pgls_res_pollinator_anther_PC2_hummingbird_OW_as_ref$`p-value` <- p.adjust(pgls_res_pollinator_anther_PC2_hummingbird_OW_as_ref$`p-value`)
r2 <- R2(pglsModel_lambda)[2]
pgls_res_pollinator_anther_PC2_hummingbird_OW_as_ref <- cbind(pgls_res_pollinator_anther_PC2_hummingbird_OW_as_ref,r2)
pgls_res_pollinator_anther_PC2_hummingbird_OW_as_ref$N <- sortedData_shape_anther_noNA_pgls_hummingbird_OW_as_ref$pollinator_referenced %>% table() 
pgls_res_pollinator_referenced_anther_PC2_hummingbird_OW_as_ref <- pgls_res_pollinator_anther_PC2_hummingbird_OW_as_ref[c(1:2,8,3:7)]

### PGLS pollinator_referenced-anther length

sortedData_length_anther_noNA_pgls_hummingbird_OW_as_ref <- sortedData_length_anther_noNA_pgls

sortedData_length_anther_noNA_pgls_hummingbird_OW_as_ref$pollinator_referenced <- factor(sortedData_length_anther_noNA_pgls_hummingbird_OW_as_ref$pollinator_referenced,levels=c( "hummingbird_OW","insect","honeyeater", "hummingbird","lepidoptera","sunbird","wind"))

pglsModel <- gls(log_total_large_anther_length~ pollinator_referenced,correlation = corBrownian(phy=comptree_length_anther_noNA_pgls),  data = sortedData_length_anther_noNA_pgls_hummingbird_OW_as_ref)
pglsModel_lambda <- gls(log_total_large_anther_length ~ pollinator_referenced,  correlation = corPagel(1,phy=comptree_length_anther_noNA_pgls), data = sortedData_length_anther_noNA_pgls_hummingbird_OW_as_ref)
pglsModel_OU <- gls(log_total_large_anther_length ~ pollinator_referenced,  correlation = corMartins(1,phy=comptree_length_anther_noNA_pgls), data = sortedData_length_anther_noNA_pgls_hummingbird_OW_as_ref)

#anova(pglsModel,pglsModel_lambda,pglsModel_OU)   
#anova(pglsModel_lambda)
#kable(summary(pglsModel_lambda)$tTable, digits = 3, caption="PGLS anther length and pollinator_referenced")    
pgls_res_log_length_anther_hummingbird_OW_as_ref  <- summary(pglsModel_lambda)$tTable
pgls_res_log_length_anther_hummingbird_OW_as_ref <- cbind(data.frame(c("log anther length"),c("Intercept: Hummingbird OW","Bee","Honeyeater","Hummingbird","Lepidoptera","Sunbird","Wind")),pgls_res_log_length_anther_hummingbird_OW_as_ref)
colnames(pgls_res_log_length_anther_hummingbird_OW_as_ref)[c(1:2)] <- c("trait","group") 
rownames(pgls_res_log_length_anther_hummingbird_OW_as_ref) <- NULL
pgls_res_log_length_anther_hummingbird_OW_as_ref$`p-value` <- p.adjust(pgls_res_log_length_anther_hummingbird_OW_as_ref$`p-value`)
r2 <- R2(pglsModel_lambda)[2]
pgls_res_log_length_anther_hummingbird_OW_as_ref <- cbind(pgls_res_log_length_anther_hummingbird_OW_as_ref,r2)
pgls_res_log_length_anther_hummingbird_OW_as_ref$N <- sortedData_length_anther_noNA_pgls_hummingbird_OW_as_ref$pollinator_referenced %>% table() 
pgls_res_pollinator_referenced_log_length_anther_hummingbird_OW_as_ref <- pgls_res_log_length_anther_hummingbird_OW_as_ref[c(1:2,8,3:7)]
```



\pagebreak

```{r, label="descriptive stats corolla length species in phylo", echo=FALSE, cache=FALSE, message=FALSE, warning=FALSE,fig.height=9, fig.width=6, fig.align='center'}
corolla_length_stats_in_phylo_continent <- describeBy(sortedData_length_corolla_noNA_pgls[c(12,2)],group="continent",mat=T) 
corolla_length_stats_in_phylo_continent <- corolla_length_stats_in_phylo_continent[c(7:12),]
corolla_length_stats_in_phylo_continent <- corolla_length_stats_in_phylo_continent[c(2,4:6)]
corolla_length_stats_in_phylo_continent$mean <- round(corolla_length_stats_in_phylo_continent$mean,2)
corolla_length_stats_in_phylo_continent$sd <- round(corolla_length_stats_in_phylo_continent$sd,2)
#kable(corolla_length_stats_in_phylo_continent, row.names = F, caption = "Descriptive stats corolla length")

corolla_length_stats_in_phylo_pollinator <- describeBy(sortedData_length_corolla_noNA_pgls[c(6,2)],group="pollinator_referenced",mat=T) 
corolla_length_stats_in_phylo_pollinator <- corolla_length_stats_in_phylo_pollinator[c(9:16),]
corolla_length_stats_in_phylo_pollinator <- corolla_length_stats_in_phylo_pollinator[c(2,4:6)]
corolla_length_stats_in_phylo_pollinator$mean <- round(corolla_length_stats_in_phylo_pollinator$mean,2)
corolla_length_stats_in_phylo_pollinator$sd <- round(corolla_length_stats_in_phylo_pollinator$sd,2)
corolla_length_stats_in_phylo_pollinator$group1 <- gsub("insect","bee", corolla_length_stats_in_phylo_pollinator$group1)
corolla_length_stats_in_phylo_pollinator <- corolla_length_stats_in_phylo_pollinator[order(corolla_length_stats_in_phylo_pollinator$group1),]

#kable(corolla_length_stats_in_phylo_pollinator, row.names = F, caption = "Descriptive stats corolla length")
```

```{r, label="descriptive stats anther length in phylo", echo=FALSE, cache=FALSE, message=FALSE, warning=FALSE,fig.height=9, fig.width=6, fig.align='center'}
sortedData_length_anther_noNA_pgls$continent <- droplevels(sortedData_length_anther_noNA_pgls$continent)
anther_length_stats_in_phylo_continent <- describeBy(sortedData_length_anther_noNA_pgls[c(10,2)],group="continent",mat=T) 
anther_length_stats_in_phylo_continent <- anther_length_stats_in_phylo_continent[c(7:12),]
anther_length_stats_in_phylo_continent <- anther_length_stats_in_phylo_continent[c(2,4:6)]
anther_length_stats_in_phylo_continent$mean <- round(anther_length_stats_in_phylo_continent$mean,2)
anther_length_stats_in_phylo_continent$sd <- round(anther_length_stats_in_phylo_continent$sd,2)
#kable(anther_length_stats_in_phylo_continent, row.names = F, caption = "Descriptive stats anther length")

anther_length_stats_in_phylo_pollinator <- describeBy(sortedData_length_anther_noNA_pgls[c(6,2)],group="pollinator_referenced",mat=T) 
anther_length_stats_in_phylo_pollinator <- anther_length_stats_in_phylo_pollinator[c(8:14),]
anther_length_stats_in_phylo_pollinator <- anther_length_stats_in_phylo_pollinator[c(2,4:6)]
anther_length_stats_in_phylo_pollinator$mean <- round(anther_length_stats_in_phylo_pollinator$mean,2)
anther_length_stats_in_phylo_pollinator$sd <- round(anther_length_stats_in_phylo_pollinator$sd,2)
anther_length_stats_in_phylo_pollinator$group1 <- gsub("insect","bee", anther_length_stats_in_phylo_pollinator$group1)
anther_length_stats_in_phylo_pollinator <- anther_length_stats_in_phylo_pollinator[order(anther_length_stats_in_phylo_pollinator$group1),]

#kable(anther_length_stats_in_phylo_pollinator, row.names = F, caption = "Descriptive stats anther length")
```


```{r, label="descriptive stats together spp in phylo", echo=FALSE, cache=FALSE, message=FALSE, warning=FALSE,fig.height=9, fig.width=6, fig.align='center'}
corolla_length_stats_in_phylo_continent$structure <- "corolla"
corolla_length_stats_in_phylo_continent$variable <- "continent"

corolla_length_stats_in_phylo_pollinator$structure <- "corolla"
corolla_length_stats_in_phylo_pollinator$variable <- "pollinator"

anther_length_stats_in_phylo_continent$structure <- "anther"
anther_length_stats_in_phylo_continent$variable <- "continent"

anther_length_stats_in_phylo_pollinator$structure <- "anther"
anther_length_stats_in_phylo_pollinator$variable <- "pollinator"


stats_lengths_in_phylo <- rbind(corolla_length_stats_in_phylo_continent,corolla_length_stats_in_phylo_pollinator,
                                anther_length_stats_in_phylo_continent,anther_length_stats_in_phylo_pollinator)
rownames(stats_lengths_in_phylo) <- NULL

stats_lengths_in_phylo <- stats_lengths_in_phylo[c(5:6,1:4)]
stats_lengths_in_phylo$group1 <- str_to_title(stats_lengths_in_phylo$group1) 
#write.csv(stats_lengths_in_phylo,"stats_lengths_in_phylo.csv",row.names = F)
kable(stats_lengths_in_phylo)
```


## Boxplots

Geography

```{r,label="plot boxplots by geography together log sizes", fig.height=6, fig.width=9, fig.align='center',echo=FALSE, cache=F, message=FALSE, warning=FALSE,eval=T}
plot_grid(boxplot_corolla_PC1_geography,
boxplot_corolla_PC2_geography,
boxplot_log_corolla_length_geography,
boxplot_anther_PC1_geography,
boxplot_anther_PC2_geography,
boxplot_log_anther_length_geography,
nrow=2,ncol=3,align="h")
```


\pagebreak

Pollinator

```{r,label="plot boxplots by pollinator together log sizes", fig.height=6, fig.width=9, fig.align='center',echo=FALSE, cache=F, message=FALSE, warning=FALSE,eval=T}
plot_grid(boxplot_corolla_PC1_pollinators_referenced,
boxplot_corolla_PC2_pollinators_referenced,
boxplot_log_corolla_length_pollinators_referenced,
boxplot_anther_PC1_pollinators_referenced,
boxplot_anther_PC2_pollinators_referenced,
boxplot_log_anther_length_pollinators_referenced,
nrow=2, ncol=3, align="h")
```

\pagebreak

## PGLS results
### Geography

```{r, label="pgls table by geography",eval=T, fig.height=8, fig.width=8, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}

pgls_res_corolla_geography <- rbind(pgls_res_geography_corolla_PC1,
                                    pgls_res_geography_corolla_PC2,
                                    pgls_res_continent_length_corolla_log)
                                    

pgls_res_corolla_geography[c(4:8)] <- round(pgls_res_corolla_geography[c(4:8)],3)

pgls_res_anther_geography <- rbind(pgls_res_continent_anther_PC1,
                                   pgls_res_continent_anther_PC2,
                                   pgls_res_continent_length_anther_log)
                         
pgls_res_anther_geography[c(4:8)] <- round(pgls_res_anther_geography[c(4:8)],3)

#

pgls_res_corolla_geography %>% kable(caption = "PGLS Geography and corolla traits") %>%
  row_spec(0,bold=TRUE,background = "lightgray") %>% 
  row_spec(c(1,7,13),bold=TRUE)  %>%
  row_spec(18,background = "yellow") %>% 
  kable_styling(latex_options = "HOLD_position")

pgls_res_anther_geography %>% kable(caption = "PGLS Geography and anther traits") %>%
  row_spec(0,bold=TRUE,background = "lightgray") %>% 
  row_spec(c(1,7,13),bold=TRUE)  %>%
  kable_styling(latex_options = "HOLD_position")

#write.csv(pgls_res_corolla_geography,"pgls_res_corolla_geography.csv",row.names = F)
#write.csv(pgls_res_anther_geography,"pgls_res_anther_geography.csv",row.names = F)
```

\pagebreak

### Pollinator

With hummingbird as the reference group:

```{r, label="pgls table by structure",eval=T, fig.height=8, fig.width=8, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}

pgls_res_corolla <- rbind(pgls_res_pollinator_referenced_corolla_PC1,
                          pgls_res_pollinator_referenced_corolla_PC2,
                          pgls_res_pollinator_referenced_length_corolla_log)
                                    

pgls_res_corolla[c(4:8)] <- round(pgls_res_corolla[c(4:8)],3)

pgls_res_anther <- rbind(pgls_res_pollinator_referenced_anther_PC1,
                         pgls_res_pollinator_referenced_anther_PC2,
                         pgls_res_pollinator_referenced_length_anther_log)
                         
pgls_res_anther[c(4:8)] <- round(pgls_res_anther[c(4:8)],3)

#

pgls_res_corolla %>% kable(caption = "PGLS pollinator and corolla traits") %>%
  row_spec(0,bold=TRUE,background = "lightgray") %>% 
  row_spec(c(1,9,17),bold=TRUE) %>% 
  row_spec(c(2,6:8,16,18,21,23:24),background = "yellow") %>%
  kable_styling(latex_options = "HOLD_position")

pgls_res_anther %>% kable(caption = "PGLS pollinator and anther traits") %>%
    row_spec(0,bold=TRUE,background = "lightgray") %>% 
    row_spec(c(1,9,17),bold=TRUE) %>% 
    row_spec(c(18,23),background = "yellow") %>%
   kable_styling(latex_options = "HOLD_position")

#write.csv(pgls_res_corolla,"pgls_res_corolla_pollinator.csv",row.names = F)
#write.csv(pgls_res_anther,"pgls_res_anther_pollinator.csv",row.names = F)
```


With Old World hummingbird as the reference group:

```{r, label="pgls table by structure hummingbird_OW_as_ref",eval=T, fig.height=8, fig.width=8, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}

pgls_res_corolla_hummingbird_OW_as_ref <- rbind(pgls_res_pollinator_referenced_corolla_PC1_hummingbird_OW_as_ref,
                          pgls_res_pollinator_referenced_corolla_PC2_hummingbird_OW_as_ref,
                          pgls_res_pollinator_referenced_length_corolla_log_hummingbird_OW_as_ref)


pgls_res_corolla_hummingbird_OW_as_ref[c(4:8)] <- round(pgls_res_corolla_hummingbird_OW_as_ref[c(4:8)],3)

pgls_res_anther_hummingbird_OW_as_ref <- rbind(pgls_res_pollinator_referenced_anther_PC1_hummingbird_OW_as_ref,
                         pgls_res_pollinator_referenced_anther_PC2_hummingbird_OW_as_ref,
                         pgls_res_pollinator_referenced_log_length_anther_hummingbird_OW_as_ref)

pgls_res_anther_hummingbird_OW_as_ref[c(4:8)] <- round(pgls_res_anther_hummingbird_OW_as_ref[c(4:8)],3)

#

pgls_res_corolla_hummingbird_OW_as_ref %>% kable(caption = "PGLS pollinator and corolla traits: Hummingbird OW as ref") %>%
  row_spec(0,bold=TRUE,background = "lightgray") %>% 
   row_spec(c(1,9,17),bold=TRUE) %>% 
  row_spec(c(2,8,18,24),background = "yellow") %>%
  kable_styling(latex_options = "HOLD_position")

pgls_res_anther_hummingbird_OW_as_ref %>% kable(caption = "PGLS pollinator and anther traits: Hummingbird OW as ref") %>%
    row_spec(0,bold=TRUE,background = "lightgray") %>% 
    row_spec(c(1,9,17),bold=TRUE) %>% 
    row_spec(c(18:19,23),background = "yellow") %>%
   kable_styling(latex_options = "HOLD_position")

#write.csv(pgls_res_corolla_hummingbird_OW_as_ref,"pgls_res_corolla_pollinator_hummingbird_OW_as_ref.csv",row.names = F)
#write.csv(pgls_res_anther_hummingbird_OW_as_ref,"pgls_res_anther_pollinator_hummingbird_OW_as_ref.csv",row.names = F)
```

## Supplements
### Shifts corolla shape and size 

```{r,label="shifts corolla length and shape PC1PC2 PhyloEM prep", fig.height=6, fig.width=6.5, eval=T,fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
# reduce to rows of corolla with some data
data_corolla_noNA <- sortedData_shape_corolla_noNA[complete.cases(sortedData_shape_corolla_noNA$corolla_tube_length),]
Overlap_corolla <- name.check(tree, data_corolla_noNA) 
comptree_corolla_noNA <- drop.tip(tree, Overlap_corolla$tree_not_data)
match_corolla <- match(comptree_corolla_noNA$tip.label, rownames(data_corolla_noNA))  
sortedData_corolla_noNA <- data_corolla_noNA[,][match_corolla,]

sortedData_corolla_noNA$log_corolla_tube_length <- log(sortedData_corolla_noNA$corolla_tube_length+1)

comptree_corolla_noNA <- average_tr_tips(comptree_corolla_noNA)

# tip labels for subfamilies
colors_subfamily <- character(length(sortedData_corolla_noNA$subfamily)) 
colors_subfamily[sortedData_corolla_noNA$subfamily == "Arbutoideae"] <- "gold"
colors_subfamily[sortedData_corolla_noNA$subfamily == "Cassiopoideae"] <- "black"
colors_subfamily[sortedData_corolla_noNA$subfamily == "Enkianthoideae"] <- "pink"
colors_subfamily[sortedData_corolla_noNA$subfamily == "Ericoideae"] <- "green"
colors_subfamily[sortedData_corolla_noNA$subfamily == "Harrimanelloideae"] <- "aquamarine"
colors_subfamily[sortedData_corolla_noNA$subfamily == "Monotropoideae"] <- "orange"
colors_subfamily[sortedData_corolla_noNA$subfamily == "Pyroloideae"] <- "brown"
colors_subfamily[sortedData_corolla_noNA$subfamily == "Styphelioideae"] <- "blue"
colors_subfamily[sortedData_corolla_noNA$subfamily == "Vaccinioideae"] <- "red"
colors_subfamily[sortedData_corolla_noNA$subfamily == "outgroup"] <- "black"

# tip labels for pollinators references
cols_pollinator <- character(length(sortedData_corolla_noNA$pollinator_referenced)) 
cols_pollinator[sortedData_corolla_noNA$pollinator_referenced == "-"] <- "white"
cols_pollinator[sortedData_corolla_noNA$pollinator_referenced == "honeyeater"] <- "orange"
cols_pollinator[sortedData_corolla_noNA$pollinator_referenced == "hummingbird"] <- "magenta"
cols_pollinator[sortedData_corolla_noNA$pollinator_referenced == "hummingbird_OW"] <- "red"
cols_pollinator[sortedData_corolla_noNA$pollinator_referenced == "insect"] <- "blue"
cols_pollinator[sortedData_corolla_noNA$pollinator_referenced == "lepidoptera"] <- "black"
cols_pollinator[sortedData_corolla_noNA$pollinator_referenced == "long_proboscid_fly"] <- "gold"
cols_pollinator[sortedData_corolla_noNA$pollinator_referenced == "sunbird"] <- "green"
cols_pollinator[sortedData_corolla_noNA$pollinator_referenced == "wind"] <- "aquamarine"
```

- PhylogeneticEM

```{r,label="shifts corolla length shape PC1PC2 PhyloEM", fig.height=6, fig.width=6.5, eval=T,fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
# corolla_length_and_PC1PC2_EM_ready <- t(sortedData_corolla_noNA[c(13,3,4)])
# colnames(corolla_length_and_PC1PC2_EM_ready) <- sortedData_corolla_noNA$species
# PhyloEM_corolla_length_and_PC1PC2 <- PhyloEM(phylo = comptree_corolla_noNA,
# Y_data = corolla_length_and_PC1PC2_EM_ready,
#                                          process = "scOU",
#                                          random.root = TRUE,
#                                          stationary.root = TRUE,
#                                          K_max = 10,
#                                          nbr_alpha = 4,
#                                          parallel_alpha = TRUE,
#                                          Ncores =4)
# 
# saveRDS(PhyloEM_corolla_length_and_PC1PC2,"results/PhyloEM_corolla_length_log_and_PC1PC2.rds")
PhyloEM_corolla_length_and_PC1PC2 <- readRDS("results/PhyloEM_corolla_length_log_and_PC1PC2.rds")
PhyloEM_corolla_length_and_PC1PC2_params <- params_process(PhyloEM_corolla_length_and_PC1PC2)
#PhyloEM_corolla_length_and_PC1PC2_params$shifts$edges %>% data.frame() %>% dim()
# 
# cols_edges_corolla_noNA <- character(length(comptree_corolla_noNA$edge)) 
# cols_edges_corolla_noNA[1:2072] <- "gray"
# cols_edges_corolla_noNA[397:526] <- "magenta"
# cols_edges_corolla_noNA[819:819] <- "green"
# cols_edges_corolla_noNA[870:1036] <- "purple"
# cols_edges_corolla_noNA[1021:1027] <- "orange"
# 
# cols_tips_corolla_noNA <- character(length(comptree_corolla_noNA$tip.label)) 
# cols_tips_corolla_noNA[1:519] <- "gray"
# cols_tips_corolla_noNA[136:201] <- "magenta"
# cols_tips_corolla_noNA[376:376] <- "green"
# cols_tips_corolla_noNA[429:513] <- "purple"
# cols_tips_corolla_noNA[463:466] <- "orange"
# 
# ###
# plot(PhyloEM_corolla_length_and_PC1PC2,automatic_colors=F,color_edges=cols_edges_corolla_noNA,
#      color_characters=cols_tips_corolla_noNA,root.edge=F, show.tip.label=F, label_cex=0.1, shifts_cex=0.25)

plot(PhyloEM_corolla_length_and_PC1PC2,automatic_colors=T,root.edge=F, show.tip.label=F, label_cex=0.1, shifts_cex=0.25)

tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=1.95, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.1, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.25, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.4, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.55, lwd=0, col=cols_pollinator)

tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.65, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.8, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.95, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=4.1, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=4.25, lwd=0, col=colors_subfamily)

#par(lwd = 0.1)
#nodelabels(pie = recon_yang_672_pollinator_referenced$states, piecol = c("orange","magenta","red","blue","black","gold","green","aquamarine"), cex = 0.2)
legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
  "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
  "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
  col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
  adj = 0, cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
legend(20,590, legend = c("Honeyeater","Hummingbird","Hummingbird OW","Bee","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
  col = c("orange","magenta","red","blue","black","gold","green","aquamarine"),
  adj = 0,  cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
axisPhylo(line=-2, cex.axis=0.5, mgp=c(3, -.3 , 0), tck=-0.01, lwd=0.5)
lines(x=c((branching.times(comptree_corolla_noNA)[1] - 14.5),(branching.times(comptree_corolla_noNA)[1] - 14.5)),y=c(1,900),lwd=1, col="dimgray", lty = "dashed")
```

```{r,label="shifts corolla length shape PC1PC2 PhyloEM with tips", fig.height=45, fig.width=25, eval=T,fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}

plot(PhyloEM_corolla_length_and_PC1PC2,automatic_colors=T,root.edge=F, show.tip.label=T, label_cex=0.4, shifts_cex=0.25)

tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=1.95, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.1, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.25, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.4, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.55, lwd=0, col=cols_pollinator)

tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.65, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.8, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.95, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=4.1, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=4.25, lwd=0, col=colors_subfamily)

#par(lwd = 0.1)
#nodelabels(pie = recon_yang_672_pollinator_referenced$states, piecol = c("orange","magenta","red","blue","black","gold","green","aquamarine"), cex = 0.2)
legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
  "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
  "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
  col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
  adj = 0, cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
legend(20,590, legend = c("Honeyeater","Hummingbird","Hummingbird OW","Bee","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
  col = c("orange","magenta","red","blue","black","gold","green","aquamarine"),
  adj = 0,  cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
axisPhylo(line=-2, cex.axis=0.5, mgp=c(3, -.3 , 0), tck=-0.01, lwd=0.5)
lines(x=c((branching.times(comptree_corolla_noNA)[1] - 14.5),(branching.times(comptree_corolla_noNA)[1] - 14.5)),y=c(1,900),lwd=1, col="dimgray", lty = "dashed")
```


\pagebreak

- l1ou

```{r, label="shifts corolla length shape PC1PC2 l1ou", fig.height=6, fig.width=6.5,cache=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
### estimate shifts length and PC1PC2
# corolla_size_and_shapePC1PC2_shifts_noNA <- adjust_data(comptree_corolla_noNA, sortedData_corolla_noNA[,c(13,3:4)])
# shifts_corolla_size_and_shapePC1PC2_shifts_noNA <- estimate_shift_configuration(corolla_size_and_shapePC1PC2_shifts_noNA$tree,
#                                                                                corolla_size_and_shapePC1PC2_shifts_noNA$Y, max.nShifts=50,
#                                                                                root.model="OUrandomRoot",  criterion="pBIC", nCores = 4)
# saveRDS(shifts_corolla_size_and_shapePC1PC2_shifts_noNA,"results/corolla_shifts_noNA_size_log_and_shapePC1PC2.rds")
# corolla_size_and_shapePC1PC2_shifts_noNA <- readRDS("results/corolla_shifts_noNA_size_log_and_shapePC1PC2.rds")
# ### estimate convergent shifts
# conv_corolla_size_and_shapePC1PC2_shifts_noNA <- estimate_convergent_regimes(corolla_size_and_shapePC1PC2_shifts_noNA, criterion =  "pBIC",method = "backward",fixed.alpha = FALSE, nCores = 4)
# saveRDS(conv_corolla_size_and_shapePC1PC2_shifts_noNA,"results/conv_corolla_shifts_noNA_size_log_and_shapePC1PC2.rds")
conv_corolla_size_and_shapePC1PC2_shifts_noNA <- readRDS("results/conv_corolla_shifts_noNA_size_log_and_shapePC1PC2.rds")

plot(conv_corolla_size_and_shapePC1PC2_shifts_noNA, show.tip.label=F, cex=0.2,edge.shift.ann=F,edge.ann.cex=0.5)

tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.51, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.512, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.513, lwd=0, col=cols_pollinator)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.52, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.522, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.523, lwd=0, col=colors_subfamily)
#par(lwd = 0.1)
#nodelabels(pie = recon_yang_672_pollinator_referenced$states, piecol = c("orange","magenta","blue","green"), cex = 0.3)
legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
  "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
  "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
  col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
  adj = 0, cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
legend(0.15,540, legend = c("Honeyeater","Hummingbird","Hummingbird OW","Bee","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
  col = c("orange","magenta","red","blue","black","gold","green","aquamarine"),
  adj = 0,  cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)

```


```{r, label="shifts corolla length shape PC1PC2 l1ou with tips", fig.height=45, fig.width=25,cache=FALSE, echo=FALSE, message=FALSE, warning=FALSE}

plot(conv_corolla_size_and_shapePC1PC2_shifts_noNA, show.tip.label=T, cex=0.4,edge.shift.ann=F,edge.ann.cex=0.5)

tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.51, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.512, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.513, lwd=0, col=cols_pollinator)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.52, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.522, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.523, lwd=0, col=colors_subfamily)
#par(lwd = 0.1)
#nodelabels(pie = recon_yang_672_pollinator_referenced$states, piecol = c("orange","magenta","blue","green"), cex = 0.3)
legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
  "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
  "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
  col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
  adj = 0, cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
legend(0.15,540, legend = c("Honeyeater","Hummingbird","Hummingbird OW","Bee","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
  col = c("orange","magenta","red","blue","black","gold","green","aquamarine"),
  adj = 0,  cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)

```

### Shifts anther shape and size 

```{r,label="shifts anther length and shape PC1 PhyloEM", fig.height=6, fig.width=6.5, eval=T,fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
# reduce to rows of anther with some data
# anther
all_data_lm <- all_data_anthers[complete.cases(all_data_anthers$total_large_anther_length),]
all_data_lm <- all_data_lm[complete.cases(all_data_lm$PC1_anthers),]

#all_data_lm$total_large_anther_length <- log(all_data_lm$total_large_anther_length)

Overlap_anther <- name.check(tree, all_data_lm) 
comptree_anther_noNA <- drop.tip(tree, Overlap_anther$tree_not_data)
match_anther <- match(comptree_anther_noNA$tip.label, rownames(data_anther_noNA))  
sortedData_anther_noNA <- data_anther_noNA[,][match_anther,]

sortedData_anther_noNA$log_total_large_anther_length <- log(sortedData_anther_noNA$total_large_anther_length)

comptree_anther_noNA <- average_tr_tips(comptree_anther_noNA)

### tiplabels
colors_subfamily <- character(length(sortedData_anther_noNA$subfamily)) 
colors_subfamily[sortedData_anther_noNA$subfamily == "Arbutoideae"] <- "gold"
colors_subfamily[sortedData_anther_noNA$subfamily == "Cassiopoideae"] <- "black"
colors_subfamily[sortedData_anther_noNA$subfamily == "Enkianthoideae"] <- "pink"
colors_subfamily[sortedData_anther_noNA$subfamily == "Ericoideae"] <- "green"
colors_subfamily[sortedData_anther_noNA$subfamily == "Harrimanelloideae"] <- "aquamarine"
colors_subfamily[sortedData_anther_noNA$subfamily == "Monotropoideae"] <- "orange"
colors_subfamily[sortedData_anther_noNA$subfamily == "Pyroloideae"] <- "brown"
colors_subfamily[sortedData_anther_noNA$subfamily == "Styphelioideae"] <- "blue"
colors_subfamily[sortedData_anther_noNA$subfamily == "Vaccinioideae"] <- "red"
colors_subfamily[sortedData_anther_noNA$subfamily == "outgroup"] <- "black"
# tip labels for pollinators references

cols_pollinator <- character(length(sortedData_anther_noNA$pollinator_referenced)) 
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "-"] <- "white"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "honeyeater"] <- "orange"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "hummingbird"] <- "magenta"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "hummingbird_OW"] <- "red"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "insect"] <- "blue"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "lepidoptera"] <- "black"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "long_proboscid_fly"] <- "gold"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "sunbird"] <- "green"
cols_pollinator[sortedData_anther_noNA$pollinator_referenced == "wind"] <- "aquamarine"
```

- PhylogeneticEM

```{r,label="shifts anther length and shape PC1PC2 PhyloEM", fig.height=6, fig.width=6.5, eval=T,fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
# anther_length_and_PC1PC2_EM_ready <- t(sortedData_anther_noNA[c(11,3:4)])
# colnames(anther_length_and_PC1PC2_EM_ready) <- sortedData_anther_noNA$species
# PhyloEM_anther_length_and_PC1PC2 <- PhyloEM(phylo = comptree_anther_noNA,
# Y_data = anther_length_and_PC1PC2_EM_ready,
#                                          process = "scOU",
#                                          random.root = TRUE,
#                                          stationary.root = TRUE,
#                                          K_max = 10,
#                                          nbr_alpha = 4,
#                                          parallel_alpha = TRUE,
#                                          Ncores = 4)

#saveRDS(PhyloEM_anther_length_and_PC1PC2,"results/PhyloEM_anther_length_log_and_PC1PC2.rds")
PhyloEM_anther_length_and_PC1PC2 <- readRDS("results/PhyloEM_anther_length_log_and_PC1PC2.rds")
PhyloEM_anther_length_and_PC1PC2_params <- params_process(PhyloEM_anther_length_and_PC1PC2)
#PhyloEM_anther_length_and_PC1PC2_params$shifts$edges %>% data.frame() %>% dim()

# cols_edges_anther_length_and_shape_noNA <- character(length(comptree_anther_noNA$edge)) 
# cols_edges_anther_length_and_shape_noNA[1:892] <- "gray"
# cols_edges_anther_length_and_shape_noNA[74:74] <- "magenta"
# cols_edges_anther_length_and_shape_noNA[110:110] <- "green"
# cols_edges_anther_length_and_shape_noNA[203:205] <- "aquamarine"
# cols_edges_anther_length_and_shape_noNA[218:218] <- "red"
# cols_edges_anther_length_and_shape_noNA[221:221] <- "skyblue"
# cols_edges_anther_length_and_shape_noNA[225:225] <- "orange"
# cols_edges_anther_length_and_shape_noNA[265:265] <- "brown"
# cols_edges_anther_length_and_shape_noNA[270:270] <- "forestgreen"
# cols_edges_anther_length_and_shape_noNA[446:446] <- "purple"
# 
# cols_tips_anther_length_and_shape_noNA <- character(length(comptree_anther_noNA$tip.label)) 
# cols_tips_anther_length_and_shape_noNA[1:224] <- "gray"
# cols_tips_anther_length_and_shape_noNA[25:25] <- "magenta"
# cols_tips_anther_length_and_shape_noNA[51:51] <- "green"
# cols_tips_anther_length_and_shape_noNA[112:113] <- "aquamarine"
# cols_tips_anther_length_and_shape_noNA[76:76] <- "red"
# cols_tips_anther_length_and_shape_noNA[80:80] <- "skyblue"
# cols_tips_anther_length_and_shape_noNA[81:81] <- "orange"
# cols_tips_anther_length_and_shape_noNA[90:90] <- "brown"
# cols_tips_anther_length_and_shape_noNA[89:89] <- "forestgreen"
# cols_tips_anther_length_and_shape_noNA[205:205] <- "purple"
# 
# plot(PhyloEM_anther_length_and_PC1PC2,automatic_colors=F,color_edges=cols_edges_anther_length_and_shape_noNA,
#      color_characters=cols_tips_anther_length_and_shape_noNA,root.edge=F, show.tip.label=F, shifts_cex=0.25)

plot(PhyloEM_anther_length_and_PC1PC2,automatic_colors=T,root.edge=F, show.tip.label=F, shifts_cex=0.25)

tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=1.95, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.1, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.25, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.4, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.55, lwd=0, col=cols_pollinator)

tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.65, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.8, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.95, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=4.1, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=4.25, lwd=0, col=colors_subfamily)

#par(lwd = 0.1)
#nodelabels(pie = recon_yang_672_pollinator_referenced$states, piecol = c("orange","magenta","blue","green"), cex = 0.2)
legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
                             "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
                             "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
       col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
       adj = 0, cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
legend(20,255, legend = c("Honeyeater","Hummingbird","Hummingbird OW","Bee","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
       col = c("orange","magenta","red","blue","black","gold","green","aquamarine"),
       adj = 0,  cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
axisPhylo(line=-2, cex.axis=0.5, mgp=c(3, -.3 , 0), tck=-0.01, lwd=0.5)
lines(x=c((branching.times(comptree_anther_noNA)[1] - 14.5),(branching.times(comptree_anther_noNA)[1] - 14.5)),y=c(1,900),lwd=1, col="dimgray", lty = "dashed")

```

```{r,label="shifts anther length and shape PC1PC2 PhyloEM w tips", fig.height=6, fig.width=6.5, eval=T,fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}
plot(PhyloEM_anther_length_and_PC1PC2,automatic_colors=T,root.edge=F, show.tip.label=T, shifts_cex=0.5)

tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=1.95, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.1, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.25, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.4, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=2.55, lwd=0, col=cols_pollinator)

tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.65, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.8, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=3.95, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=4.1, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=4.25, lwd=0, col=colors_subfamily)

#par(lwd = 0.1)
#nodelabels(pie = recon_yang_672_pollinator_referenced$states, piecol = c("orange","magenta","blue","green"), cex = 0.2)
legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
                             "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
                             "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
       col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
       adj = 0, cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
legend(20,255, legend = c("Honeyeater","Hummingbird","Hummingbird OW","Bee","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
       col = c("orange","magenta","red","blue","black","gold","green","aquamarine"),
       adj = 0,  cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
axisPhylo(line=-2, cex.axis=0.5, mgp=c(3, -.3 , 0), tck=-0.01, lwd=0.5)
lines(x=c((branching.times(comptree_anther_noNA)[1] - 14.5),(branching.times(comptree_anther_noNA)[1] - 14.5)),y=c(1,900),lwd=1, col="dimgray", lty = "dashed")

```

\pagebreak

- l1ou

```{r, label="shifts anther shape PC1PC2 and size data l1ou", fig.height=6, fig.width=6.5,cache=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
### estimate shifts length and PC1PC2
# anther_size_and_shapePC1PC2_shifts_noNA <- adjust_data(comptree_anther_noNA, sortedData_anther_noNA[,c(11,3:4)])
# shifts_anther_size_and_shapePC1PC2_shifts_noNA <- estimate_shift_configuration(anther_size_and_shapePC1PC2_shifts_noNA$tree, anther_size_and_shapePC1PC2_shifts_noNA$Y, max.nShifts=50, root.model="OUrandomRoot",  criterion="pBIC", nCores = 4)  
# saveRDS(shifts_anther_size_and_shapePC1PC2_shifts_noNA,"results/anther_shifts_noNA_size_log_and_shapePC1PC2.rds")
# anther_size_and_shapePC1PC2_shifts_noNA <- readRDS("results/anther_shifts_noNA_size_log_and_shapePC1PC2.rds")

### estimate convergent shifts
# conv_anther_size_and_shapePC1PC2_shifts_noNA <- estimate_convergent_regimes(anther_size_and_shapePC1PC2_shifts_noNA, criterion =  "pBIC",method = "backward",fixed.alpha = FALSE, nCores = 4)
# saveRDS(conv_anther_size_and_shapePC1PC2_shifts_noNA,"results/conv_anther_shifts_noNA_size_log_and_shapePC1PC2.rds")
conv_anther_size_and_shapePC1PC2_shifts_noNA <- readRDS("results/conv_anther_shifts_noNA_size_log_and_shapePC1PC2.rds")

plot(conv_anther_size_and_shapePC1PC2_shifts_noNA, show.tip.label=F, cex=0.2,edge.shift.ann=F,edge.ann.cex=0.5)

tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.51, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.512, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.513, lwd=0, col=cols_pollinator)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.52, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.522, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.523, lwd=0, col=colors_subfamily)
#par(lwd = 0.1)
#nodelabels(pie = recon_yang_672_pollinator_referenced$states, piecol = c("orange","magenta","red","blue","black","gold","green","aquamarine"), cex = 0.3)
legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
                             "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
                             "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
       col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
       adj = 0, cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
legend(0.15,230, legend = c("Honeyeater","Hummingbird","Hummingbird OW","Bee","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
       col = c("orange","magenta","red","blue","black","gold","green","aquamarine"),
       adj = 0,  cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
```


```{r, label="shifts anther shape PC1PC2 and size data l1ou w tips", fig.height=45, fig.width=25,cache=FALSE, echo=FALSE, message=FALSE, warning=FALSE}

plot(conv_anther_size_and_shapePC1PC2_shifts_noNA, show.tip.label=T, cex=0.4,edge.shift.ann=F,edge.ann.cex=0.5)

tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.51, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.512, lwd=0, col=cols_pollinator)
tiplabels(bg=cols_pollinator, pch=22, cex=0.15, adj=0.513, lwd=0, col=cols_pollinator)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.52, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.522, lwd=0, col=colors_subfamily)
tiplabels(bg=colors_subfamily, pch=22, cex=0.15, adj=0.523, lwd=0, col=colors_subfamily)
#par(lwd = 0.1)
#nodelabels(pie = recon_yang_672_pollinator_referenced$states, piecol = c("orange","magenta","red","blue","black","gold","green","aquamarine"), cex = 0.3)
legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
                             "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
                             "Vaccinioideae"),title = "Subfamily",inset = 0, pch = c(15),
       col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
       adj = 0, cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
legend(0.15,230, legend = c("Honeyeater","Hummingbird","Hummingbird OW","Bee","Lepidoptera","Long proboscid fly","Sunbird","Wind"),title = "Pollinator",inset = 0, pch = c(15),
       col = c("orange","magenta","red","blue","black","gold","green","aquamarine"),
       adj = 0,  cex = 0.4, pt.cex = 0.5, bty="n", y.intersp = 1)
```


\pagebreak


```{r, label="shifts all vars", fig.height=6, fig.width=9,cache=FALSE, echo=FALSE, message=FALSE, warning=FALSE, eval=F}
all_spp <- rbind(sortedData_shape_corolla_noNA[c(1,6,10,12)],all_data_anthers[c(1,6,9:10)]) %>% unique()

all_spp <- left_join(all_spp,sortedData_shape_corolla_noNA[c(1:4)],"species")
all_spp <- left_join(all_spp,all_data_anthers[c(1:4)],"species")
rownames(all_spp) <- all_spp$species
Overlap <- name.check(tree, all_spp) 
comptree <- drop.tip(tree, Overlap$tree_not_data)

match_all <- match(comptree$tip.label, rownames(all_spp))  
sortedData <- all_spp[,][match_all,]

sortedData$log_total_large_anther_length <- log(sortedData$total_large_anther_length)
sortedData$log_corolla_tube_length <- log(sortedData$corolla_tube_length+1)

comptree <- average_tr_tips(comptree)
# EM_ready <- t(sortedData[c(6:7,9:10,11:12)])
# colnames(EM_ready) <- sortedData$species
# EM_all_vars <- PhyloEM(phylo = comptree,
#                       Y_data = EM_ready,
#                       process = "scOU",
#                       random.root = TRUE,
#                       stationary.root = TRUE,
#                       K_max = 10,
#                       nbr_alpha = 4,
#                       parallel_alpha = TRUE,
#                       Ncores = 4)
# 
# saveRDS(EM_all_vars,"results/PhyloEM_EM_all_vars.rds")
PhyloEM_all_vars <- readRDS("results/PhyloEM_EM_all_vars.rds")
PhyloEM_all_vars_params <- params_process(PhyloEM_all_vars)
#PhyloEM_all_vars_params$shifts$edges %>% data.frame() %>% dim()

plot(PhyloEM_all_vars,automatic_colors=T,root.edge=F, show.tip.label=F, shifts_cex=0.25)

```

\pagebreak

```{r, label="plot trees with geoscale",eval=F, fig.height=6, fig.width=6, fig.align='center', echo=FALSE, cache=FALSE, message=FALSE, warning=FALSE}
compTree_corolla_geoscalePhylo <- comptree_corolla_shape_noNA
compTree_corolla_geoscalePhylo$root.time <- round(branching.times(compTree_corolla_geoscalePhylo)[1],2)
geoscalePhylo(tree=compTree_corolla_geoscalePhylo, units="Epoch", boxes="",cex.tip=0.00001, cex.age=0.75, cex.ts=0.75, label.offset=0, x.lim=c(-15,90), lwd=5, width=1)

#lines(x=c(13.2,13.2),y=c(1,900),lwd=1.5, col="red", lty = "dashed")
#lines(x=c(8.8,8.8),y=c(1,900),lwd=1.5, col="red", lty = "dashed")

title("corolla")

compTree_anther_geoscalePhylo <- comptree_anther_shape_noNA
compTree_anther_geoscalePhylo$root.time <- round(branching.times(compTree_anther_geoscalePhylo)[1],2)
geoscalePhylo(tree=compTree_anther_geoscalePhylo, units="Epoch", boxes="",cex.tip=0.00001, cex.age=0.75, cex.ts=0.75, label.offset=0, x.lim=c(-15,90), lwd=5, width=1)

#lines(x=c(13.2,13.2),y=c(1,900),lwd=1.5, col="red", lty = "dashed")
#lines(x=c(8.8,8.8),y=c(1,900),lwd=1.5, col="red", lty = "dashed")

title("anther")
```


```{r, label="legends", eval=F,fig.height=5, fig.width=5, fig.align='center', echo=FALSE, cache=T, message=FALSE, warning=FALSE}

plot(1:10,type = "n")
legend("topleft", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
  "Ericoideae","Harrimanelloideae","Monotropoideae","Styphelioideae",
  "Vaccinioideae"),title = "",inset = 0, pch = c(16),
  col = c("gold","black","pink","green","aquamarine","orange","blue","red"),
  adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)


legend("topright", legend = c("Arbutoideae","Cassiopoideae", "Enkianthoideae",
  "Ericoideae","Harrimanelloideae","Monotropoideae","Pyroloideae","Styphelioideae",
  "Vaccinioideae"),title = "Subfamily",inset = 0, pch = 16,
  col = c("gold","black","pink","green","aquamarine","orange","brown","blue","red"),
  adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)

legend("bottomleft", legend = c("Bee","Honeyeater","Hummingbird","Hummingbird OW","Lepidoptera","Long proboscid fly","Sunbird","Unknown","Wind"),inset = 0, pch = 16,
       col = c("blue","orange","magenta","red","black","gold","green","gray","aquamarine"),
       adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)

legend("bottomright", legend = c("Africa","Asia","Australia","Europe","North America","South America"),title = "Continent",inset = 0, pch = 16,
  col = c("red","orange","purple","blue","green","forestgreen"),
  adj = 0, cex = 0.75, pt.cex = 1, bty="n", y.intersp = 1)
```

